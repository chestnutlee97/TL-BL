<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<LINK rel="Bookmark" href="/favicon.ico" >
	<LINK rel="Shortcut Icon" href="/favicon.ico" />
	<!--[if lt IE 9]>
    <script type="text/javascript" src="lib/html5.js"></script>
    <script type="text/javascript" src="lib/respond.min.js"></script>
    <script type="text/javascript" src="lib/PIE_IE678.js"></script>
    <![endif]-->
	<link rel="stylesheet" href="https://www.jq22.com/jquery/bootstrap-3.3.4.css">
	<link href="css/H-ui.css" rel="stylesheet" type="text/css" />
	<link href="css/H-ui.min.css" rel="stylesheet" type="text/css" />
	<link href="css/H-ui.admin.css" rel="stylesheet" type="text/css" />
	<link href="skin/default/skin.css" rel="stylesheet" type="text/css" id="skin" />
	<link href="lib/Hui-iconfont/1.0.1/iconfont.css" rel="stylesheet" type="text/css" />
	<link href="css/style.css" rel="stylesheet" type="text/css" />
	<link href="css/xui.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="css/gm.css"/>
	<link rel="stylesheet" href="https://www.jq22.com/jquery/font-awesome.4.7.0.css">
	<!--[if IE 6]>
    <script type="text/javascript" src="http://lib.h-ui.net/DD_belatedPNG_0.0.8a-min.js" ></script>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->

	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
	<script src="https://cdn.bootcss.com/FileSaver.js/2014-11-29/FileSaver.js"></script>
	<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript" src="lib/layer/1.9.3/layer.js"></script>
	<script type="text/javascript" src="./js/H-ui.js"></script>
	<script type="text/javascript" src="./js/H-ui.admin.js"></script>
	<script type="text/javascript" src="./js/movediv.js"></script>
	<script type="text/javascript" src="./js/three.js"></script>
	<script type="module" src="./js/three.module.js"></script>
	<script type="text/javascript" src="./js/gm.js"></script>


	<title>架空输电线路勘测设计一体化系统</title>
</head>
<body class="mainbody">
<style>
	@import url(./css/nativestyle.css);
</style>
<header class="Hui-header cl"> <a class="Hui-logo l" title="架空输电线路勘测设计一体化系统" href="#">架空输电线路勘测设计一体化系统</a>
	<nav class="mainnav cl" id="Hui-nav">
		<ul>
			<li class="dropDown dropDown_click">
				<a href="javascript:;" class="dropDown_A">
					<input type="button" style="display:inline-block" id="newprj" value="新建工程" />
					<i class="Hui-iconfont">   &#xe642;</i>
					<input type="file" style="display:inline-block" id="file" name="myfile" class="uploadfile"/>
					<input type="button" style="display:inline-block" id="upload" onclick="upfile()" value="上传" />
					<input type="button" style="display:inline-block" id="cancel" onclick="cancelUploadFile()" value="取消" />
					<input type="button" style="display:inline-block" id="filelist" onclick="getFilelist()" value="获取文件列表" />
					<select id="fileDirectory" >
						<option>请选择文件</option>
					</select>
					<button type="button" id="openBeFile" onclick="openBeFile()">打开</button>
					<button type="button" id="downloadBtn" onclick="download()">下载到本地</button>
				</a>
			</li>

		</ul>

	</nav>
	<a aria-hidden="false" class="Hui-nav-toggle" href="#"></a> </header>
<aside class="Hui-aside">
	<input runat="server" id="divScrollValue" type="hidden" value="" />
	<div class="menu_dropdown bk_2">
		<dl id="menu-newmap">
			<dt><i class="Hui-iconfont">&#xe646;</i> 工程<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="#"><label id="creatMap">新建</label></a></li>
					<li><a href="#"><label id="Openfile">打开</label></a></li>
					<li><a href="#"><label id="fileManage">文件</label></a></li>
				</ul>
			</dd>
		</dl>
		<dl id="menu-restable">
			<dt><i class="Hui-iconfont">&#xe618; </i><label id="resTable">成果表</label><i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="#"><label id="liPiletable">转角直线桩表</label></a></li>
					<li><a href="#"><label id="liTowerlisttable">杆塔排位成果表</label></a></li>
				</ul>
			</dd>
		</dl>
		<dl id="menu-parameter">
			<dt><i class="Hui-iconfont">&#xe681; </i><label id="param"> 参数</label><i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="#"><label id="designparameter">设计参数</label></a></li>
				</ul>
				<ul>
					<li><a href="#"><label id="framepara">图框参数</label></a></li>
				</ul>
				<ul>
					<li><a href="#"><label id="drawingpara">图纸参数</label></a></li>
				</ul>
			</dd>
		</dl>
		<dl id="menu-input">
			<dt><i class="Hui-iconfont">&#xe645;</i> 输入输出<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="#"><label id="inputDem">数字高程模型</label></a></li>
					<li><a href="#"><label id="inputCorner">转角杆塔投影线</label></a></li>
				</ul>
			</dd>
		</dl>
		<dl id="menu-createObject">
			<dt><i class="Hui-iconfont">&#xe645;</i> 创建<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
<!--					<li><a href="#"><label id="create_Object">创建地物</label></a></li>-->
					<li><a href="#"><label id="select_code">选择编码</label></a></li>
				</ul>
			</dd>
		</dl>
		<dl id="menu-manualrank">
			<dt><i class="Hui-iconfont">&#xe647; </i><label id="hand"> 手工排位</label><i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li id="putTower"><a href="#"><label>放置杆塔</label></a></li>
					<li id="deleteTower"><a href="#"><label>删除杆塔</label></a></li>
					<li id="moveTower"><a href="#"><label>移动杆塔</label></a></li>
					<li id="insertTower"><a href="#"><label>插入杆塔</label></a></li>
					<li id="riseTower"><a href="#"><label>升高杆塔</label></a></li>
					<li id="fallTower"><a href="#"><label>降低杆塔</label></a></li>
					<li id="editTower"><a href="#"><label>修改排杆</label></a></li>
					<li id="saveTower"><a href="#"><label>保存排杆</label></a></li>
				</ul>
			</dd>
		</dl>
		<dl id="menu-savemap">
			<dt><i class="Hui-iconfont">&#xe646; </i><label id="saveAs"> 保存</label><i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="#"><label id="saveMap">保存Map</label></a></li>
					<li><a href="#"><label id="savePrj">保存工程</label></a></li>
					<li><a href="#"><label id="saveJson">保存json</label></a></li>
				</ul>
			</dd>
		</dl>
		<dl id="menu-transOutput">
			<dt><i class="Hui-iconfont">&#xe646; </i><label id="Output"> 导出</label><i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="#"><label id="outputDXF">导出DXF</label></a></li>
					<li><a href="#"><label id="outputORG">导出ORG</label></a></li>
				</ul>
			</dd>
		</dl>
		<div style="display: none">
			<label>打开本地json文件: <input type="file" style="display:inline-block" id="jsonfile" name="myjsonfile" accept=".json"/>
				<input type="button" style="display:inline-block" id="openjsonfile" onclick="window.upjsonfile()" value="打开" /></label>
			<label>打开本地prj文件: <input type="file" style="display:inline-block" id="TLfile" name="myTLfile" accept="./PRJ"/>
				<input type="button" style="display:inline-block" id="openTLfile" onclick="window.upprjfile()" value="打开" /></label>
			<label>打开本地map文件: <input type="file" style="display:inline-block" id="TLmapfile" name="myTLmapfile" accept=".MAP"/>
				<input type="button" style="display:inline-block" id="openTLmapfile" onclick="window.upmapfile()" value="打开" /></label>
			<label>打开本地pwf文件: <input type="file" style="display:inline-block" id="TLpwffile" name="myTLpwffile" accept=".PWF"/>
				<input type="button" style="display:inline-block" id="openTLpwffile" onclick="window.uppwffile()" value="打开" /></label>
			<label>打开本地prk文件: <input type="file" style="display:inline-block" id="TLprkfile" name="myTLprkfile" accept=".PRK"/>
				<input type="button" style="display:inline-block" id="openTLprkfile" onclick="window.upprkfile()" value="打开" /></label>
		</div>
	</div>
</aside>
<!--排杆编辑-->
<!--<div class="tower_settings" id="towerset" style="display: none">-->
<!--	<h1 id="tower_settings_title">前进方向排杆</h1>-->
<!--	<form  id="towInfor">-->
<!--		<p>基本耐张段长 <input style="width: 25%;" disabled="disabled" type="text" id="naizhang" value="0" placeholder=""></p>-->
<!--		<p>前侧代表档距 <input style="width: 25%;" disabled="disabled" type="text" id="dangju" value="0" placeholder=""></p>-->
<!--		<p>导线 最大K值 <input style="width: 25%;" disabled="disabled" type="text" id="maxK" value="7.333" placeholder=""></p>-->
<!--		<p>地线 最小K值 <input style="width: 25%;" disabled="disabled" type="text" id="minK" value="7.550" placeholder=""></p>-->
<!--		<p>编号 <input style="width: 25%;" type="text" id="towId" name="towId" value="G0" placeholder=""></p>-->
<!--		<p><input name="towType" type="radio" value="" checked="checked">直线塔 <input name="towType" type="radio" value="">转角塔 <input name="towType" type="radio" value="">门架</p>-->
<!--		<p>塔型-->
<!--			<select style="width: 40%;">-->
<!--				<option value ="ZMVA41">ZMVA41</option>-->
<!--			</select>-->
<!--			高-->
<!--			<select id="towerheight">-->
<!--				<option value ="45">45</option>-->
<!--				<option value ="42">42</option>-->
<!--				<option value ="39">39</option>-->
<!--				<option value ="36">36</option>-->
<!--				<option value ="33">33</option>-->
<!--				<option value ="30">30</option>-->
<!--				<option value ="27">27</option>-->
<!--				<option value ="24">24</option>-->
<!--			</select>-->
<!--		</p>-->
<!--		<p>累距 <input style="width: 32%;" type="text" id="dis" name="dis" value="0.00" placeholder=""> 基降 <input style="width: 22%;" type="text" id="flow" name="flow" value="0.0" placeholder=""></p>-->
<!--		<p>桩位-->
<!--			<select  id="pilelist" style="width: 35%;">-->
<!--			</select>-->
<!--			差距 <input style="width: 22%;" type="text" id="gap" name="gap" value="0" placeholder="">-->
<!--		</p>-->
<!--		<p>高程 <input style="width: 35%;" type="text" id="hei" name="hei" value="0.00" placeholder="">-->
<!--		<p class="confirm">-->
<!--			<input type="button" id="saveBtn" name="saveBtn" value="保存">-->
<!--			<input type="button" id="closeBtn" name="closeBtn" value="关闭">-->
<!--		</p>-->
<!--	</form>-->
<!--</div>-->

<div class ="designParam" id="piletable" style="height: 400px;">
	<div>
		<h4 style="margin-left: 2%;" id="piletable_title">转角直线表</h4>
	</div>

	<table id="mpile_table"></table>
	<div class="line" style="outline-color: #1b1b1b;line-height: 5px;">-----</div>
	<div style="display: inline;">
		<!--		<button class="input-file" id="opentxt">文件上传</button>-->

			<button class="xbutton xround"  style="margin-left:5px;">		<input type="file" id ="tb_pile_input" accept=".txt"> </button>
			<button class="xbutton xround" id="tb_pile_calc" style="text-align-last: right">计算</button>
			<button class="xbutton xround" id="tb-pile-save" style="text-align-last: right">保存</button>
			<button class="xbutton xround close_btn" id="closeTable"style="text-align-last: right">关闭</button>

	</div>
</div>
<div class ="designParam" id="towerlisttable" style="height: 400px;">
	<div>
		<h4 style="margin-left: 2%;" id="towerlisttable_title">杆塔排位成果表</h4>
	</div>
	<table id="towerlist_table"></table>
	<div style="text-align-last:right">
		<button class="xbutton xround" id="tb-towerlist-calc" style="text-align-last: right">计算</button>
		<button class="xbutton xround close_btn" id="towerlistcloseTable"style="text-align-last: right">关闭</button>
	</div>
</div>


<!--<div id="modal-demo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">-->
<!--	<div class="modal-dialog">-->
<!--		<div class="modal-content radius">-->
<!--			<div class="modal-header">-->
<!--				<h3 class="modal-title">对话框标题</h3>-->
<!--				<a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void(0);">×</a>-->
<!--			</div>-->
<!--			<div class="modal-body">-->
<!--				<p>对话框内容…</p>-->
<!--			</div>-->
<!--			<div class="modal-footer">-->
<!--				<button class="btn btn-primary">确定</bu	tton>-->
<!--				<button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>-->
<!--			</div>-->
<!--		</div>-->
<!--	</div>-->
<!--</div>-->

<div class="designParam" id="Paramtable">
	<div class = "designParamtitle">
		<h2 id="h2title">详细设计参数</h2>
	</div>
	<div class="paramBtn" style="display:inline-block">
		<p><button class="xbutton xround" id="guicheng">规程要求设置</button></p>
		<p><button class="xbutton xround" id="daodixian">导地线参数</button></p>
		<p><button class="xbutton xround" id="qixiang">气象条件</button></p>
		<p><button class="xbutton xround" id="fenduan">分段设置</button></p>
		<p><button class="xbutton xround" id="gantashiyong">杆塔使用参数</button></p>
		<p><button class="xbutton xround" id="gantatacai">杆塔塔材基础</button></p>
		<p><button class="xbutton xround" id="jueyuancan">绝缘子串参数</button></p>
		<p><button class="xbutton xround" id="jueyuancai">绝缘子串材料</button></p>
		<p><button class="xbutton xround" id="jiedican">接地装置参数</button></p>
		<p><button class="xbutton xround" id="jiedicai">接地装置材料</button></p>
		<p><button class="xbutton xround" id="fangzhenchui">防震锤 参数</button></p>
		<p><button class="xbutton xround" id="youhua">优化排位参数</button></p>
	</div>
	<div class="outlineDiv" style="display:inline-block">
		<table id='outlineTable'></table>
	</div>
	<div class="operateBtn" style="display:inline-block">
		<p><button class="xbutton xround edit">追加</button></p>
		<p><button class="xbutton xround edit">插入</button></p>
		<p><button class="xbutton xround edit">删除</button></p>
		<p><button class="xbutton xround edit">清空</button></p>
		<p><button class="xbutton xround edit">上移</button></p>
		<p><button class="xbutton xround edit">下移</button></p>
		<p><button class="xbutton xround" id="database" action="TL_BL.html">数据库</button></p>
		<p><button class="xbutton xround" id="save">保存</button></p>
		<p><button class="xbutton xround closeBtn">关闭</button></p>
	</div>
	<div class="detailsDiv" style="display:inline-block">
		<table id='detailsTable'></table>
	</div>
</div>
<div class="dislpayArrow"><a class="pngfix" href="javascript:void(0);" onClick="displaynavbar(this)"></a></div>
<section class="Hui-article-box">
	<div id="Hui-tabNav" class="Hui-tabNav">
		<div class="Hui-tabNav-wp">
			<ul id="min_title_list" class="acrossTab cl">
				<li class="active"><span title="工作区" id="span_id"> 工作区</span><em></em></li>
			</ul>
		</div>
		<div class="Hui-tabNav-more btn-group"><a id="js-tabNav-prev" class="btn radius btn-default size-S" href="javascript:;"><i class="Hui-iconfont">&#xe6d4;</i></a><a id="js-tabNav-next" class="btn radius btn-default size-S" href="javascript:;"><i class="Hui-iconfont">&#xe6d7;</i></a></div>
	</div>
	<div id="iframe_box" class="Hui-article">
	</div>
	<footer id="footermsg" class="footer mt-20" style="z-index: 100;position: fixed;bottom: 0;height: 50px">
		<div class="container-fluid">

		</div>
	</footer>
</section>



<script type="module">
	import { CSS2DRenderer, CSS2DObject } from './js/CSS2DRenderer.js';


	//系统设置
	var prjName;//新建工程名
	var MapFileName;
	var prjNameJSON = {};
	var prk;//prk
	var data = [];
	var towerHei = 30;//塔高
	var towerHeiDif = 0;//最高塔高-最低塔高
	var towerHeiInDif = 0;//塔高间隔
	var towerHeiArray = [];//塔高数组
	var towerStartHei = 0;
	var towerEndHei = 0;
	var towerlist = [];//塔组
	var m_start,m_end;  //4.8
	var wirelist = [];//导线组
	var savedJson = {"DEM":"","GEO":"","pwf":"","prk":"","Lao":""};//保存json

	/**           部分设计参数          **/
	var voltageArr = ['110kV','220kV','330kV','500kV','直流500kV','750kV','直流800','1000kV'];
	var circuitArr = ['单回路','双回路'];
	var conductorArr = ['导线','地线','OPGW'];
	var towerArr = ['直线塔','耐张塔','终端塔','龙门架'];
	var toweraddTypeArr = ['自立塔','拉线塔'];
	var insulateArr = ['导线悬垂串','导线耐张串','导线跳线串','地线悬垂串','地线耐张串'];
	var sindouArr = ['单联','双联'];
	var dirtyareaArr = ['I级污秽区'];
	var insulateMateArr = ['','','','瓷质绝缘子'];
	var columndataLeft = [{key: 'id', text: 'NO'}, {key: 'name', text: '型号/名称/图号'}];//表头
	var columndataRight = [{key: 'name', text: '参数名称'}, {key: 'value', text: '参数数值'}];//表头

	let tpIndex;


	let mp={
		"m_Ver": "TLCAD_MAP_FILE",
		"m_VerIdent": 2008,
		"m_Volumns": "NSCCJ-",
		"m_MapName": "XXX输电线路工程",
		"m_MapSubName": "",
		"m_ObjectAttr": 0,
		"m_ObjectName": "0:中心断面",
		"m_ObjectAttrEx": 2001,
		"m_HighSystem": "1956年黄海高程系",
		"m_dScale": 2.828255100361637,
		"m_DScale": 5000.0,
		"m_HScale": 500.0,
		"m_CScale": 1000.0,
		"m_MapLength": 4225,
		"m_MapWidth": 3509,
		"m_prefixLength": 45,
		"m_suffixlength": 0,
		"m_mk": [
			{
				"From": 0.0,
				"High": 1080.0,
				"Bs": 0.0,
				"As": 0.0
			},
			{
				"From": 0.0,
				"High": 0.0,
				"Bs": 0.0,
				"As": 0.0
			},
			{
				"From": 0.0,
				"High": 0.0,
				"Bs": 0.0,
				"As": 0.0
			},
			{
				"From": 0.0,
				"High": 0.0,
				"Bs": 0.0,
				"As": 0.0
			},
			{
				"From": 0.0,
				"High": 0.0,
				"Bs": 0.0,
				"As": 0.0
			},
			{
				"From": 0.0,
				"High": 0.0,
				"Bs": 0.0,
				"As": 0.0
			},
			{
				"From": 0.0,
				"High": 0.0,
				"Bs": 0.0,
				"As": 0.0
			}
		],
		"m_markCount": 1,
		"m_From": 0.0,
		"m_To": 20900.0,
		"m_Frame": [
			40,
			45,
			50,
			55,
			60,
			65,
			70,
			80,
			90,
			95,
			100,
			110,
			130,
			155,
			170
		],
		"m_Table": 0,
		"m_TablePosition": 0,
		"m_TableType": 0,
		"m_TabHigh": 0,
		"m_StandardFrame": 0,
		"m_CircleFrame": 0,
		"m_SignFrame": 0,
		"m_ShowProfile": 1,
		"m_ShowSurveyPoint": 1,
		"m_ShowPointName": 1,
		"m_ShowPointY": 0,
		"m_showAllPoint": 0,
		"m_ShowPowerLine": 1,
		"m_showNoTower": 0,
		"m_ShowSafeLine": 0,
		"m_ShowCrossLine": 0,
		"m_ShowGPile": 0,
		"m_ShowZPile": 0,
		"m_ShowJPile": 1,
		"m_ShowTower": 1,
		"m_ShowMainGrid": 1,
		"m_ShowSubGrid": 0,
		"m_pGrid": 2,
		"m_hGrid": 2,
		"m_Grid": 20,
		"m_HZ": "仿宋_GB2312",
		"m_StartPile": "J1",
		"m_StartDistance": 0.0,
		"m_StartHigh": 100.0,
		"m_Count": 100,
		"m_Current": 1,
		"m_CurrentDesign": 0,
		"m_TurnAngle": 2,
		"m_TurnAngle2": 2,
		"m_DisplayFromX": 0.0,
		"m_DisplayFromZ": 2157.0,
		"m_DisplayToX": 1530.0,
		"m_DisplayToZ": 2297.0,
		"m_sideWidth": 15.0,
		"m_planUp": 0.0,
		"m_selSize": 6,
		"m_dynamicPlan": 0
	}
	let cross=[];
   // let cross = [
	//    {
	// 	   "Attr": 106,
	// 	   "AttrEx": 0,
	// 	   "AttrName": "0106:330kV",
	// 	   "PointCount": 3,
	// 	   "CrossPoint": [
	// 		   {
	// 			   "x": 326.7830843032056,
	// 			   "y": -43.538361467840619,
	// 			   "z": 2251.5809887038369,
	// 			   "dc": 0,
	// 			   "towerHigh": 30.0
	// 		   },
	// 		   {
	// 			   "x": 373.6705504993417,
	// 			   "y": 0.0,
	// 			   "z": 2252.7625421914005,
	// 			   "dc": 2003,
	// 			   "towerHigh": 30.0
	// 		   },
	// 		   {
	// 			   "x": 395.14559032307178,
	// 			   "y": 19.94110840774937,
	// 			   "z": 2251.271142099644,
	// 			   "dc": 0,
	// 			   "towerHigh": 30.0
	// 		   }
	// 	   ]
	//    },
	//    {
	// 	   "Attr": 104,
	// 	   "AttrEx": 0,
	// 	   "AttrName": "0104:110kV",
	// 	   "PointCount": 7,
	// 	   "CrossPoint": [
	// 		   {
	// 			   "x": 666.1540963303985,
	// 			   "y": -45.979879539978728,
	// 			   "z": 2211.423671215728,
	// 			   "dc": 0,
	// 			   "towerHigh": 35.0
	// 		   },
	// 		   {
	// 			   "x": 726.8084055107959,
	// 			   "y": 0.0,
	// 			   "z": 2208.909887539935,
	// 			   "dc": 2004,
	// 			   "towerHigh": 35.0
	// 		   },
	// 		   {
	// 			   "x": 741.8411565666788,
	// 			   "y": 11.395795155266129,
	// 			   "z": 2211.4088150534864,
	// 			   "dc": 0,
	// 			   "towerHigh": 35.0
	// 		   },
	// 		   {
	// 			   "x": 757.8664935037718,
	// 			   "y": 0.0,
	// 			   "z": 2213.9647952422594,
	// 			   "dc": 2004,
	// 			   "towerHigh": 35.0
	// 		   },
	// 		   {
	// 			   "x": 796.7753131897855,
	// 			   "y": -27.66849399894312,
	// 			   "z": 2214.6823892027648,
	// 			   "dc": 0,
	// 			   "towerHigh": 35.0
	// 		   },
	// 		   {
	// 			   "x": 841.9896814319609,
	// 			   "y": 0.0,
	// 			   "z": 2229.95568158606,
	// 			   "dc": 2004,
	// 			   "towerHigh": 35.0
	// 		   },
	// 		   {
	// 			   "x": 878.5661686064112,
	// 			   "y": 22.382626479887479,
	// 			   "z": 2247.820910094993,
	// 			   "dc": 0,
	// 			   "towerHigh": 35.0
	// 		   }
	// 	   ]
	//    },
	//    {
	// 	   "Attr": 102,
	// 	   "AttrEx": 0,
	// 	   "AttrName": "0102:10kV",
	// 	   "PointCount": 3,
	// 	   "CrossPoint": [
	// 		   {
	// 			   "x": 1101.0212446189735,
	// 			   "y": -24.16446343244864,
	// 			   "z": 2253.0898373223105,
	// 			   "dc": 0,
	// 			   "towerHigh": 0.0
	// 		   },
	// 		   {
	// 			   "x": 1133.6759249330933,
	// 			   "y": 0.0,
	// 			   "z": 2259.5080938755129,
	// 			   "dc": 2005,
	// 			   "towerHigh": 0.0
	// 		   },
	// 		   {
	// 			   "x": 1171.667022169265,
	// 			   "y": 28.113411954767146,
	// 			   "z": 2264.5759627844074,
	// 			   "dc": 0,
	// 			   "towerHigh": 0.0
	// 		   }
	// 	   ]
	//    },
	//    {
	// 	   "Attr": 105,
	// 	   "AttrEx": 0,
	// 	   "AttrName": "0105:220kV",
	// 	   "PointCount": 5,
	// 	   "CrossPoint": [
	// 		   {
	// 			   "x": 1409.5204292065308,
	// 			   "y": 14.419200174982623,
	// 			   "z": 2298.369731917085,
	// 			   "dc": 0,
	// 			   "towerHigh": 0.0
	// 		   },
	// 		   {
	// 			   "x": 1485.5817101295643,
	// 			   "y": 0.0,
	// 			   "z": 2291.1948766544239,
	// 			   "dc": 2003,
	// 			   "towerHigh": 0.0
	// 		   },
	// 		   {
	// 			   "x": 1578.0029942102329,
	// 			   "y": -17.520622574534316,
	// 			   "z": 2298.413354451002,
	// 			   "dc": 0,
	// 			   "towerHigh": 0.0
	// 		   },
	// 		   {
	// 			   "x": 1590.7452651735305,
	// 			   "y": 0.0,
	// 			   "z": 2299.878245791477,
	// 			   "dc": 2003,
	// 			   "towerHigh": 0.0
	// 		   },
	// 		   {
	// 			   "x": 1616.330781509653,
	// 			   "y": 35.18008496216865,
	// 			   "z": 2291.815442119172,
	// 			   "dc": 0,
	// 			   "towerHigh": 0.0
	// 		   }
	// 	   ]
	//    }
   // ]
// mptable init
	window.getFilelist = function (){
		var optionList = $('body').find('select');
		console.log(optionList);
		$.ajax({
			url: "http://202.114.118.138:8181/directory/" + prjName, //提交的路径
			type: "get",       //提交方式
			dataType:"json",
			success: function(data){
				console.log(data);
				for (let i = 0; i < data.length; i++) {
						var fileOption = new Option(data[i].name, i.toString());
						console.log(fileOption);
					    optionList[0].options.add(fileOption);
				}
			}
		})
		console.log(optionList);

	}

	{
	var pile_tabledata=[];
	var pile_tableId=document.getElementById("mpile_table");
	console.log(pile_tableId);
	var tb_pile=new GridManager(pile_tableId,{
		gridManagerName: 'TL-piletable',
				ajaxData: {"data":pile_tabledata},
				ajaxType: 'POST',
				//supportMenu: true,// 默认为true
							menuHandler: list => {
								list.unshift({
									content: '交换X Y',
									//line: true,
									onClick: function(){
										for(let i=0;i<pile_tabledata.length;i++)
										{
											var temp;
											temp=pile_tabledata[i].x;
											pile_tabledata[i].x=pile_tabledata[i].y;
											pile_tabledata[i].y=temp;
										}

										GridManager.refreshGrid(pile_tableId);
										console.log("exchanged data x y ");
										console.log(pile_tabledata);
									}

								});
								// list.unshift({
								// 	content:'test right click button',
								// 	//line:true,
								// 	onClick:function (){alert("test finish")}
								// });
								return list;
							},
			columnData: [
				{
					key: 'name',
					text: '杆位名称'
				},{
					key: 'dist',
					text: '累距'
				},{
					key: 'z',
					text: '高程'
				},{
					key: 'secdist',
					text: '距离'
				},{
					key: 'x',
					text: '大地x坐标'
				},{
					key: 'y',
					text: '大地y坐标'
				}
				,{
					key: 'angle',
					text: '转角'
				}
				,{
					key: 'my',
					text: '点位误差'
				}
				,{
					key: 'error',
					text: '航测断面较差'
				}
			],

		},
			function(){}
	);
	console.log(GridManager.get(pile_tableId));
	}


// towerlist table init
	{
		var towerlist_tabledata=[];
		console.log("towerlist begin data");
		console.log(towerlist_tabledata);
		console.log("tihuan data");
		towerlist_tabledata=towerlist;  //table data format different with towerlist_tabledata parameters default
		console.log(towerlist_tabledata);
		var towerlist_tableId=document.getElementById("towerlist_table");
		console.log(pile_tableId);
		var tb_towerlist=new GridManager(towerlist_tableId,{
					gridManagerName: 'TL-towerlisttable',
					ajaxData: {"data":towerlist_tabledata},
					ajaxType: 'POST',
					menuHandler: list => {
						list.unshift({
							content: '重排塔杆编号',
							//line: true,
							onClick: function(){
								var head =prompt("首字母","G");
								var fid=prompt("起始编号","0");
								for(let i=0;i<towerlist_tabledata.length;i++)
								{
									console.log(fid-"0"+i);
									towerlist_tabledata[i].Name=head.toString()+(fid-"0"+i).toString();
								}
								$("#tb-towerlist-calc").click();
								GridManager.setAjaxData(towerlist_tableId,{"data":towerlist_tabledata});
								GridManager.refreshGrid(towerlist_tableId);
								console.log("reset name");
								console.log(towerlist_tabledata);
							}

						});
						list.unshift({
							content:'删除所选塔杆',
							//line:true,
							onClick:function (){
								console.log("right button checklist");

								var del_tower=GridManager.getCheckedData(towerlist_tableId); //checkedtower need to delete former list
								console.log(del_tower);
								for(let i=0;i<del_tower.length;i++){
									for(let j=0;j<towerlist_tabledata.length;j++){
										if(del_tower[i].Name==towerlist_tabledata[j].Name){
											towerlist_tabledata.splice(j,1);
										}
									}
								}
								console.log("tabledelete",towerlist);
								console.log(towerlist_tabledata);

								let deletelist = [];
								for (let i = 0; i < scene.children.length; i++){
									if (scene.children[i].name === "fixTower"||scene.children[i].name === "fixwire1" ||scene.children[i].name === "fixwire2"||scene.children[i].name === "fixwire3"||scene.children[i].name === "fixwire4"){
										deletelist.push(scene.children[i]);
									}
								}
								for (let i = 0; i < deletelist.length; i++) {scene.remove(deletelist[i]);}
								console.log(m_end)
								m_end = towerlist_tabledata.length - 1;

								/****修改****/
								for (let i = 0; i < towerlist_tabledata.length; i++) {
									let towMesh = tower1(towerlist_tabledata[i].TowerHigh);
									towMesh.position.x = (towerlist_tabledata[i].Distance-xMin)/xdivision*Gridsize;
									towMesh.position.y = (towerlist_tabledata[i].High - yMin)/ydivision*Gridsize;
									towMesh.position.z = 0;
									towMesh.name = "fixTower";
									towMesh.geometry.name = towerlist_tabledata[i].Name;
									scene.add(towMesh);
								}
								if(m_end > 0){
									for (let i = m_start; i < m_end; i++) {
										DisplayFawCurve4(towerlist_tabledata[i],towerlist_tabledata[i+1], "fixwire");
									}
								}
								/****修改****/
								towerlist = towerlist_tabledata;
								console.log(towerlist);

								console.log("tabledata changed");
								console.log(towerlist_tabledata);
								GridManager.setAjaxData(towerlist_tableId,{"data":towerlist_tabledata});
								GridManager.refreshGrid(towerlist_tableId);
								del_tower=GridManager.setCheckedData(towerlist_tableId,[]);
							}
						});
						list.unshift({
							content:'重算杆塔位置',
							//line:true,
							onClick:function (){alert("recalc towerlist finish")} //什么情况下会重算杆塔位置
						});
						return list;
					},
					columnData: [
						{
							key: 'Name',
							text: '杆号'
						},{
							key: 'Distance',
							text: '累距'
						},{
							key: 'High',
							text: '桩位高程'
						},{
							key: 'l2',
							text: '前侧档距'
						},{
							key: 'PosOffset',  //Position and offset 组合
							text: '杆塔位置'
						},{
							key: 'TowerType',
							text: '杆型'
						}
						,{
							key: 'TowerHigh',
							text: '塔高'
						}
						,{
							key: 'Base',
							text: '降基'
						}
						,{
							key: 'Angle',
							text: '转角数'
						}
						,{
							key: 'Lh',
							text: '水平档距'
						}
						,{
							key: 'Lv',
							text: '垂直档距'
						}
						,{
							key: 'InsulatorLength',
							text: '导线串长'
						}
						,{
							key: 'LandDist',
							text: '前侧对地距离'
						}
						,{
							key: 'ElecDist',
							text: '前侧跨越距离'
						}
						,{
							key: 'Lk',
							text: '前侧代表档距'
						}
						,{
							key: 'kPline',  //kPline/1.0*1E5
							text: '前侧模板k值'
						}
						,{
							key: 'u',
							text: '前侧放松系数'
						}

					],
				},
				function(){}
		);
	}

	//pile table
	$("#piletable").draggable();
	//window resize;
	$("#piletable").hide();
	$("#liPiletable").click(function () {
		$("#piletable").show();
	})
	$("#closeTable").click(function () {
		$("#piletable").hide();
	})

	//towerlisttable
	console.log(towerlist);
	$("#towerlisttable").draggable();
	//window resize;
	$("#towerlisttable").hide();
	$("#liTowerlisttable").click(function () {
		$("#towerlisttable").show();
	})
	$("#towerlistcloseTable").click(function () {
		$("#towerlisttable").hide();
	})
	//prk设计参数框显示/隐藏
	$("#Paramtable").draggable({handle:"#h2title"});
	$("#Paramtable").hide();
	$("#designparameter").click(function () {
		$("#Paramtable").show();
	})
	$(".closeBtn").click(function () {
		$("#Paramtable").hide();
	})
	var fileObj=[];
	$("#tb_pile_input").change(function(){
		var pile_table=[];
		fileObj = this.files[0]; // js 获取文件对象
		console.log(fileObj);
		var form = new FormData(); // FormData 对象
		form.append("file", fileObj); // 文件对象
		form.append("ProjectName", prjName);//控制路径
		console.log("ProjectName",prjName);
		$.ajax({
			url: "http://202.114.118.138:8181/txtToJson", //提交的路径
			type: "post",       //提交方式
			data: form,    //提交的数据
			contentType: false, // 告诉jQuery不要去设置Content-Type请求头
			processData: false,
			success: function (res) {
				console.log(res);
				pile_tabledata =res;
				GridManager.setAjaxData(pile_tableId,{"data":pile_tabledata});
			}
		});

	})

	$("#tb_pile_calc").click(function(){
		var form = new FormData();
		form.append("ProjectName", prjName);
		console.log("begindata");
		console.log(pile_tabledata);
		form.append("table",JSON.stringify(pile_tabledata));
		//console.log(pile_table.m_jPile);   //txt append jsondata
		$.ajax({
				url: "http://202.114.118.138:8181/tbCalc", //提交的路径
				type: "post",       //提交方式
				data: form,    //提交的数据
				// dataType:"json",
				contentType: false, // 告诉jQuery不要去设置Content-Type请求头
				processData: false,
				success: function (res) {
					console.log("caculate cacu res");
					console.log(res.m_jPile);
					pile_tabledata=res.m_jPile;
					//console.log(GridManager.getAjaxData(pile_tableId));
					//need to caculate the secdist
					for(let i=0;i<pile_tabledata.length;i++)
					{
						var temp;
						temp=pile_tabledata[i].x;
						pile_tabledata[i].x=pile_tabledata[i].y;
						pile_tabledata[i].y=temp;
					}   //系统坐标大地坐标相反对换
					pile_tabledata[0].secdist=0;
					for(let i=1;i<pile_tabledata.length;i++){
						pile_tabledata[i].secdist=pile_tabledata[i].dist-pile_tabledata[i-1].dist;
					}
					GridManager.setAjaxData(pile_tableId,{"data":pile_tabledata});
				}
})})

	$("#tb-pile-save").click(function (){
		var form = new FormData();
		console.log(pile_tabledata);
		form.append("table",JSON.stringify(pile_tabledata));
		form.append("ProjectName", prjName);
		$.ajax({
			url: "http://202.114.118.138:8181/JsonTotxtfile", //提交的路径
			type: "post",       //提交方式
			data: form,    //提交的数据
			// dataType:"json",
			contentType: false, // 告诉jQuery不要去设置Content-Type请求头
			processData: false,
			success: function (res) {
				console.log(res);
			}
		})
	})

	$("#tb-towerlist-calc").click(function (){
		var form = new FormData();
		form.append("ProjectName",prjName);
		console.log("begindata");
		console.log(towerlist_tabledata);

		form.append("table",JSON.stringify(towerlist_tabledata));
		//console.log(pile_table.m_jPile);   //txt append jsondata
		$.ajax({
			url: "http://202.114.118.138:8181/tbtowerlistCalc", //提交的路径
			type: "post",       //提交方式
			data: form,    //提交的数据
			//dataType:"json",
			contentType: false, // 告诉jQuery不要去设置Content-Type请求头
			processData: false,
			success: function (res) {
				console.log("calc pwf finsh");
				console.log(res);
				towerlist_tabledata = res.TOWERLIST;
				GridManager.setAjaxData(towerlist_tableId,{"data":res.TOWERLIST});
			}
		})
	})
	//后台数据下载到本地
	$("#outputDXF").click(function(){
		var form = new FormData();
		form.append("ProjectName",prjName);
		form.append("MapFile",(MapFileName+".MAP").toString());
		form.append("PwfFile",(prjName+".PWF").toString());
		$.ajax({
			url: "http://202.114.118.138:8181/MapOutput", //提交的路径
			type: "post",       //提交方式
			data: form,    //提交的数据
			//dataType:"json",
			contentType: false,
			processData: false,
			success: function () {
				//download file
				var url = 'http://202.114.118.138:8181/Pathdownload/Project='+prjName+'&filename=' + MapFileName+".DXF";
				var xhr = new XMLHttpRequest();
				xhr.open('GET', url, true);        // 也可以使用POST方式，根据接口
				xhr.responseType = "blob";    // 返回类型blob
				// 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑
				xhr.onload = function () {
					// 请求完成
					if (this.status === 200) {
						// 返回200
						var blob = this.response;
						var reader = new FileReader();
						reader.readAsDataURL(blob);
						reader.onload = function (e) {
							// 转换完成，创建一个a标签用于下载
							console.log(e.target);
							var a = document.createElement('a');
							a.download = (MapFileName+".DXF").toString();
							a.href = e.target.result;
							$("body").append(a);    // 修复firefox中无法触发click
							a.click();
							$(a).remove();
						}
					}
				};
				// 发送ajax请求
				xhr.send()
			}
		})
	})

	$("#outputORG").click(function(){
		var form = new FormData();
		form.append("ProjectName",prjName);
		form.append("MapFile",(MapFileName+".MAP").toString());
		form.append("PwfFile",(prjName+".PWF").toString());
		$.ajax({
			url: "http://202.114.118.138:8181/MapOutput", //提交的路径
			type: "post",       //提交方式
			data: form,    //提交的数据
			//dataType:"json",
			contentType: false,
			processData: false,
			success: function () {
				//download file
				var url = 'http://202.114.118.138:8181/Pathdownload/Project='+prjName+'&filename=' + MapFileName+".ORG";
				var xhr = new XMLHttpRequest();
				xhr.open('GET', url, true);        // 也可以使用POST方式，根据接口
				xhr.responseType = "blob";    // 返回类型blob
				// 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑
				xhr.onload = function () {
					// 请求完成
					if (this.status === 200) {
						// 返回200
						var blob = this.response;
						var reader = new FileReader();
						reader.readAsDataURL(blob);
						reader.onload = function (e) {
							// 转换完成，创建一个a标签用于下载
							console.log(e.target);
							var a = document.createElement('a');
							a.download = (MapFileName+".ORG").toString();
							a.href = e.target.result;
							$("body").append(a);    // 修复firefox中无法触发click
							a.click();
							$(a).remove();
						}
					}
				};
				// 发送ajax请求
				xhr.send()
			}
		})
	})

	$("#drawingpara").click(function(){

		let drawintial = [];
		drawintial.push(mp.m_Volumns);	drawintial.push(mp.m_MapWidth);	drawintial.push(mp.m_suffixlength);
		drawintial.push(mp.m_From);	drawintial.push(mp.m_To);	drawintial.push(mp.m_To-mp.m_From);
		drawintial.push(mp.m_Grid);	drawintial.push(mp.m_pGrid);	drawintial.push(mp.m_hGrid);
		drawintial.push(mp.m_ShowMainGrid);	drawintial.push(mp.m_ShowSubGrid);	drawintial.push(mp.m_dynamicPlan);
		drawintial.push(mp.m_showNoTower);	drawintial.push(mp.m_ShowTower);	drawintial.push(mp.m_ShowCrossLine);
		drawintial.push(mp.m_ShowSafeLine);	drawintial.push(mp.m_ShowZPile);	drawintial.push(mp.m_ShowJPile);
		drawintial.push(mp.m_ShowGPile);
		drawintial.push(mp.m_DScale);	drawintial.push(mp.m_HScale);drawintial.push(mp.m_CScale);
		drawintial.push(mp.m_StandardFrame);	drawintial.push(mp.m_CircleFrame);drawintial.push(mp.m_SignFrame);
		drawintial.push(mp.m_showAllPoint);	drawintial.push(mp.m_ShowSurveyPoint);drawintial.push(mp.m_ShowPointName);drawintial.push(mp.m_ShowPointY);
		drawintial.push(mp.m_sideWidth);	drawintial.push(mp.m_HighSystem);

		layer.open({
			type:2,
			title:'图纸参数',
			area:['700px','360px'],
			maxmin:true,
			//shadeClose:true,
			content:'./drawingpara.html',
			success:function (layero,index) {
				var body = layer.getChildFrame('body',index);
				let i=0;
				body.find('input').each(function () {
					if($(this).attr("type")=="checkbox"){
							if(drawintial[i]==1){
								console.log(drawintial[i]);
								$(this).prop("checked","true");
							}
							//else $(this).prop("checked","false");
					}
					else $(this).val(drawintial[i]);
					i++;
				})
			}
		})
	})

	window.updatedrawing=function(draw_list) {
		mp.m_Volumns=draw_list[0];	mp.m_MapWidth=Number(draw_list[1]);	mp.m_suffixlength=Number(draw_list[2]);
		mp.m_From=Number(draw_list[3]);	mp.m_To=Number(draw_list[4]);	//mp.m_To-mp.m_From=draw_list[5];
		mp.m_Grid=Number(draw_list[6]);	mp.m_pGrid=Number(draw_list[7]);	mp.m_hGrid=Number(draw_list[8]);
		mp.m_ShowMainGrid=draw_list[9];	mp.m_ShowSubGrid=draw_list[10];	mp.m_dynamicPlan=draw_list[11];
		mp.m_showNoTower=draw_list[12];	mp.m_ShowTower=draw_list[13];	mp.m_ShowCrossLine=draw_list[14];
		mp.m_ShowSafeLine=draw_list[15];	mp.m_ShowZPile=draw_list[16];	mp.m_ShowJPile=draw_list[17];
		mp.m_ShowGPile=draw_list[18];
		mp.m_DScale=Number(draw_list[19]);	mp.m_HScale=Number(draw_list[20]);mp.m_CScale=Number(draw_list[21]);
		mp.m_StandardFrame=draw_list[22];	mp.m_CircleFrame=draw_list[23];mp.m_SignFrame=draw_list[24];
		mp.m_showAllPoint=draw_list[25];	mp.m_ShowSurveyPoint=draw_list[26];mp.m_ShowPointName=draw_list[27];mp.m_ShowPointY=draw_list[28];
		mp.m_sideWidth=Number(draw_list[29]);	mp.m_HighSystem=draw_list[30];
		console.log(mp);
		console.log(scene.children);
		ydivision=mp.m_HScale*mp.m_Grid/mp.m_CScale; xdivision = mp.m_DScale*mp.m_Grid/mp.m_CScale;Gridsize =mp.m_Grid;
		horSize=(mp.m_To-mp.m_From)*mp.m_CScale/(mp.m_Grid*mp.m_DScale)*Gridsize;  verSize = (mp.m_MapWidth-mp.m_Frame[14])*mp.m_HScale/(1000*ydivision)*Gridsize;
		xMin = mp.m_From;

		drawDEM_whj(DEM);
		MapCrossDraw(cross,false);  //cross added
		window.initContent();
		//drawGeo(pile_tabledata);
		console.log(scene.children);
	}

	$("#framepara").click(function(){
		layer.open({
			type:2,
			title:'图框参数',
			area:['500px','650px'],
			maxmin:true,
			content:'./framepara.html',
			success:function (layero,index) {
				console.log(layero,index);
				var body = layer.getChildFrame('body',index);
				console.log(body);
				var inputList = body.find('input');
				for (var j = 0; j < inputList.length-1; j++) {			//把父页面的数据放到子页面的input框中
					body.find(inputList[j]).val(mp.m_Frame[14-j]-mp.m_Frame[14-j-1]);
				}
				body.find(inputList[14]).val(mp.m_Frame[0]);
				body.find(inputList[15]).val(mp.m_prefixLength);
			}
		})
	})

	window.updatemp=function(mppara) {
		mp.m_prefixLength = mppara.m_prefixLength;
		mp.m_Frame = mppara.m_Frame;
		MapCrossDraw(cross,false);
	}

	$("#select_code").click(function(){

		layer.open({
			type:2,
			title:'选择地物类别',
			area:['250px','400px'],
			maxmin:true,
			content:'./selectCode.html',
			shade:0,
			success:function (layero,index) {
				console.log(layero,index);
				var body = layer.getChildFrame('body',index);
				console.log(body);
		},
			cancel: function(index, layero){

					document.removeEventListener('mousedown', window.createGroundObj);
					document.removeEventListener('mousemove', window.trackGroundObj);
					layer.close(index)

				return false;
			}
		})

	})
	// DEM断面提取layer
	var secDEM=[];
	console.log(secDEM);
	$("#inputDem").click(function (){
		//转角文件exist
		if(parent.document.getElementById('tb_pile_input').files[0]==null){alert("选择转角文件");}
		else {
			layer.open({
				type: 2,
				title: 'DEM断面提取',
				area: ['300px', '300px'],
				maxmin: true,
				content: './SectionMap.html',
				success: function (layero, index) {
					console.log(layero, index);
					var body = layer.getChildFrame('body', index);
					// body.find('input').val('Hi，我是从父页来的');
					var inputList = body.find('input');     //取得子页面中input输入框
					var dataLists = [15, 5];
					for (var j = 0; j < inputList.length; j++) {			//把父页面的数据放到子页面的input框中
						body.find(inputList[j]).val(dataLists[j]);
					}




					var optionList = body.find('select');
					console.log(optionList);
					console.log(pile_tabledata);
					for (let i = 0; i < pile_tabledata.length; i++) {
						var newOption0 = new Option(pile_tabledata[i].name, i.toString());
						var newOption1 = new Option(pile_tabledata[i].name, i.toString());
						optionList[1].options.add(newOption0);
						optionList[2].options.add(newOption1);
					}
					console.log("filecata",fileCata,fileCata.length);

					$.ajax({
						url: "http://202.114.118.138:8181/directory/" + prjName, //提交的路径
						type: "get",       //提交方式
						dataType:"json",
						success: function(data){
							console.log(data);
							for (let i = 0; i < data.length; i++) {
								var filename = data[i].name;
								var suffix = filename.substring(filename.lastIndexOf('.')+1);
								if(suffix=="EGX"||suffix=="tif"){
									var fileOption = new Option(data[i].name, i.toString());
									console.log(fileOption);
									optionList[0].options.add(fileOption);
								}
							}
						}
					})

					console.log("SectionMapOption",optionList[0]);

				},
				yes: function (index, layero) {
					console.log("yes function feedback" + layero + "" + index);

				}

			})
		}

	})

	window.GetSecDem= function(transobj){
		var formData = new FormData();
		formData.append("SectionInfo",JSON.stringify(transobj)); //transobj get from sonPage SectionMap.html
		formData.append("ProjectName", prjName);
		$.ajax({
			url: "http://202.114.118.138:8181/SectionMapSave", //提交的路径
			type: "post",       //提交方式
			data: formData,    //提交的数据
			dataType:"json",
			async: false,
			cache: false,
			contentType: false, // 告诉jQuery不要去设置Content-Type请求头
			processData: false,
			success: function (data) {
				console.log("SectionMapSave",data);
				DEM= data.DEM;
				mp = data.mp;
				cross = data.cross;
			},
			error: function (errorMsg) {
			//	alert(errorMsg);
			}
		});
		console.log("DEM,mp,cross updata",DEM,mp,cross);
		$("#drawingpara").click();
	}

	// window.GetTowerHeight= function(transobj){
	// 	console.log(transobj)
	// }

	window.download = function() {
		var text = $('#dembox option:selected').text();
		console.log(text);
		var url = 'http://202.114.118.138:8181/Pathdownload/Project='+prjName+'&filename=' + text;
		var xhr = new XMLHttpRequest();
		xhr.open('GET', url, true);        // 也可以使用POST方式，根据接口
		xhr.responseType = "blob";    // 返回类型blob
		// 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑
		xhr.onload = function () {
			// 请求完成
			if (this.status === 200) {
				// 返回200
				var blob = this.response;
				var reader = new FileReader();
				reader.readAsDataURL(blob);
				reader.onload = function (e) {
					// 转换完成，创建一个a标签用于下载
					console.log(e.target);
					var a = document.createElement('a');
					a.download = text;
					a.href = e.target.result;
					$("body").append(a);    // 修复firefox中无法触发click
					a.click();
					$(a).remove();
				}
			}
		};
		// 发送ajax请求
		xhr.send()
	}
	//新建工程
	{
	$('#newprj').click(function(){
		for (let i = 0; i < allChildren.length; i++){
			group.remove(allChildren[i]);
		}
		for (let i = 0; i < scene.children.length; i++){
			if (scene.children[i].name === "dem"||scene.children[i].name === "corner"){
				dem.push(scene.children[i]);
			}
			if (scene.children[i].name === "fixTower"||scene.children[i].name === "wire"){
				towerList.push(scene.children[i]);
			}
		}
		for (let i = 0; i < dem.length; i++) {
			scene.remove(dem[i]);
		}
		for (let i = 0; i < towerList.length; i++) {
			scene.remove(towerList[i]);
		}
		prjName = prompt("请输入新建工程名称","");
		if(prjName){
			document.getElementById('span_id').innerHTML = prjName;
			prjNameJSON = {"ProjectName":prjName};

			$.ajax({
				url: "http://202.114.118.138:8181/CreateProject", //提交的路径
				type: "post",       //提交方式
				data: prjNameJSON,    //提交的数据
				dataType:"json",
				//填充prk设计参数表格
				success: function (data) {
					console.log("createproject",data);

					let json = data.prk;
					console.log(json);
					let lao = data.Lao;
					console.log(lao);
					var laoStr = JSON.stringify(lao);
					var jsonStr = JSON.stringify(json);
					savedJson.Lao = lao;
					mp = data.Map.mp;


					$('#guicheng').click(function () {
						$('.edit').attr('disabled',true);
						$('#database').attr('disabled',true);
						$('#h2title').html($('#guicheng').html());
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":[{id:1, name: '系统设置'}, {id: 2, name: '交叉跨越'}]},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								if(checkedList[0].id === 1){
									data = [];
									console.log(json.PRIMARY);
									data = [
										{
											'name': '电压等级',
											'value':voltageArr[json.PRIMARY.voltage]
										},
										{
											'name':'设计回路',
											'value':circuitArr[json.PRIMARY.circuit - 1]
										},
										{
											'name':'导线平均高度m',
											'value':json.PRIMARY.windH
										},
										{
											'name':'地面粗糙度系数a',
											'value':json.PRIMARY.alfa
										},
										{
											'name':'地线覆盖较冰导线增加mm',
											'value':json.PRIMARY.dIce
										},
										{
											'name':'导线过牵引长度m',
											'value':json.PRIMARY.pLTract
										},
										{
											'name':'孤立档最大档距m',
											'value':json.PRIMARY.InsularMaxL
										}
									]
									document.querySelector('#detailsTable').GM({
										gridManagerName: 'details',
										supportAutoOrder: false,
										supportDrag: false,
										supportCheckbox: false,
										ajaxData: {"data":data},
										columnData: columndataRight
									});
								}
								else if (checkedList[0].id === 2){
									$('#database').attr('disabled',false);
									data = [];
									console.log(json.PRIMARY.m_standard);
									for (let i = 0; i < json.PRIMARY.m_standard.length; i++) {
										data.push({'name':json.PRIMARY.m_standard[i].info,'value':json.PRIMARY.m_standard[i].dist})
									}
									document.querySelector('#detailsTable').GM({
										gridManagerName: 'details',
										supportAutoOrder: false,
										supportDrag: false,
										supportCheckbox: false,
										ajaxData: {"data":data},
										columnData: columndataRight
									});
								}
							}
						});
					})

					$('#daodixian').click(function () {
						$('.edit').attr('disabled',false);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#daodixian').html());
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":[{id:1, name: ''}]},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								if(checkedList[0].id === 1){
									data = [];
									console.log(json.CONDUCTOR[0]);
									data = [
										{
											'name': '导地线类型',
											'value':conductorArr[json.CONDUCTOR[0].type]
										},
										{
											'name':'导地线截面积(mm^2)',
											'value':json.CONDUCTOR[0].A
										},
										{
											'name':'导地线直径(mm)',
											'value':json.CONDUCTOR[0].d
										},
										{
											'name':'计算拉断力(N)',
											'value':json.CONDUCTOR[0].Tp
										},
										{
											'name':'单位长度质量(kg/mm)',
											'value':json.CONDUCTOR[0].p1
										},
										{
											'name':'弹性系数(N/mm^2)',
											'value':json.CONDUCTOR[0].E
										},
										{
											'name':'膨胀系数x1E-6/℃',
											'value':json.CONDUCTOR[0].a
										},
										{
											'name':'导线分裂数',
											'value':json.CONDUCTOR[0].num
										}
									]
									document.querySelector('#detailsTable').GM({
										gridManagerName: 'details',
										supportAutoOrder: false,
										supportDrag: false,
										supportCheckbox: false,
										ajaxData: {"data":data},
										columnData: columndataRight
									});
								}
							}
						});
					})

					$('#qixiang').click(function () {
						$('.edit').attr('disabled',false);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#qixiang').html());
						data = [];
						for (let i = 0; i < json.WEATHER.length; i++) {
							data.push({
								'id':i+1,
								'name':json.WEATHER[i].name
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								if (checkedList[0].id === 1) {
									data = [];
									for (let j = 0; j < json.WEATHER[0].TWI.length; j++) {
										data.push({
											'name': json.WEATHER[0].TWI[j].name,
											't': json.WEATHER[0].TWI[j].t,
											'v': json.WEATHER[0].TWI[j].v,
											'b': json.WEATHER[0].TWI[j].b
										})
									}
									document.querySelector('#detailsTable').GM({
										gridManagerName: 'details',
										supportAutoOrder: false,
										supportDrag: false,
										supportCheckbox: false,
										ajaxData: {"data": data},
										columnData: [{key: 'name', text: '气象条件'}, {key: 't', text: '温度℃'}, {
											key: 'v',
											text: '风速m/s'
										}, {key: 'b', text: '覆冰(导)mm'}]
									});
								}
								else if (checkedList[0].id === 2) {
									data = [];
									for (let j = 0; j < json.WEATHER[1].TWI.length; j++) {
										data.push({
											'name':json.WEATHER[1].TWI[j].name,
											't':json.WEATHER[1].TWI[j].t,
											'v':json.WEATHER[1].TWI[j].v,
											'b':json.WEATHER[1].TWI[j].b
										})
									}
									document.querySelector('#detailsTable').GM({
										gridManagerName: 'details',
										supportAutoOrder: false,
										supportDrag: false,
										supportCheckbox: false,
										ajaxData: {"data":data},
										columnData: [{key: 'name', text: '气象条件'}, {key: 't', text: '温度℃'},{key: 'v', text: '风速m/s'}, {key: 'b', text: '覆冰(导)mm'}]
									});
								}
							}
						});
					})

					$('#fenduan').click(function () {
						$('.edit').attr('disabled',false);
						$('#database').attr('disabled',true);
						$('#h2title').html($('#fenduan').html());
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":[{id:1, name: json.SECTION[0].name}]},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								if(checkedList[0].id === 1){
									data = [];
									console.log(json.SECTION[0]);
									data = [
										{
											'name': '起始桩号',
											'value':json.SECTION[0].starJ
										},
										{
											'name':'起始累距',
											'value':json.SECTION[0].from
										},
										{
											'name':'终点桩号',
											'value':json.SECTION[0].endJ
										},
										{
											'name':'终点累距',
											'value':json.SECTION[0].to
										},
										{
											'name':'气象区名称',
											'value':json.SECTION[0].wertherName
										},
										{
											'name':'导线型号',
											'value':json.SECTION[0].powerLine
										},
										{
											'name':'导线新线系数',
											'value':json.SECTION[0].pLineK
										},
										{
											'name':'导线安全系数',
											'value':json.SECTION[0].pLineF
										},
										{
											'name':'导线年平运行张力上限',
											'value':json.SECTION[0].pLineC
										},
										{
											'name':'地线型号',
											'value':json.SECTION[0].groundLine
										},
										{
											'name':'地线新线系数',
											'value':json.SECTION[0].gLineK
										},
										{
											'name':'地线安全系数',
											'value':json.SECTION[0].gLineF
										},
										{
											'name':'地线年平运行张力上限',
											'value':json.SECTION[0].gLineC
										},
										{
											'name':'设计回路',
											'value':circuitArr[json.SECTION[0].circuit - 1]
										}
									]
									document.querySelector('#detailsTable').GM({
										gridManagerName: 'details',
										supportAutoOrder: false,
										supportDrag: false,
										supportCheckbox: false,
										ajaxData: {"data":data},
										columnData: columndataRight
									});
								}
							}
						});
					})

					$('#gantashiyong').click(function () {
						$('.edit').attr('disabled',false);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#gantashiyong').html());
						data = [];
						for (let i = 0; i < json.TOWER.length; i++) {
							data.push({
								'id':i+1,
								'name':json.TOWER[i].Name,
								'NO':json.TOWER[i].No
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								for (let j = 0; j < json.TOWER.length; j++) {
									if ( j === checkedList[0].NO){
										data = [];
										data = [
											{
												'name': '杆塔类型',
												'value': towerArr[json.TOWER[j].type]
											},
											{
												'name': '最大档距(m)',
												'value': json.TOWER[j].MaxL
											},
											{
												'name': '水平档距(m)',
												'value': json.TOWER[j].LH
											},
											{
												'name': '垂直档距(m)',
												'value': json.TOWER[j].LV
											},
											{
												'name': '起始呼高(m)',
												'value': json.TOWER[j].StartHigh
											},
											{
												'name':'级差增量(m)',
												'value':json.TOWER[j].Dhigh
											},
											{
												'name': '终止呼高(m)',
												'value': json.TOWER[j].EndHigh
											},
											{
												'name': '最小转角度数(°)',
												'value': json.TOWER[j].MinAngle
											},
											{
												'name': '最大转角度数(°)',
												'value': json.TOWER[j].MaxAngle
											},
											{
												'name': '角度折算水平档距(m/°)',
												'value': json.TOWER[j].Angle2LH
											},
											{
												'name': '摇摆角kv值',
												'value': json.TOWER[j].KV
											},
											{
												'name':'大风工况摇摆角(°)',
												'value':json.TOWER[j].sway.WindA
											},
											{
												'name':'内过电压摇摆角(°)',
												'value':json.TOWER[j].sway.OperationA
											},
											{
												'name':'外过电压摇摆角(°)',
												'value':json.TOWER[j].sway.AtomosphereA
											},
											{
												'name':'带电作业摇摆角(°)',
												'value':json.TOWER[j].sway.ElecA
											},
											{
												'name': '最大横担长度(m)',
												'value': json.TOWER[j].Dist
											},
											{
												'name': '地线支架高度(m)',
												'value': json.TOWER[j].upToTop
											},
											{
												'name': '上中导线高差(m)',
												'value': json.TOWER[j].upToMid
											},
											{
												'name': '中下导线高差(m)',
												'value': json.TOWER[j].minToDown
											},
											{
												'name': '其他附加属性',
												'value': toweraddTypeArr[json.TOWER[j].typeEx - 1]
											},
											{
												'name': '最低塔正面根开(m)',
												'value': json.TOWER[j].baseLw
											},
											{
												'name': '最低塔侧面根开(m)',
												'value': json.TOWER[j].baseLl
											},
											{
												'name': '最高塔正面根开(m)',
												'value': json.TOWER[j].baseHw
											},
											{
												'name': '最高塔侧面根开(m)',
												'value': json.TOWER[j].baseHl
											},
											{
												'name': '杆塔分组号',
												'value': json.TOWER[j].Group
											}];
										document.querySelector('#detailsTable').GM({
											gridManagerName: 'details',
											supportAutoOrder: false,
											supportDrag: false,
											supportCheckbox: false,
											ajaxData: {"data": data},
											columnData: columndataRight
										});
									}
								}
							}
						});
					})

					$('#gantatacai').click(function () {
						$('.edit').attr('disabled',true);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#gantatacai').html());
						data = [];
						for (let i = 0; i < json.TOWER.length; i++) {
							data.push({
								'id':i+1,
								'name':json.TOWER[i].Name,
								'NO':json.TOWER[i].No
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								for (let j = 0; j < json.TOWER.length; j++) {
									if ( j === checkedList[0].NO){
										data = [];
										for (let k = 0; k < json.TOWER[j].price.length; k++){
											data.push({
												'name':json.TOWER[j].Name + '-' + json.TOWER[j].price[k].High,
												'Weight':json.TOWER[j].price[k].Weight,
												'BaseWight':json.TOWER[j].price[k].BaseWight,
												'BaseM':json.TOWER[j].price[k].BaseM,
												'JJ':json.TOWER[j].price[k].JJ
											})
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data": data},
												columnData: [{key: 'name', text: '杆塔名称'}, {key: 'Weight', text: '塔材(kg)'},{key: 'BaseWight', text: '基础钢材(kg)'}, {key: 'BaseM', text: '混凝土(吨)'}, {key: 'JJ', text: '串折算'}]
											});
										}

									}
								}
							}
						});
					})

					$('#jueyuancan').click(function () {
						$('.edit').attr('disabled',false);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#jueyuancan').html());
						data = [];
						for (let i = 0; i < json.INSULATE.length; i++) {
							data.push({
								'id':i+1,
								'name':json.INSULATE[i].name
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								// console.log(checkedList);
								for (let j = 0; j < json.INSULATE.length; j++) {
									if ( j === (checkedList[0].id - 1)){
										data = [];
										data = [
											{
												'name': '绝缘子串类型',
												'value': insulateArr[json.INSULATE[j].type]
											},
											{
												'name': '单联双联',
												'value': sindouArr[json.INSULATE[j].Join - 1]
											},
											{
												'name': '每联片数',
												'value': json.INSULATE[j].Num
											},
											{
												'name': '无冰串重(kg)',
												'value': json.INSULATE[j].Weight
											},
											{
												'name': '单片覆冰(kg)',
												'value': json.INSULATE[j].IceWeight
											},
											{
												'name':'等效串长(m)',
												'value':json.INSULATE[j].Length
											},
											{
												'name': '单片受风面积(m^2)',
												'value': json.INSULATE[j].area
											},
											{
												'name': '金具受风折算系数',
												'value': json.INSULATE[j].k
											},
											{
												'name': '绝缘子常年荷载安全系数',
												'value': json.INSULATE[j].avergeK
											},
											{
												'name': '绝缘子最大荷载安全系数',
												'value': json.INSULATE[j].maxK
											},
											{
												'name': '绝缘子断线工况安全系数',
												'value': json.INSULATE[j].lineBrokeK
											},
											{
												'name':'绝缘子破坏荷载(kN)',
												'value':json.INSULATE[j].Strength
											},
											{
												'name':'金具最大荷载安全系数',
												'value':json.INSULATE[j].jjmaxK
											},
											{
												'name':'金具断线工况安全系数',
												'value':json.INSULATE[j].jjlineBrokeK
											},
											{
												'name':'金具破坏荷载(kN)',
												'value':json.INSULATE[j].jjStrength
											},
											{
												'name': 'V型串夹角(°)',
												'value': json.INSULATE[j].angleV
											},
											{
												'name': '污秽区使用条件',
												'value': dirtyareaArr[json.INSULATE[j].dirtyTpye]
											},
											{
												'name': '绝缘子材料',
												'value': insulateMateArr[json.INSULATE[j].material]
											}];
										document.querySelector('#detailsTable').GM({
											gridManagerName: 'details',
											supportAutoOrder: false,
											supportDrag: false,
											supportCheckbox: false,
											ajaxData: {"data": data},
											columnData: columndataRight
										});
									}
								}
							}
						});
					})

					$('#jueyuancai').click(function () {
						$('.edit').attr('disabled',true);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#jueyuancai').html());
						data = [];
						for (let i = 0; i < json.INSULATE.length; i++) {
							data.push({
								'id':i+1,
								'name':json.INSULATE[i].name
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								for (let j = 0; j < json.INSULATE.length; j++) {
									if ( j === (checkedList[0].id - 1)){
										data = [];
										for (let k = 0; k < json.INSULATE[j].metrial.length; k++){
											data.push({
												'name':json.INSULATE[j].metrial[k].Name,
												'Type':json.INSULATE[j].metrial[k].Type,
												'Count':json.INSULATE[j].metrial[k].Count,
												'Weight':json.INSULATE[j].metrial[k].Weight,
												'about':json.INSULATE[j].metrial[k].about,
												'unit':json.INSULATE[j].metrial[k].unit
											})
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data": data},
												columnData: [{key: 'name', text: '材料名称'}, {key: 'Type', text: '材料型号'},{key: 'unit', text: '单位'},  {key: 'Weight', text: '单重'},{key: 'Count', text: '数量'}, {key: 'about', text: '备注'}]
											});
										}

									}
								}
							}
						});
					})

					$('#jiedican').click(function () {
						$('.edit').attr('disabled',false);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#jiedican').html());
						data = [];
						for (let i = 0; i < json.GCONNECT.length; i++) {
							data.push({
								'id':i+1,
								'name':json.GCONNECT[i].Type
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								// console.log(checkedList);
								for (let j = 0; j < json.GCONNECT.length; j++) {
									if ( j === (checkedList[0].id - 1)){
										data = [];
										data = [
											{
												'name': '适用塔型',
												'value': toweraddTypeArr[json.GCONNECT[j].TowerType - 1]
											},
											{
												'name': '最小大地电阻率',
												'value': json.GCONNECT[j].minResistance
											},
											{
												'name': '最大大地电阻率',
												'value': json.GCONNECT[j].maxResistance
											}];
										document.querySelector('#detailsTable').GM({
											gridManagerName: 'details',
											supportAutoOrder: false,
											supportDrag: false,
											supportCheckbox: false,
											ajaxData: {"data": data},
											columnData: columndataRight
										});
									}
								}
							}
						});
					})

					$('#jiedicai').click(function () {
						$('.edit').attr('disabled',true);
						$('#database').attr('disabled',false);
						$('#h2title').html($('#jiedicai').html());
						data = [];
						for (let i = 0; i < json.GCONNECT.length; i++) {
							data.push({
								'id':i+1,
								'name':json.GCONNECT[i].Type
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								for (let j = 0; j < json.GCONNECT.length; j++) {
									if ( j === (checkedList[0].id - 1)){
										data = [];
										for (let k = 0; k < json.GCONNECT[j].metrial.length; k++){
											data.push({
												'name':json.GCONNECT[j].metrial[k].Name,
												'Type':json.GCONNECT[j].metrial[k].Type,
												'Count':json.GCONNECT[j].metrial[k].Count,
												'Weight':json.GCONNECT[j].metrial[k].Weight,
												'about':json.GCONNECT[j].metrial[k].about,
												'unit':json.GCONNECT[j].metrial[k].unit
											})
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data": data},
												columnData: [{key: 'name', text: '材料名称'}, {key: 'Type', text: '材料型号'},{key: 'unit', text: '单位'},  {key: 'Weight', text: '单重'},{key: 'Count', text: '数量'}, {key: 'about', text: '备注'}]
											});
										}

									}
								}
							}
						});
					})

					$('#fangzhenchui').click(function () {
						$('#database').attr('disabled',true);
						$('.edit').attr('disabled',false);
						$('#h2title').html($('#fangzhenchui').html());
						data = [];
						for (let i = 0; i < json.HAMMER.length; i++) {
							data.push({
								'id':i+1,
								'name':json.HAMMER[i].Name
							})
						}
						document.querySelector('#outlineTable').GM({
							gridManagerName: 'outline',
							supportAutoOrder: false,
							supportDrag: false,
							checkboxConfig: {
								useRowCheck: true,
								useRadio: true
							},
							ajaxData: {"data":data},
							columnData: columndataLeft,
							checkedAfter: function (checkedList) {
								// console.log(checkedList);
								for (let j = 0; j < json.HAMMER.length; j++) {
									if ( j === (checkedList[0].id - 1)){
										data = [{'name':'适用导地线','value': json.HAMMER[j].lineName}];
										for (let i = 0; i < json.HAMMER[j].fRNum.length; i++) {
											data.push({
												'name':'第'+(i+1)+'组规则',
												'value':json.HAMMER[j].fRNum[i],
												'upLimit':json.HAMMER[j].upLimit[i]
											})
										}
										document.querySelector('#detailsTable').GM({
											gridManagerName: 'details',
											supportAutoOrder: false,
											supportDrag: false,
											supportCheckbox: false,
											ajaxData: {"data": data},
											columnData:  [{key: 'name', text: '参数名称'}, {key: 'value', text: '型号/数量'},{key: 'upLimit', text: '适用档距上限'}]
										});
									}
								}
							}
						});
					})

					$('#save').click(function () {
						var formData = new FormData();
						formData.append("prk",prkStr);
						formData.append("ProjectName", prjName);

						$.ajax({
							url: "http://202.114.118.138:8181/prksave", //提交的路径
							type: "post",       //提交方式
							data: formData,    //提交的数据
							// dataType:"json",
							// async: false,
							// cache: false,
							contentType: false, // 告诉jQuery不要去设置Content-Type请求头
							processData: false,
							success: function (data) {
								alert("保存成功！");
								console.log(data.data);
							},
							error: function (errorMsg) {
								alert(errorMsg);
							}
						});
					})

					var prjformData = new FormData();

					prjformData.append("prk",prkStr);
					prjformData.append("lao",laoStr);
					prjformData.append("PointFile","J1-J18.txt");
					prjformData.append("DemFile","DEM.EGX");
					prjformData.append("ProjectName", prjName);
					$('#savePrj').click(function () {
						$.ajax({
							url: "http://202.114.118.138:8181/projectsave", //提交的路径
							type: "post",       //提交方式
							data: prjformData,    //提交的数据
							// dataType:"json",
							contentType: false, // 告诉jQuery不要去设置Content-Type请求头
							processData: false,
							success: function (data) {
								console.log(data);
								alert("保存成功！");
							},
							error: function (errorMsg) {
								alert(errorMsg);
							}
						});
					})

					$('#saveMap').click(function () {

						let Map = {
							"mp":mp,
							"DEM":DEM,
							"cross":cross
						};
						var demgeoCal = {
							"ProjectName":prjName,
							"MapFileName":(MapFileName+".MAP").toString(),
							"JsonMap":JSON.stringify(Map)
						}
						console.log(Map);
						$.ajax({
							url: "http://202.114.118.138:8181/MapSaveObj", //提交的路径
							type: "post",       //提交方式
							data: demgeoCal,    //提交的数据
							//dataType:"json",
							success: function (data) {
								console.log(data);
								alert("保存成功！");
							},
							error: function (errorMsg) {
								//alert(errorMsg);
								console.log(errorMsg);
							}
						});
					})
				},
				error: function (errorMsg) {
					//alert(errorMsg);
				}
			});
		}
	})
	prk = {
		"CONDUCTOR": [{
			"name": "LGJX-400/35",
			"type": 0,
			"A": 425.24,
			"d": 26.82,
			"Tp": 103900,
			"p1": 1.349,
			"E": 65000,
			"a": 0.0000205,
			"num": 1
		},
			{
				"name": "LGJX-50/30",
				"type": 1,
				"A": 80.32,
				"d": 11.6,
				"Tp": 42620,
				"p1": 0.372,
				"E": 105000,
				"a": 0.0000153,
				"num": 1
			}],
		"WEATHER": [{
			"name": "Ⅱ",
			"num": 12,
			"h": 15.0,
			"hs": 15.0,
			"alfa": 0.16,
			"B": 0.0,
			"TWI": [{
				"name": "平均气温",
				"t": 15.0,
				"v": 0.0,
				"b": 0.0
			},
				{
					"name": "最高气温",
					"t": 40.0,
					"v": 0.0,
					"b": 0.0
				},
				{
					"name": "最低气温",
					"t": -10.0,
					"v": 0.0,
					"b": 0.0
				},
				{
					"name": "最大风速",
					"t": 10.0,
					"v": 27.0,
					"b": 0.0
				},
				{
					"name": "最大覆冰",
					"t": -5.0,
					"v": 10.0,
					"b": 5.0
				},
				{
					"name": "安装情况",
					"t": 0.0,
					"v": 10.0,
					"b": 0.0
				},
				{
					"name": "操作情况",
					"t": 15.0,
					"v": 15.0,
					"b": 0.0
				},
				{
					"name": "大气有风",
					"t": 15.0,
					"v": 10.0,
					"b": 0.0
				},
				{
					"name": "大气无风",
					"t": 15.0,
					"v": 0.0,
					"b": 0.0
				},
				{
					"name": "最高线温",
					"t": 70.0,
					"v": 0.0,
					"b": 0.0
				},
				{
					"name": "检修工况",
					"t": 0.0,
					"v": 0.0,
					"b": 0.0
				},
				{
					"name": "事故工况",
					"t": 0.0,
					"v": 0.0,
					"b": 0.0
				}]
		},
			{
				"name": "XZ-西-15mm",
				"num": 12,
				"h": 15.0,
				"hs": 15.0,
				"alfa": 0.16,
				"B": 0.0,
				"TWI": [{
					"name": "平均气温",
					"t": 15.0,
					"v": 0.0,
					"b": 0.0,
					"P1": 0.0,
					"P2": 0.0,
					"P3": 0.0,
					"P4": 0.0,
					"P5": 0.0,
					"P6": 0.0,
					"P7": 0.0,
					"Fmx": 0.0,
					"angle": 0.0
				},
					{
						"name": "最高气温",
						"t": 40.0,
						"v": 0.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "最低气温",
						"t": -15.0,
						"v": 0.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "基本风速",
						"t": -5.0,
						"v": 27.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "最大覆冰",
						"t": -5.0,
						"v": 10.0,
						"b": 15.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "安装情况",
						"t": -10.0,
						"v": 10.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "操作情况",
						"t": 15.0,
						"v": 15.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "大气有风",
						"t": 15.0,
						"v": 10.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "大气无风",
						"t": 15.0,
						"v": 0.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "最高线温",
						"t": 70.0,
						"v": 0.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "检修工况",
						"t": 0.0,
						"v": 0.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					},
					{
						"name": "事故工况",
						"t": 0.0,
						"v": 0.0,
						"b": 0.0,
						"P1": 0.0,
						"P2": 0.0,
						"P3": 0.0,
						"P4": 0.0,
						"P5": 0.0,
						"P6": 0.0,
						"P7": 0.0,
						"Fmx": 0.0,
						"angle": 0.0
					}]
			}],
		"SECTION": [{
			"name": "1",
			"starJ": "J2",
			"from": 0.0,
			"endJ": "J37(GL)",
			"to": 57641.0,
			"powerLine": "LGJX-400/35",
			"groundLine": "LGJX-50/30",
			"wertherName": "Ⅱ",
			"pLineK": 0.95,
			"pLineF": 2.500,
			"pLineC": 0.250,
			"gLineK": 1.000,
			"gLineF": 3.000,
			"gLineC": 0.250,
			"circuit": 1
		}],
		"TOWER": [{
			"No": 0,
			"Name": "ZMVA41",
			"MaxL": 700,
			"LH": 450,
			"LV": 700,
			"StartHigh": 24.0,
			"Dhigh": 3.0,
			"EndHigh": 45.0,
			"MinAngle": 0.0,
			"MaxAngle": 3.0,
			"Angle2LH": 0.0,
			"KV": 0.850,
			"Count": 8,
			"sway": {
				"TowerName": "ZMVA41",
				"Insulate": "",
				"HugePoint": 0,
				"WindA": 10.0,
				"OperationA": 20.0,
				"AtomosphereA": 20.0,
				"ElecA": 0.0,
				"WindB": 0.0,
				"OperationB": 0.0,
				"AtomosphereB": 0.0,
				"ElecB": 0.0
			},
			"Dist": 0.0,
			"upToTop": 0.0,
			"upToMid": 0.0,
			"minToDown": 0.0,
			"typeEx": 1,
			"baseLw": 0.0,
			"baseLl": 0.0,
			"baseHw": 0.0,
			"baseHl": 0.0,
			"type": 0,
			"Group": "1",
			"price": [{
				"High": 24.0,
				"Weight": 21569.0,
				"BaseWight": 0.0,
				"BaseM": 0.0,
				"JJ": 0.0
			},
				{
					"High": 27.0,
					"Weight": 22964.0,
					"BaseWight": 0.0,
					"BaseM": 0.0,
					"JJ": 0.0
				},
				{
					"High": 0.0,
					"Weight": 24358.0,
					"BaseWight": 0.0,
					"BaseM": 0.0,
					"JJ": 0.0
				},
				{
					"High": 0.0,
					"Weight": 25753.0,
					"BaseWight": 0.0,
					"BaseM": 0.0,
					"JJ": 0.0
				},
				{
					"High": 0.0,
					"Weight": 27147.0,
					"BaseWight": 0.0,
					"BaseM": 0.0,
					"JJ": 0.0
				},
				{
					"High": 0.0,
					"Weight": 28542.0,
					"BaseWight": 0.0,
					"BaseM": 0.0,
					"JJ": 0.0
				},
				{
					"High": 0.0,
					"Weight": 29936.0,
					"BaseWight": 0.0,
					"BaseM": 0.0,
					"JJ": 0.0
				},
				{
					"High": 0.0,
					"Weight": 31331.0,
					"BaseWight": 0.0,
					"BaseM": 0.0,
					"JJ": 0.0
				}
			]
		},
			{
				"No": 1,
				"Name": "ZMVA42",
				"MaxL": 900,
				"LH": 550,
				"LV": 850,
				"StartHigh": 27.0,
				"Dhigh": 3.0,
				"EndHigh": 45.0,
				"MinAngle": 0.0,
				"MaxAngle": 3.0,
				"Angle2LH": 0.0,
				"KV": 0.850,
				"Count": 7,
				"sway": {
					"TowerName": "ZMVA42",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 0.0,
				"baseLl": 0.0,
				"baseHw": 0.0,
				"baseHl": 0.0,
				"type": 0,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 22319.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 24257.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 26195.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 28133.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 30071.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 32009.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 33947.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 2,
				"Name": "ZMVA43",
				"MaxL": 1200,
				"LH": 750,
				"LV": 1100,
				"StartHigh": 27.0,
				"Dhigh": 3.0,
				"EndHigh": 57.0,
				"MinAngle": 0.0,
				"MaxAngle": 3.0,
				"Angle2LH": 0.0,
				"KV": 0.750,
				"Count": 11,
				"sway": {
					"TowerName": "ZMVA43",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 0.0,
				"baseLl": 0.0,
				"baseHw": 0.0,
				"baseHl": 0.0,
				"type": 0,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 26836.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 28439.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 30042.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 31645.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 33248.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 34852.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 36455.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 38058.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 39661.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 41264.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 42867.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 3,
				"Name": "ZMVA44",
				"MaxL": 1600,
				"LH": 950,
				"LV": 1500,
				"StartHigh": 30.0,
				"Dhigh": 3.0,
				"EndHigh": 54.0,
				"MinAngle": 0.0,
				"MaxAngle": 3.0,
				"Angle2LH": 0.0,
				"KV": 0.700,
				"Count": 9,
				"sway": {
					"TowerName": "ZMVA44",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 0.0,
				"baseLl": 0.0,
				"baseHw": 0.0,
				"baseHl": 0.0,
				"type": 0,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 29018.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 30754.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 32490.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 34226.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 35962.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 37699.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 39435.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 41171.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 42907.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 4,
				"Name": "ZMJA41",
				"MaxL": 1000,
				"LH": 450,
				"LV": 1000,
				"StartHigh": 27.0,
				"Dhigh": 3.0,
				"EndHigh": 48.0,
				"MinAngle": 0.0,
				"MaxAngle": 14.0,
				"Angle2LH": 0.0,
				"KV": 0.650,
				"Count": 8,
				"sway": {
					"TowerName": "ZMJA41",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 0.0,
				"baseLl": 0.0,
				"baseHw": 0.0,
				"baseHl": 0.0,
				"type": 0,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 32281.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 34950.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 37618.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 40287.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 42955.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 45624.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 48292.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 50961.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 7,
				"Name": "JC1",
				"MaxL": 1200,
				"LH": 450,
				"LV": 800,
				"StartHigh": 21.0,
				"Dhigh": 3.0,
				"EndHigh": 30.0,
				"MinAngle": 0.0,
				"MaxAngle": 20.0,
				"Angle2LH": 30.0,
				"KV": 0.000,
				"Count": 4,
				"sway": {
					"TowerName": "JC1",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 4.0,
				"baseLl": 4.0,
				"baseHw": 8.0,
				"baseHl": 8.0,
				"type": 1,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 45086.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 48045.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 51004.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 53963.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 8,
				"Name": "JC2",
				"MaxL": 1200,
				"LH": 450,
				"LV": 1200,
				"StartHigh": 21.0,
				"Dhigh": 3.0,
				"EndHigh": 30.0,
				"MinAngle": 20.0,
				"MaxAngle": 40.0,
				"Angle2LH": 30.0,
				"KV": 0.000,
				"Count": 4,
				"sway": {
					"TowerName": "JC2",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 4.0,
				"baseLl": 4.0,
				"baseHw": 4.0,
				"baseHl": 4.0,
				"type": 1,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 45880.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 49136.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 52392.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 55648.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 10,
				"Name": "JC3",
				"MaxL": 1200,
				"LH": 450,
				"LV": 800,
				"StartHigh": 21.0,
				"Dhigh": 3.0,
				"EndHigh": 30.0,
				"MinAngle": 40.0,
				"MaxAngle": 60.0,
				"Angle2LH": 30.0,
				"KV": 0.000,
				"Count": 4,
				"sway": {
					"TowerName": "JC3",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 4.0,
				"baseLl": 4.0,
				"baseHw": 4.0,
				"baseHl": 4.0,
				"type": 1,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 47425.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 51067.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 54709.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 58351.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 11,
				"Name": "DJC1",
				"MaxL": 800,
				"LH": 450,
				"LV": 600,
				"StartHigh": 21.0,
				"Dhigh": 3.0,
				"EndHigh": 30.0,
				"MinAngle": 60.0,
				"MaxAngle": 90.0,
				"Angle2LH": 30.0,
				"KV": 0.000,
				"Count": 4,
				"sway": {
					"TowerName": "DJC1",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 4.0,
				"baseLl": 4.0,
				"baseHw": 4.0,
				"baseHl": 4.0,
				"type": 2,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 47425.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 51067.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 54709.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					},
					{
						"High": 0.0,
						"Weight": 58351.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			},
			{
				"No": 12,
				"Name": "MJ",
				"MaxL": 0,
				"LH": 0,
				"LV": 0,
				"StartHigh": 18.0,
				"Dhigh": 3.0,
				"EndHigh": 18.0,
				"MinAngle": 0.0,
				"MaxAngle": 0.0,
				"Angle2LH": 0.0,
				"KV": 0.000,
				"Count": 1,
				"sway": {
					"TowerName": "MJ",
					"Insulate": "",
					"HugePoint": 0,
					"WindA": 0.0,
					"OperationA": 0.0,
					"AtomosphereA": 0.0,
					"ElecA": 0.0,
					"WindB": 0.0,
					"OperationB": 0.0,
					"AtomosphereB": 0.0,
					"ElecB": 0.0
				},
				"Dist": 0.0,
				"upToTop": 0.0,
				"upToMid": 0.0,
				"minToDown": 0.0,
				"typeEx": 1,
				"baseLw": 2.0,
				"baseLl": 2.0,
				"baseHw": 2.0,
				"baseHl": 2.0,
				"type": 3,
				"Group": "1",
				"price": [
					{
						"High": 0.0,
						"Weight": 0.0,
						"BaseWight": 0.0,
						"BaseM": 0.0,
						"JJ": 0.0
					}
				]
			}],
		"INSULATE": [{
			"name": "N01",
			"type": 1,
			"Join": 1,
			"Num": 18,
			"Weight": 100.0,
			"IceWeight": 120.0,
			"Length": 4.5,
			"area": 0.03,
			"k": 1.1,
			"avergeK": 4.0,
			"maxK": 2.7,
			"lineBrokeK": 2.0,
			"Strength": 100.0,
			"jjmaxK": 2.0,
			"jjlineBrokeK": 2.0,
			"jjStrength": 2.0,
			"angleV": 90.0,
			"dirtyTpye": 0,
			"material": 3,
			"metrial": [{
				"Name": "U型挂环",
				"Type": "U-1880",
				"Count": 1,
				"Weight": 0.83,
				"about": "",
				"unit": "付"
			},
				{
					"Name": "合成绝缘子",
					"Type": "FXBW-35/100G",
					"Count": 1,
					"Weight": 3.5,
					"about": "",
					"unit": "个"
				},
				{
					"Name": "并沟线夹",
					"Type": "JB-2",
					"Count": 1,
					"Weight": 0.65,
					"about": "",
					"unit": "个"
				},
				{
					"Name": "耐张线夹",
					"Type": "NLD-4",
					"Count": 1,
					"Weight": 7.1,
					"about": "",
					"unit": "个"
				}],
			"metrialNum": 4
		},
			{
				"name": "X01",
				"type": 0,
				"Join": 1,
				"Num": 1,
				"Weight": 0.0,
				"IceWeight": 3.0,
				"Length": 4.5,
				"area": 0.03,
				"k": 1.1,
				"avergeK": 4.0,
				"maxK": 2.7,
				"lineBrokeK": 1.8,
				"Strength": 0.0,
				"jjmaxK": 2.5,
				"jjlineBrokeK": 1.5,
				"jjStrength": 0.0,
				"angleV": 0.0,
				"dirtyTpye": 0,
				"material": 3,
				"metrial": [{
					"Name": "",
					"Type": "",
					"Count": "",
					"Weight": "",
					"about": "",
					"unit": ""
				}],
				"metrialNum": 0
			},
			{
				"name": "T01",
				"type": 2,
				"Join": 1,
				"Num": 1,
				"Weight": 0.0,
				"IceWeight": 3.0,
				"Length": 5.5,
				"area": 0.03,
				"k": 1.1,
				"avergeK": 4.0,
				"maxK": 2.7,
				"lineBrokeK": 1.8,
				"Strength": 0.0,
				"jjmaxK": 2.5,
				"jjlineBrokeK": 1.5,
				"jjStrength": 0.0,
				"angleV": 0.0,
				"dirtyTpye": 0,
				"material": 3,
				"metrial": [{
					"Name": "",
					"Type": "",
					"Count": "",
					"Weight": "",
					"about": "",
					"unit": ""
				}],
				"metrialNum": 0
			},
			{
				"name": "DX01",
				"type": 3,
				"Join": 1,
				"Num": 1,
				"Weight": 0.0,
				"IceWeight": 3.0,
				"Length": 5.5,
				"area": 0.03,
				"k": 1.1,
				"avergeK": 4.0,
				"maxK": 2.7,
				"lineBrokeK": 1.8,
				"Strength": 0.0,
				"jjmaxK": 2.5,
				"jjlineBrokeK": 1.5,
				"jjStrength": 0.0,
				"angleV": 0.0,
				"dirtyTpye": 0,
				"material": 3,
				"metrial": [{
					"Name": "",
					"Type": "",
					"Count": "",
					"Weight": "",
					"about": "",
					"unit": ""
				}],
				"metrialNum": 0
			},
			{
				"name": "DN01",
				"type": 4,
				"Join": 1,
				"Num": 1,
				"Weight": 0.0,
				"IceWeight": 3.0,
				"Length": 5.5,
				"area": 0.03,
				"k": 1.1,
				"avergeK": 4.0,
				"maxK": 2.7,
				"lineBrokeK": 1.8,
				"Strength": 0.0,
				"jjmaxK": 2.5,
				"jjlineBrokeK": 1.5,
				"jjStrength": 0.0,
				"angleV": 0.0,
				"dirtyTpye": 0,
				"material": 3,
				"metrial": [{
					"Name": "",
					"Type": "",
					"Count": "",
					"Weight": "",
					"about": "",
					"unit": ""
				}],
				"metrialNum": 0
			}],
		"GCONNECT": [{
			"Type": "甲",
			"minResistance": 0.0,
			"maxResistance": 100.0,
			"TowerType": 1,
			"metrialNum": 1,
			"metrial": [{
				"Name": "耐张线夹",
				"Type": "NY-55G",
				"Count": 1,
				"Weight": 0.70,
				"about": "",
				"unit": ""
			}]
		},
			{
				"Type": "乙",
				"minResistance": 0.0,
				"maxResistance": 0.0,
				"TowerType": 1,
				"metrialNum": 0,
				"metrial": [{
					"Name": "",
					"Type": "",
					"Count": "",
					"Weight": "",
					"about": "",
					"unit": ""
				}]
			}],
		"HAMMER": [{
			"Name": "FZ4",
			"lineName": "LGJX-400/35",
			"fRNum": [1, 2, 3, 4, 5, 6, 7],
			"upLimit": [100.0, 200.0, 300.0, 400.0, 500.0, 600.0, 1000.0]
		},
			{
				"Name": "FZ7",
				"lineName": "LGJX-50/30",
				"fRNum": [1, 2, 3, 4, 5, 6, 7],
				"upLimit": [100.0, 200.0, 300.0, 400.0, 500.0, 600.0, 1000.0]
			}],
		"PRIMARY": {
			"voltage": 3,
			"circuit": 1,
			"windH": 10.0,
			"alfa": 0.16,
			"dIce": 5.0,
			"pLTract": 0.2,
			"InsularMaxL": 0.0,
			"m_standard": [
				{
					"info": "01对居民地",
					"dist": 14.0
				},
				{
					"info": "02对非居民地",
					"dist": 11.0
				},
				{
					"info": "03对交通困难区",
					"dist": 8.5
				},
				{
					"info": "04风偏对地净空距离",
					"dist": 6.5
				},
				{
					"info": "05房屋垂直",
					"dist": 9.0
				},
				{
					"info": "06房屋净空",
					"dist": 8.5
				},
				{
					"info": "07树木垂直",
					"dist": 7.0
				},
				{
					"info": "08树木净空",
					"dist": 7.0
				},
				{
					"info": "09跨电力线",
					"dist": 6.0
				},
				{
					"info": "10跨电杆顶点",
					"dist": 8.5
				},
				{
					"info": "11跨通讯线",
					"dist": 8.5
				},
				{
					"info": "12跨索道",
					"dist": 6.5
				},
				{
					"info": "13特殊管道",
					"dist": 7.5
				},
				{
					"info": "14等级路面",
					"dist": 14.0
				},
				{
					"info": "15窄轨铁路",
					"dist": 13.0
				},
				{
					"info": "16标准轨距铁路",
					"dist": 14.0
				},
				{
					"info": "17电气轨铁路",
					"dist": 16.0
				},
				{
					"info": "18通河洪水",
					"dist": 9.5
				},
				{
					"info": "19通河桅顶",
					"dist": 6.0
				},
				{
					"info": "20百年一遇洪水位",
					"dist": 6.5
				}]
		}
	};//prk初始化
		towerStartHei = prk.TOWER[0].StartHigh;
		towerEndHei = prk.TOWER[0].EndHigh;
		towerHeiDif = towerEndHei - towerStartHei;
		towerHeiInDif = prk.TOWER[0].Dhigh;
		towerHeiArray.length = towerHeiDif / towerHeiInDif + 1;
		for (let i = 0; i < towerHeiArray.length; i++) {
			towerHeiArray[i] = towerStartHei + i * towerHeiInDif;
		}
	savedJson.prk = prk;
	var prkStr = JSON.stringify(prk);
	//上传文件至后台
	var xhr,ot,oloaded;var fileCata = [];//文件目录
	window.upfile = function() {
		var fileObj = document.getElementById("file").files[0]; // js 获取文件对象
		console.log(fileObj);
		var url =  "http://202.114.118.138:8181/fileUpload"; // 接收上传文件的后台地址
		var form = new FormData(); // FormData 对象
		form.append("file", fileObj); // 文件对象
		form.append("ProjectName", prjName);//控制路径

		xhr = new XMLHttpRequest();  // XMLHttpRequest 对象
		xhr.open("post", url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
		xhr.onload = uploadcomplete; //请求完成
		xhr.onerror =  uploadfailed; //请求失败

		// xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
		xhr.upload.onloadstart = function(){//上传开始执行方法
			ot = new Date().getTime();   //设置上传开始时间
			oloaded = 0;//设置上传开始时，以上传的文件大小为0
		};
		xhr.send(form); //开始上传，发送form数据
	}
	function uploadcomplete(evt) {alert("成功上传！");}//上传成功响应
	function uploadfailed(evt) {alert("上传失败！");}//上传失败响应
	//取消文件上传
	window.cancelUploadFile = function (){xhr.abort();}
	//打开后台文件
	window.updateFilelist = function(){
		towerlist = [];
		$.ajax({
			url: "http://202.114.118.138:8181/directory/" + prjName, //提交的路径
			type: "get",       //提交方式
			dataType:"json",
			success: function(data){
				console.log(data);
				for (let i = 0; i < data.length; i++) {
					fileCata.push(data[i].name);
				}
				console.log(fileCata);
				document.getElementById("dembox").options.length=0;
				for (let i = 0; i < fileCata.length; i++) {
					document.getElementById("dembox").options.add(new Option(fileCata[i],i.toString()));
				}

				window.openBeFile = function(){
					let text = $('#dembox option:selected').text();

					let form = new FormData();
					form.append("FileName", text); // 文件对象
					form.append("ProjectName", prjName);//控制路径

					$.ajax({
						url: "http://202.114.118.138:8181/ReadfileToJson", //提交的路径
						type: "post",       //提交方式
						data: form,    //提交的数据
						contentType: false, // 告诉jQuery不要去设置Content-Type请求头
						processData: false,
						success: function(data){
							console.log(data);
							alert("已打开");
							let key = Object.keys(data);
							console.log(key);
							if(key[0] === "GEO"){
								reclear();
								cornerCor = data.GEO;
							}//转角
							if(key[0] === "LEFT"){
								reclear();
								leftLineCor = data.LEFT;rightLineCor = data.RIGHT;midLineCor = data.MID;
								drawDEM(leftLineCor,rightLineCor,midLineCor,cornerCor);
								drawGeo(cornerCor);
							}//DEM
							if(key[0] === "TOWERLIST"){
								for (let i = 0; i < scene.children.length; i++){
									if (scene.children[i].name === "fixTower"||scene.children[i].name === "wire"){
										towerList.push(scene.children[i]);
									}
								}
								for (let i = 0; i < towerList.length; i++) {scene.remove(towerList[i]);}

								let towerlist1 = {};
								towerlist1 = data.TOWERLIST;
								console.log(towerlist1);
								let pos = [];
								for (let i = 0; i < towerlist1.length; i++) {
									pos.push(new THREE.Vector3(towerlist1[i].Distance/10,towerlist1[i].High - yMin,0));
									createTower(pos[i]);
								}
							}
							if(key[0] === "GCONNECT"){
								let json = data;
								$('#guicheng').click(function () {
									$('.edit').attr('disabled',true);
									$('#database').attr('disabled',true);
									$('#h2title').html($('#guicheng').html());
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":[{id:1, name: '系统设置'}, {id: 2, name: '交叉跨越'}]},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											if(checkedList[0].id === 1){
												data = [];
												console.log(json.PRIMARY);
												data = [
													{
														'name': '电压等级',
														'value':voltageArr[json.PRIMARY.voltage]
													},
													{
														'name':'设计回路',
														'value':circuitArr[json.PRIMARY.circuit - 1]
													},
													{
														'name':'导线平均高度m',
														'value':json.PRIMARY.windH
													},
													{
														'name':'地面粗糙度系数a',
														'value':json.PRIMARY.alfa
													},
													{
														'name':'地线覆盖较冰导线增加mm',
														'value':json.PRIMARY.dIce
													},
													{
														'name':'导线过牵引长度m',
														'value':json.PRIMARY.pLTract
													},
													{
														'name':'孤立档最大档距m',
														'value':json.PRIMARY.InsularMaxL
													}
												]
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data":data},
													columnData: columndataRight
												});
											}
											else if (checkedList[0].id === 2){
												$('#database').attr('disabled',false);
												data = [];
												console.log(json.PRIMARY.m_standard);
												for (let i = 0; i < json.PRIMARY.m_standard.length; i++) {
													data.push({'name':json.PRIMARY.m_standard[i].info,'value':json.PRIMARY.m_standard[i].dist})
												}
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data":data},
													columnData: columndataRight
												});
											}
										}
									});
								})

								$('#daodixian').click(function () {
									$('.edit').attr('disabled',false);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#daodixian').html());
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":[{id:1, name: ''}]},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											if(checkedList[0].id === 1){
												data = [];
												console.log(json.CONDUCTOR[0]);
												data = [
													{
														'name': '导地线类型',
														'value':conductorArr[json.CONDUCTOR[0].type]
													},
													{
														'name':'导地线截面积(mm^2)',
														'value':json.CONDUCTOR[0].A
													},
													{
														'name':'导地线直径(mm)',
														'value':json.CONDUCTOR[0].d
													},
													{
														'name':'计算拉断力(N)',
														'value':json.CONDUCTOR[0].Tp
													},
													{
														'name':'单位长度质量(kg/mm)',
														'value':json.CONDUCTOR[0].p1
													},
													{
														'name':'弹性系数(N/mm^2)',
														'value':json.CONDUCTOR[0].E
													},
													{
														'name':'膨胀系数x1E-6/℃',
														'value':json.CONDUCTOR[0].a
													},
													{
														'name':'导线分裂数',
														'value':json.CONDUCTOR[0].num
													}
												]
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data":data},
													columnData: columndataRight
												});
											}
										}
									});
								})

								$('#qixiang').click(function () {
									$('.edit').attr('disabled',false);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#qixiang').html());
									data = [];
									for (let i = 0; i < json.WEATHER.length; i++) {
										data.push({
											'id':i+1,
											'name':json.WEATHER[i].name
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											if (checkedList[0].id === 1) {
												data = [];
												for (let j = 0; j < json.WEATHER[0].TWI.length; j++) {
													data.push({
														'name': json.WEATHER[0].TWI[j].name,
														't': json.WEATHER[0].TWI[j].t,
														'v': json.WEATHER[0].TWI[j].v,
														'b': json.WEATHER[0].TWI[j].b
													})
												}
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data": data},
													columnData: [{key: 'name', text: '气象条件'}, {key: 't', text: '温度℃'}, {
														key: 'v',
														text: '风速m/s'
													}, {key: 'b', text: '覆冰(导)mm'}]
												});
											}
											else if (checkedList[0].id === 2) {
												data = [];
												for (let j = 0; j < json.WEATHER[1].TWI.length; j++) {
													data.push({
														'name':json.WEATHER[1].TWI[j].name,
														't':json.WEATHER[1].TWI[j].t,
														'v':json.WEATHER[1].TWI[j].v,
														'b':json.WEATHER[1].TWI[j].b
													})
												}
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data":data},
													columnData: [{key: 'name', text: '气象条件'}, {key: 't', text: '温度℃'},{key: 'v', text: '风速m/s'}, {key: 'b', text: '覆冰(导)mm'}]
												});
											}
										}
									});
								})

								$('#fenduan').click(function () {
									$('.edit').attr('disabled',false);
									$('#database').attr('disabled',true);
									$('#h2title').html($('#fenduan').html());
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":[{id:1, name: json.SECTION[0].name}]},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											if(checkedList[0].id === 1){
												data = [];
												console.log(json.SECTION[0]);
												data = [
													{
														'name': '起始桩号',
														'value':json.SECTION[0].starJ
													},
													{
														'name':'起始累距',
														'value':json.SECTION[0].from
													},
													{
														'name':'终点桩号',
														'value':json.SECTION[0].endJ
													},
													{
														'name':'终点累距',
														'value':json.SECTION[0].to
													},
													{
														'name':'气象区名称',
														'value':json.SECTION[0].wertherName
													},
													{
														'name':'导线型号',
														'value':json.SECTION[0].powerLine
													},
													{
														'name':'导线新线系数',
														'value':json.SECTION[0].pLineK
													},
													{
														'name':'导线安全系数',
														'value':json.SECTION[0].pLineF
													},
													{
														'name':'导线年平运行张力上限',
														'value':json.SECTION[0].pLineC
													},
													{
														'name':'地线型号',
														'value':json.SECTION[0].groundLine
													},
													{
														'name':'地线新线系数',
														'value':json.SECTION[0].gLineK
													},
													{
														'name':'地线安全系数',
														'value':json.SECTION[0].gLineF
													},
													{
														'name':'地线年平运行张力上限',
														'value':json.SECTION[0].gLineC
													},
													{
														'name':'设计回路',
														'value':circuitArr[json.SECTION[0].circuit - 1]
													}
												]
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data":data},
													columnData: columndataRight
												});
											}
										}
									});
								})

								$('#gantashiyong').click(function () {
									$('.edit').attr('disabled',false);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#gantashiyong').html());
									data = [];
									for (let i = 0; i < json.TOWER.length; i++) {
										data.push({
											'id':i+1,
											'name':json.TOWER[i].Name,
											'NO':json.TOWER[i].No
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											for (let j = 0; j < json.TOWER.length; j++) {
												if ( j === checkedList[0].NO){
													data = [];
													data = [
														{
															'name': '杆塔类型',
															'value': towerArr[json.TOWER[j].type]
														},
														{
															'name': '最大档距(m)',
															'value': json.TOWER[j].MaxL
														},
														{
															'name': '水平档距(m)',
															'value': json.TOWER[j].LH
														},
														{
															'name': '垂直档距(m)',
															'value': json.TOWER[j].LV
														},
														{
															'name': '起始呼高(m)',
															'value': json.TOWER[j].StartHigh
														},
														{
															'name':'级差增量(m)',
															'value':json.TOWER[j].Dhigh
														},
														{
															'name': '终止呼高(m)',
															'value': json.TOWER[j].EndHigh
														},
														{
															'name': '最小转角度数(°)',
															'value': json.TOWER[j].MinAngle
														},
														{
															'name': '最大转角度数(°)',
															'value': json.TOWER[j].MaxAngle
														},
														{
															'name': '角度折算水平档距(m/°)',
															'value': json.TOWER[j].Angle2LH
														},
														{
															'name': '摇摆角kv值',
															'value': json.TOWER[j].KV
														},
														{
															'name':'大风工况摇摆角(°)',
															'value':json.TOWER[j].sway.WindA
														},
														{
															'name':'内过电压摇摆角(°)',
															'value':json.TOWER[j].sway.OperationA
														},
														{
															'name':'外过电压摇摆角(°)',
															'value':json.TOWER[j].sway.AtomosphereA
														},
														{
															'name':'带电作业摇摆角(°)',
															'value':json.TOWER[j].sway.ElecA
														},
														{
															'name': '最大横担长度(m)',
															'value': json.TOWER[j].Dist
														},
														{
															'name': '地线支架高度(m)',
															'value': json.TOWER[j].upToTop
														},
														{
															'name': '上中导线高差(m)',
															'value': json.TOWER[j].upToMid
														},
														{
															'name': '中下导线高差(m)',
															'value': json.TOWER[j].minToDown
														},
														{
															'name': '其他附加属性',
															'value': toweraddTypeArr[json.TOWER[j].typeEx - 1]
														},
														{
															'name': '最低塔正面根开(m)',
															'value': json.TOWER[j].baseLw
														},
														{
															'name': '最低塔侧面根开(m)',
															'value': json.TOWER[j].baseLl
														},
														{
															'name': '最高塔正面根开(m)',
															'value': json.TOWER[j].baseHw
														},
														{
															'name': '最高塔侧面根开(m)',
															'value': json.TOWER[j].baseHl
														},
														{
															'name': '杆塔分组号',
															'value': json.TOWER[j].Group
														}];
													document.querySelector('#detailsTable').GM({
														gridManagerName: 'details',
														supportAutoOrder: false,
														supportDrag: false,
														supportCheckbox: false,
														ajaxData: {"data": data},
														columnData: columndataRight
													});
												}
											}
										}
									});
								})

								$('#gantatacai').click(function () {
									$('.edit').attr('disabled',true);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#gantatacai').html());
									data = [];
									for (let i = 0; i < json.TOWER.length; i++) {
										data.push({
											'id':i+1,
											'name':json.TOWER[i].Name,
											'NO':json.TOWER[i].No
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											for (let j = 0; j < json.TOWER.length; j++) {
												if ( j === checkedList[0].NO){
													data = [];
													for (let k = 0; k < json.TOWER[j].price.length; k++){
														data.push({
															'name':json.TOWER[j].Name + '-' + json.TOWER[j].price[k].High,
															'Weight':json.TOWER[j].price[k].Weight,
															'BaseWight':json.TOWER[j].price[k].BaseWight,
															'BaseM':json.TOWER[j].price[k].BaseM,
															'JJ':json.TOWER[j].price[k].JJ
														})
														document.querySelector('#detailsTable').GM({
															gridManagerName: 'details',
															supportAutoOrder: false,
															supportDrag: false,
															supportCheckbox: false,
															ajaxData: {"data": data},
															columnData: [{key: 'name', text: '杆塔名称'}, {key: 'Weight', text: '塔材(kg)'},{key: 'BaseWight', text: '基础钢材(kg)'}, {key: 'BaseM', text: '混凝土(吨)'}, {key: 'JJ', text: '串折算'}]
														});
													}

												}
											}
										}
									});
								})

								$('#jueyuancan').click(function () {
									$('.edit').attr('disabled',false);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#jueyuancan').html());
									data = [];
									for (let i = 0; i < json.INSULATE.length; i++) {
										data.push({
											'id':i+1,
											'name':json.INSULATE[i].name
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											// console.log(checkedList);
											for (let j = 0; j < json.INSULATE.length; j++) {
												if ( j === (checkedList[0].id - 1)){
													data = [];
													data = [
														{
															'name': '绝缘子串类型',
															'value': insulateArr[json.INSULATE[j].type]
														},
														{
															'name': '单联双联',
															'value': sindouArr[json.INSULATE[j].Join - 1]
														},
														{
															'name': '每联片数',
															'value': json.INSULATE[j].Num
														},
														{
															'name': '无冰串重(kg)',
															'value': json.INSULATE[j].Weight
														},
														{
															'name': '单片覆冰(kg)',
															'value': json.INSULATE[j].IceWeight
														},
														{
															'name':'等效串长(m)',
															'value':json.INSULATE[j].Length
														},
														{
															'name': '单片受风面积(m^2)',
															'value': json.INSULATE[j].area
														},
														{
															'name': '金具受风折算系数',
															'value': json.INSULATE[j].k
														},
														{
															'name': '绝缘子常年荷载安全系数',
															'value': json.INSULATE[j].avergeK
														},
														{
															'name': '绝缘子最大荷载安全系数',
															'value': json.INSULATE[j].maxK
														},
														{
															'name': '绝缘子断线工况安全系数',
															'value': json.INSULATE[j].lineBrokeK
														},
														{
															'name':'绝缘子破坏荷载(kN)',
															'value':json.INSULATE[j].Strength
														},
														{
															'name':'金具最大荷载安全系数',
															'value':json.INSULATE[j].jjmaxK
														},
														{
															'name':'金具断线工况安全系数',
															'value':json.INSULATE[j].jjlineBrokeK
														},
														{
															'name':'金具破坏荷载(kN)',
															'value':json.INSULATE[j].jjStrength
														},
														{
															'name': 'V型串夹角(°)',
															'value': json.INSULATE[j].angleV
														},
														{
															'name': '污秽区使用条件',
															'value': dirtyareaArr[json.INSULATE[j].dirtyTpye]
														},
														{
															'name': '绝缘子材料',
															'value': insulateMateArr[json.INSULATE[j].material]
														}];
													document.querySelector('#detailsTable').GM({
														gridManagerName: 'details',
														supportAutoOrder: false,
														supportDrag: false,
														supportCheckbox: false,
														ajaxData: {"data": data},
														columnData: columndataRight
													});
												}
											}
										}
									});
								})

								$('#jueyuancai').click(function () {
									$('.edit').attr('disabled',true);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#jueyuancai').html());
									data = [];
									for (let i = 0; i < json.INSULATE.length; i++) {
										data.push({
											'id':i+1,
											'name':json.INSULATE[i].name
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											for (let j = 0; j < json.INSULATE.length; j++) {
												if ( j === (checkedList[0].id - 1)){
													data = [];
													for (let k = 0; k < json.INSULATE[j].metrial.length; k++){
														data.push({
															'name':json.INSULATE[j].metrial[k].Name,
															'Type':json.INSULATE[j].metrial[k].Type,
															'Count':json.INSULATE[j].metrial[k].Count,
															'Weight':json.INSULATE[j].metrial[k].Weight,
															'about':json.INSULATE[j].metrial[k].about,
															'unit':json.INSULATE[j].metrial[k].unit
														})
														document.querySelector('#detailsTable').GM({
															gridManagerName: 'details',
															supportAutoOrder: false,
															supportDrag: false,
															supportCheckbox: false,
															ajaxData: {"data": data},
															columnData: [{key: 'name', text: '材料名称'}, {key: 'Type', text: '材料型号'},{key: 'unit', text: '单位'},  {key: 'Weight', text: '单重'},{key: 'Count', text: '数量'}, {key: 'about', text: '备注'}]
														});
													}

												}
											}
										}
									});
								})

								$('#jiedican').click(function () {
									$('.edit').attr('disabled',false);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#jiedican').html());
									data = [];
									for (let i = 0; i < json.GCONNECT.length; i++) {
										data.push({
											'id':i+1,
											'name':json.GCONNECT[i].Type
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											// console.log(checkedList);
											for (let j = 0; j < json.GCONNECT.length; j++) {
												if ( j === (checkedList[0].id - 1)){
													data = [];
													data = [
														{
															'name': '适用塔型',
															'value': toweraddTypeArr[json.GCONNECT[j].TowerType - 1]
														},
														{
															'name': '最小大地电阻率',
															'value': json.GCONNECT[j].minResistance
														},
														{
															'name': '最大大地电阻率',
															'value': json.GCONNECT[j].maxResistance
														}];
													document.querySelector('#detailsTable').GM({
														gridManagerName: 'details',
														supportAutoOrder: false,
														supportDrag: false,
														supportCheckbox: false,
														ajaxData: {"data": data},
														columnData: columndataRight
													});
												}
											}
										}
									});
								})

								$('#jiedicai').click(function () {
									$('.edit').attr('disabled',true);
									$('#database').attr('disabled',false);
									$('#h2title').html($('#jiedicai').html());
									data = [];
									for (let i = 0; i < json.GCONNECT.length; i++) {
										data.push({
											'id':i+1,
											'name':json.GCONNECT[i].Type
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											for (let j = 0; j < json.GCONNECT.length; j++) {
												if ( j === (checkedList[0].id - 1)){
													data = [];
													for (let k = 0; k < json.GCONNECT[j].metrial.length; k++){
														data.push({
															'name':json.GCONNECT[j].metrial[k].Name,
															'Type':json.GCONNECT[j].metrial[k].Type,
															'Count':json.GCONNECT[j].metrial[k].Count,
															'Weight':json.GCONNECT[j].metrial[k].Weight,
															'about':json.GCONNECT[j].metrial[k].about,
															'unit':json.GCONNECT[j].metrial[k].unit
														})
														document.querySelector('#detailsTable').GM({
															gridManagerName: 'details',
															supportAutoOrder: false,
															supportDrag: false,
															supportCheckbox: false,
															ajaxData: {"data": data},
															columnData: [{key: 'name', text: '材料名称'}, {key: 'Type', text: '材料型号'},{key: 'unit', text: '单位'},  {key: 'Weight', text: '单重'},{key: 'Count', text: '数量'}, {key: 'about', text: '备注'}]
														});
													}

												}
											}
										}
									});
								})

								$('#fangzhenchui').click(function () {
									$('#database').attr('disabled',true);
									$('.edit').attr('disabled',false);
									$('#h2title').html($('#fangzhenchui').html());
									data = [];
									for (let i = 0; i < json.HAMMER.length; i++) {
										data.push({
											'id':i+1,
											'name':json.HAMMER[i].Name
										})
									}
									document.querySelector('#outlineTable').GM({
										gridManagerName: 'outline',
										supportAutoOrder: false,
										supportDrag: false,
										checkboxConfig: {
											useRowCheck: true,
											useRadio: true
										},
										ajaxData: {"data":data},
										columnData: columndataLeft,
										checkedAfter: function (checkedList) {
											// console.log(checkedList);
											for (let j = 0; j < json.HAMMER.length; j++) {
												if ( j === (checkedList[0].id - 1)){
													data = [{'name':'适用导地线','value': json.HAMMER[j].lineName}];
													for (let i = 0; i < json.HAMMER[j].fRNum.length; i++) {
														data.push({
															'name':'第'+(i+1)+'组规则',
															'value':json.HAMMER[j].fRNum[i],
															'upLimit':json.HAMMER[j].upLimit[i]
														})
													}
													document.querySelector('#detailsTable').GM({
														gridManagerName: 'details',
														supportAutoOrder: false,
														supportDrag: false,
														supportCheckbox: false,
														ajaxData: {"data": data},
														columnData:  [{key: 'name', text: '参数名称'}, {key: 'value', text: '型号/数量'},{key: 'upLimit', text: '适用档距上限'}]
													});
												}
											}
										}
									});
								})
							}
						},
						error: function (errorMsg) {
							alert(errorMsg);
						}
					})
				}
			},
			error: function (errorMsg) {
				alert(errorMsg);
			}
		})
	}
	//打开本地json文件（路径固定）
	window.upjsonfile = function(){
		towerlist = [];
		wirelist = [];
		for (let i = 0; i < allChildren.length; i++){
			group.remove(allChildren[i]);
		}
		for (let i = 0; i < scene.children.length; i++){
			if (scene.children[i].name === "dem"||scene.children[i].name === "corner"){
				dem.push(scene.children[i]);
			}
			if (scene.children[i].name === "fixTower"||scene.children[i].name === "wire"){
				towerList.push(scene.children[i]);     //capital
			}
		}
		for (let i = 0; i < dem.length; i++) {
			scene.remove(dem[i]);
		}
		for (let i = 0; i < towerList.length; i++) {
			scene.remove(towerList[i]);
		}
		savedJson = {"DEM":"","GEO":"","pwf":"","prk":"","Lao":""};
		var fileObj = document.getElementById("jsonfile").files[0]; // js 获取文件对象
		var fileName = fileObj.name;

		var request = new XMLHttpRequest();
		request.open("get","./json/" + fileName);
		request.send(null);
		request.onload = function () {
			if (request.status === 200){
				var jsonRead = JSON.parse(request.response);
				console.log(jsonRead);

				leftLineCor = jsonRead.DEM[0].LEFT;//左边线
				rightLineCor = jsonRead.DEM[0].RIGHT;//右边线
				midLineCor = jsonRead.DEM[0].MID;//中心断面
				cornerCor = jsonRead.GEO;//转角
				console.log(cornerCor);
				let towerlist = jsonRead.pwf.TOWERLIST;
				console.log(towerlist);

				drawDEM(leftLineCor,rightLineCor,midLineCor,cornerCor);
				drawGeo(cornerCor);
				let pos = [];
				for (let i = 0; i < towerlist.length; i++) {
					pos.push(new THREE.Vector3(towerlist[i].Distance/10,towerlist[i].High - yMin,0));
					createTower(pos[i]);
				}
			}
		}
	}
	//打开本地prj文件
	window.upprjfile = function() {
		for (let i = 0; i < allChildren.length; i++){
			//group.remove(allChildren[i]);
		}
		for (let i = 0; i < scene.children.length; i++){
			if (scene.children[i].name === "dem"||scene.children[i].name === "corner"){
				dem.push(scene.children[i]);
			}
			if (scene.children[i].name === "fixTower"||scene.children[i].name === "wire"){
				towerList.push(scene.children[i]);   //capital
			}
		}
		for (let i = 0; i < dem.length; i++) {
			scene.remove(dem[i]);
		}
		for (let i = 0; i < towerList.length; i++) {
			scene.remove(towerList[i]);
		}

		towerlist = [];

		savedJson = {"DEM":"","GEO":"","pwf":"","prk":"","Lao":""};
		var fileObj = document.getElementById("TLfile").files[0]; // js 获取文件对象
		console.log(fileObj);
		var form = new FormData(); // FormData 对象
		form.append("file", fileObj); // 文件对象
		form.append("ProjectName", prjName);//控制路径

		$.ajax({
			url: "http://202.114.118.138:8181/UploadfileToJson", //提交的路径
			type: "post",       //提交方式
			data: form,    //提交的数据
			// dataType:"json",
			contentType: false, // 告诉jQuery不要去设置Content-Type请求头
			processData: false,
			success: function (data) {
				console.log(data);
				alert("已打开工程文件");
				savedJson.GEO = data.GEO;
				//打开本地prk文件
				window.upprkfile = function(){
					var prkfileObj = document.getElementById("TLprkfile").files[0]; // js 获取文件对象
					console.log(prkfileObj);
					var prkform = new FormData(); // FormData 对象
					prkform.append("file", prkfileObj); // 文件对象
					prkform.append("ProjectName", prjName);//控制路径

					$.ajax({
						url: "http://202.114.118.138:8181/UploadfileToJson", //提交的路径
						type: "post",       //提交方式
						data: prkform,    //提交的数据
						contentType: false, // 告诉jQuery不要去设置Content-Type请求头
						processData: false,
						success: function(prkdata){
							let json = prkdata;
							$('#guicheng').click(function () {
								$('.edit').attr('disabled',true);
								$('#database').attr('disabled',true);
								$('#h2title').html($('#guicheng').html());
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":[{id:1, name: '系统设置'}, {id: 2, name: '交叉跨越'}]},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										if(checkedList[0].id === 1){
											data = [];
											console.log(json.PRIMARY);
											data = [
												{
													'name': '电压等级',
													'value':voltageArr[json.PRIMARY.voltage]
												},
												{
													'name':'设计回路',
													'value':circuitArr[json.PRIMARY.circuit - 1]
												},
												{
													'name':'导线平均高度m',
													'value':json.PRIMARY.windH
												},
												{
													'name':'地面粗糙度系数a',
													'value':json.PRIMARY.alfa
												},
												{
													'name':'地线覆盖较冰导线增加mm',
													'value':json.PRIMARY.dIce
												},
												{
													'name':'导线过牵引长度m',
													'value':json.PRIMARY.pLTract
												},
												{
													'name':'孤立档最大档距m',
													'value':json.PRIMARY.InsularMaxL
												}
											]
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data":data},
												columnData: columndataRight
											});
										}
										else if (checkedList[0].id === 2){
											$('#database').attr('disabled',false);
											data = [];
											console.log(json.PRIMARY.m_standard);
											for (let i = 0; i < json.PRIMARY.m_standard.length; i++) {
												data.push({'name':json.PRIMARY.m_standard[i].info,'value':json.PRIMARY.m_standard[i].dist})
											}
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data":data},
												columnData: columndataRight
											});
										}
									}
								});
							})
							$('#daodixian').click(function () {
								$('.edit').attr('disabled',false);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#daodixian').html());
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":[{id:1, name: ''}]},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										if(checkedList[0].id === 1){
											data = [];
											console.log(json.CONDUCTOR[0]);
											data = [
												{
													'name': '导地线类型',
													'value':conductorArr[json.CONDUCTOR[0].type]
												},
												{
													'name':'导地线截面积(mm^2)',
													'value':json.CONDUCTOR[0].A
												},
												{
													'name':'导地线直径(mm)',
													'value':json.CONDUCTOR[0].d
												},
												{
													'name':'计算拉断力(N)',
													'value':json.CONDUCTOR[0].Tp
												},
												{
													'name':'单位长度质量(kg/mm)',
													'value':json.CONDUCTOR[0].p1
												},
												{
													'name':'弹性系数(N/mm^2)',
													'value':json.CONDUCTOR[0].E
												},
												{
													'name':'膨胀系数x1E-6/℃',
													'value':json.CONDUCTOR[0].a
												},
												{
													'name':'导线分裂数',
													'value':json.CONDUCTOR[0].num
												}
											]
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data":data},
												columnData: columndataRight
											});
										}
									}
								});
							})
							$('#qixiang').click(function () {
								$('.edit').attr('disabled',false);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#qixiang').html());
								data = [];
								for (let i = 0; i < json.WEATHER.length; i++) {
									data.push({
										'id':i+1,
										'name':json.WEATHER[i].name
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										if (checkedList[0].id === 1) {
											data = [];
											for (let j = 0; j < json.WEATHER[0].TWI.length; j++) {
												data.push({
													'name': json.WEATHER[0].TWI[j].name,
													't': json.WEATHER[0].TWI[j].t,
													'v': json.WEATHER[0].TWI[j].v,
													'b': json.WEATHER[0].TWI[j].b
												})
											}
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data": data},
												columnData: [{key: 'name', text: '气象条件'}, {key: 't', text: '温度℃'}, {
													key: 'v',
													text: '风速m/s'
												}, {key: 'b', text: '覆冰(导)mm'}]
											});
										}
										else if (checkedList[0].id === 2) {
											data = [];
											for (let j = 0; j < json.WEATHER[1].TWI.length; j++) {
												data.push({
													'name':json.WEATHER[1].TWI[j].name,
													't':json.WEATHER[1].TWI[j].t,
													'v':json.WEATHER[1].TWI[j].v,
													'b':json.WEATHER[1].TWI[j].b
												})
											}
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data":data},
												columnData: [{key: 'name', text: '气象条件'}, {key: 't', text: '温度℃'},{key: 'v', text: '风速m/s'}, {key: 'b', text: '覆冰(导)mm'}]
											});
										}
									}
								});
							})
							$('#fenduan').click(function () {
								$('.edit').attr('disabled',false);
								$('#database').attr('disabled',true);
								$('#h2title').html($('#fenduan').html());
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":[{id:1, name: json.SECTION[0].name}]},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										if(checkedList[0].id === 1){
											data = [];
											console.log(json.SECTION[0]);
											data = [
												{
													'name': '起始桩号',
													'value':json.SECTION[0].starJ
												},
												{
													'name':'起始累距',
													'value':json.SECTION[0].from
												},
												{
													'name':'终点桩号',
													'value':json.SECTION[0].endJ
												},
												{
													'name':'终点累距',
													'value':json.SECTION[0].to
												},
												{
													'name':'气象区名称',
													'value':json.SECTION[0].wertherName
												},
												{
													'name':'导线型号',
													'value':json.SECTION[0].powerLine
												},
												{
													'name':'导线新线系数',
													'value':json.SECTION[0].pLineK
												},
												{
													'name':'导线安全系数',
													'value':json.SECTION[0].pLineF
												},
												{
													'name':'导线年平运行张力上限',
													'value':json.SECTION[0].pLineC
												},
												{
													'name':'地线型号',
													'value':json.SECTION[0].groundLine
												},
												{
													'name':'地线新线系数',
													'value':json.SECTION[0].gLineK
												},
												{
													'name':'地线安全系数',
													'value':json.SECTION[0].gLineF
												},
												{
													'name':'地线年平运行张力上限',
													'value':json.SECTION[0].gLineC
												},
												{
													'name':'设计回路',
													'value':circuitArr[json.SECTION[0].circuit - 1]
												}
											]
											document.querySelector('#detailsTable').GM({
												gridManagerName: 'details',
												supportAutoOrder: false,
												supportDrag: false,
												supportCheckbox: false,
												ajaxData: {"data":data},
												columnData: columndataRight
											});
										}
									}
								});
							})
							$('#gantashiyong').click(function () {
								$('.edit').attr('disabled',false);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#gantashiyong').html());
								data = [];
								for (let i = 0; i < json.TOWER.length; i++) {
									data.push({
										'id':i+1,
										'name':json.TOWER[i].Name,
										'NO':json.TOWER[i].No
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										for (let j = 0; j < json.TOWER.length; j++) {
											if ( j === checkedList[0].NO){
												data = [];
												data = [
													{
														'name': '杆塔类型',
														'value': towerArr[json.TOWER[j].type]
													},
													{
														'name': '最大档距(m)',
														'value': json.TOWER[j].MaxL
													},
													{
														'name': '水平档距(m)',
														'value': json.TOWER[j].LH
													},
													{
														'name': '垂直档距(m)',
														'value': json.TOWER[j].LV
													},
													{
														'name': '起始呼高(m)',
														'value': json.TOWER[j].StartHigh
													},
													{
														'name':'级差增量(m)',
														'value':json.TOWER[j].Dhigh
													},
													{
														'name': '终止呼高(m)',
														'value': json.TOWER[j].EndHigh
													},
													{
														'name': '最小转角度数(°)',
														'value': json.TOWER[j].MinAngle
													},
													{
														'name': '最大转角度数(°)',
														'value': json.TOWER[j].MaxAngle
													},
													{
														'name': '角度折算水平档距(m/°)',
														'value': json.TOWER[j].Angle2LH
													},
													{
														'name': '摇摆角kv值',
														'value': json.TOWER[j].KV
													},
													{
														'name':'大风工况摇摆角(°)',
														'value':json.TOWER[j].sway.WindA
													},
													{
														'name':'内过电压摇摆角(°)',
														'value':json.TOWER[j].sway.OperationA
													},
													{
														'name':'外过电压摇摆角(°)',
														'value':json.TOWER[j].sway.AtomosphereA
													},
													{
														'name':'带电作业摇摆角(°)',
														'value':json.TOWER[j].sway.ElecA
													},
													{
														'name': '最大横担长度(m)',
														'value': json.TOWER[j].Dist
													},
													{
														'name': '地线支架高度(m)',
														'value': json.TOWER[j].upToTop
													},
													{
														'name': '上中导线高差(m)',
														'value': json.TOWER[j].upToMid
													},
													{
														'name': '中下导线高差(m)',
														'value': json.TOWER[j].minToDown
													},
													{
														'name': '其他附加属性',
														'value': toweraddTypeArr[json.TOWER[j].typeEx - 1]
													},
													{
														'name': '最低塔正面根开(m)',
														'value': json.TOWER[j].baseLw
													},
													{
														'name': '最低塔侧面根开(m)',
														'value': json.TOWER[j].baseLl
													},
													{
														'name': '最高塔正面根开(m)',
														'value': json.TOWER[j].baseHw
													},
													{
														'name': '最高塔侧面根开(m)',
														'value': json.TOWER[j].baseHl
													},
													{
														'name': '杆塔分组号',
														'value': json.TOWER[j].Group
													}];
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data": data},
													columnData: columndataRight
												});
											}
										}
									}
								});
							})
							$('#gantatacai').click(function () {
								$('.edit').attr('disabled',true);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#gantatacai').html());
								data = [];
								for (let i = 0; i < json.TOWER.length; i++) {
									data.push({
										'id':i+1,
										'name':json.TOWER[i].Name,
										'NO':json.TOWER[i].No
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										for (let j = 0; j < json.TOWER.length; j++) {
											if ( j === checkedList[0].NO){
												data = [];
												for (let k = 0; k < json.TOWER[j].price.length; k++){
													data.push({
														'name':json.TOWER[j].Name + '-' + json.TOWER[j].price[k].High,
														'Weight':json.TOWER[j].price[k].Weight,
														'BaseWight':json.TOWER[j].price[k].BaseWight,
														'BaseM':json.TOWER[j].price[k].BaseM,
														'JJ':json.TOWER[j].price[k].JJ
													})
													document.querySelector('#detailsTable').GM({
														gridManagerName: 'details',
														supportAutoOrder: false,
														supportDrag: false,
														supportCheckbox: false,
														ajaxData: {"data": data},
														columnData: [{key: 'name', text: '杆塔名称'}, {key: 'Weight', text: '塔材(kg)'},{key: 'BaseWight', text: '基础钢材(kg)'}, {key: 'BaseM', text: '混凝土(吨)'}, {key: 'JJ', text: '串折算'}]
													});
												}

											}
										}
									}
								});
							})
							$('#jueyuancan').click(function () {
								$('.edit').attr('disabled',false);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#jueyuancan').html());
								data = [];
								for (let i = 0; i < json.INSULATE.length; i++) {
									data.push({
										'id':i+1,
										'name':json.INSULATE[i].name
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										// console.log(checkedList);
										for (let j = 0; j < json.INSULATE.length; j++) {
											if ( j === (checkedList[0].id - 1)){
												data = [];
												data = [
													{
														'name': '绝缘子串类型',
														'value': insulateArr[json.INSULATE[j].type]
													},
													{
														'name': '单联双联',
														'value': sindouArr[json.INSULATE[j].Join - 1]
													},
													{
														'name': '每联片数',
														'value': json.INSULATE[j].Num
													},
													{
														'name': '无冰串重(kg)',
														'value': json.INSULATE[j].Weight
													},
													{
														'name': '单片覆冰(kg)',
														'value': json.INSULATE[j].IceWeight
													},
													{
														'name':'等效串长(m)',
														'value':json.INSULATE[j].Length
													},
													{
														'name': '单片受风面积(m^2)',
														'value': json.INSULATE[j].area
													},
													{
														'name': '金具受风折算系数',
														'value': json.INSULATE[j].k
													},
													{
														'name': '绝缘子常年荷载安全系数',
														'value': json.INSULATE[j].avergeK
													},
													{
														'name': '绝缘子最大荷载安全系数',
														'value': json.INSULATE[j].maxK
													},
													{
														'name': '绝缘子断线工况安全系数',
														'value': json.INSULATE[j].lineBrokeK
													},
													{
														'name':'绝缘子破坏荷载(kN)',
														'value':json.INSULATE[j].Strength
													},
													{
														'name':'金具最大荷载安全系数',
														'value':json.INSULATE[j].jjmaxK
													},
													{
														'name':'金具断线工况安全系数',
														'value':json.INSULATE[j].jjlineBrokeK
													},
													{
														'name':'金具破坏荷载(kN)',
														'value':json.INSULATE[j].jjStrength
													},
													{
														'name': 'V型串夹角(°)',
														'value': json.INSULATE[j].angleV
													},
													{
														'name': '污秽区使用条件',
														'value': dirtyareaArr[json.INSULATE[j].dirtyTpye]
													},
													{
														'name': '绝缘子材料',
														'value': insulateMateArr[json.INSULATE[j].material]
													}];
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data": data},
													columnData: columndataRight
												});
											}
										}
									}
								});
							})
							$('#jueyuancai').click(function () {
								$('.edit').attr('disabled',true);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#jueyuancai').html());
								data = [];
								for (let i = 0; i < json.INSULATE.length; i++) {
									data.push({
										'id':i+1,
										'name':json.INSULATE[i].name
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										for (let j = 0; j < json.INSULATE.length; j++) {
											if ( j === (checkedList[0].id - 1)){
												data = [];
												for (let k = 0; k < json.INSULATE[j].metrial.length; k++){
													data.push({
														'name':json.INSULATE[j].metrial[k].Name,
														'Type':json.INSULATE[j].metrial[k].Type,
														'Count':json.INSULATE[j].metrial[k].Count,
														'Weight':json.INSULATE[j].metrial[k].Weight,
														'about':json.INSULATE[j].metrial[k].about,
														'unit':json.INSULATE[j].metrial[k].unit
													})
													document.querySelector('#detailsTable').GM({
														gridManagerName: 'details',
														supportAutoOrder: false,
														supportDrag: false,
														supportCheckbox: false,
														ajaxData: {"data": data},
														columnData: [{key: 'name', text: '材料名称'}, {key: 'Type', text: '材料型号'},{key: 'unit', text: '单位'},  {key: 'Weight', text: '单重'},{key: 'Count', text: '数量'}, {key: 'about', text: '备注'}]
													});
												}

											}
										}
									}
								});
							})
							$('#jiedican').click(function () {
								$('.edit').attr('disabled',false);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#jiedican').html());
								data = [];
								for (let i = 0; i < json.GCONNECT.length; i++) {
									data.push({
										'id':i+1,
										'name':json.GCONNECT[i].Type
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										// console.log(checkedList);
										for (let j = 0; j < json.GCONNECT.length; j++) {
											if ( j === (checkedList[0].id - 1)){
												data = [];
												data = [
													{
														'name': '适用塔型',
														'value': toweraddTypeArr[json.GCONNECT[j].TowerType - 1]
													},
													{
														'name': '最小大地电阻率',
														'value': json.GCONNECT[j].minResistance
													},
													{
														'name': '最大大地电阻率',
														'value': json.GCONNECT[j].maxResistance
													}];
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data": data},
													columnData: columndataRight
												});
											}
										}
									}
								});
							})
							$('#jiedicai').click(function () {
								$('.edit').attr('disabled',true);
								$('#database').attr('disabled',false);
								$('#h2title').html($('#jiedicai').html());
								data = [];
								for (let i = 0; i < json.GCONNECT.length; i++) {
									data.push({
										'id':i+1,
										'name':json.GCONNECT[i].Type
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										for (let j = 0; j < json.GCONNECT.length; j++) {
											if ( j === (checkedList[0].id - 1)){
												data = [];
												for (let k = 0; k < json.GCONNECT[j].metrial.length; k++){
													data.push({
														'name':json.GCONNECT[j].metrial[k].Name,
														'Type':json.GCONNECT[j].metrial[k].Type,
														'Count':json.GCONNECT[j].metrial[k].Count,
														'Weight':json.GCONNECT[j].metrial[k].Weight,
														'about':json.GCONNECT[j].metrial[k].about,
														'unit':json.GCONNECT[j].metrial[k].unit
													})
													document.querySelector('#detailsTable').GM({
														gridManagerName: 'details',
														supportAutoOrder: false,
														supportDrag: false,
														supportCheckbox: false,
														ajaxData: {"data": data},
														columnData: [{key: 'name', text: '材料名称'}, {key: 'Type', text: '材料型号'},{key: 'unit', text: '单位'},  {key: 'Weight', text: '单重'},{key: 'Count', text: '数量'}, {key: 'about', text: '备注'}]
													});
												}

											}
										}
									}
								});
							})
							$('#fangzhenchui').click(function () {
								$('#database').attr('disabled',true);
								$('.edit').attr('disabled',false);
								$('#h2title').html($('#fangzhenchui').html());
								data = [];
								for (let i = 0; i < json.HAMMER.length; i++) {
									data.push({
										'id':i+1,
										'name':json.HAMMER[i].Name
									})
								}
								document.querySelector('#outlineTable').GM({
									gridManagerName: 'outline',
									supportAutoOrder: false,
									supportDrag: false,
									checkboxConfig: {
										useRowCheck: true,
										useRadio: true
									},
									ajaxData: {"data":data},
									columnData: columndataLeft,
									checkedAfter: function (checkedList) {
										// console.log(checkedList);
										for (let j = 0; j < json.HAMMER.length; j++) {
											if ( j === (checkedList[0].id - 1)){
												data = [{'name':'适用导地线','value': json.HAMMER[j].lineName}];
												for (let i = 0; i < json.HAMMER[j].fRNum.length; i++) {
													data.push({
														'name':'第'+(i+1)+'组规则',
														'value':json.HAMMER[j].fRNum[i],
														'upLimit':json.HAMMER[j].upLimit[i]
													})
												}
												document.querySelector('#detailsTable').GM({
													gridManagerName: 'details',
													supportAutoOrder: false,
													supportDrag: false,
													supportCheckbox: false,
													ajaxData: {"data": data},
													columnData:  [{key: 'name', text: '参数名称'}, {key: 'value', text: '型号/数量'},{key: 'upLimit', text: '适用档距上限'}]
												});
											}
										}
									}
								});
							})
						},
						error: function (errorMsg) {
							alert(errorMsg);
						}
					})
				}
				//打开本地map文件
				window.upmapfile = function () {
					var mapfileObj = document.getElementById("TLmapfile").files[0]; // js 获取文件对象
					console.log(mapfileObj);
					var mapform = new FormData(); // FormData 对象
					mapform.append("file", mapfileObj); // 文件对象
					mapform.append("ProjectName", prjName);//控制路径

					$.ajax({
						url: "http://202.114.118.138:8181/UploadfileToJson", //提交的路径
						type: "post",       //提交方式
						data: mapform,    //提交的数据
						// dataType:"json",
						contentType: false, // 告诉jQuery不要去设置Content-Type请求头
						processData: false,
						success: function (demdata){
							console.log("Mapinfo",demdata);
							savedJson.DEM = demdata;
							DEM = demdata
							drawDEM_whj(DEM);
							//drawGeo(cornerCor);
							//打开本地pwf文件
							window.uppwffile = function() {
								var pwffileObj = document.getElementById("TLpwffile").files[0]; // js 获取文件对象
								console.log(pwffileObj);
								var pwfform = new FormData(); // FormData 对象
								pwfform.append("file", pwffileObj); // 文件对象
								pwfform.append("ProjectName", prjName);//控制路径

								$.ajax({
									url: "http://202.114.118.138:8181/UploadfileToJson", //提交的路径
									type: "post",       //提交方式
									data: pwfform,    //提交的数据
									contentType: false, // 告诉jQuery不要去设置Content-Type请求头
									processData: false,
									success: function(pwfdata){
										console.log(pwfdata);
										alert("已打开排杆文件");
										let towerlist = pwfdata.TOWERLIST;
										let pos = [];
										for (let i = 0; i < towerlist.length; i++) {
											pos.push(new THREE.Vector3(towerlist[i].Distance/10,towerlist[i].High - yMin,0));
											createTower(pos[i]);
										}
									},
									error: function (errorMsg) {
										alert(errorMsg);
									}
								})
							}
						},
						error: function (errorMsg) {
							alert(errorMsg);
						}
					})
				}
			},
			error: function (errorMsg) {
				alert(errorMsg);
			}
		});
	}
	}
	//draw
	{
	/* 预设格网参数 */
	var verSize = 160;var horSize = 300; var ydivision=mp.m_HScale*mp.m_Grid/1000; var xdivision = mp.m_DScale*mp.m_Grid/1000;var Gridsize = mp.m_Grid;
	console.log("initial paremeter",ydivision,xdivision);
	var width,dis,gridHor,gridVer;
	var x = new Array();var y = new Array();
	var leftX = new Array();var leftY = new Array();
	var rightX = new Array();var rightY = new Array();
	var yMin = 100;var yMax = verSize;var xMax = 0; var xMin =0 ;
	var framegroup = new THREE.Group();
	let l_linegroup=new THREE.Group();let m_linegroup=new THREE.Group();let r_linegroup=new THREE.Group();
	//	let l_pointsgroup=new THREE.Group();let m_pointsgroup=new THREE.Group();let r_pointsgroup=new THREE.Group();
	let DEM_pgroup=new THREE.Group();
	var allChildren = [];var dem = [];	var towerList = [];
	var leftLineCor,rightLineCor,midLineCor,cornerCor;
	var corner = new Array();
	var show = true;
	var centerDem;//中心断面
	var mainCanvas = document.querySelector("#iframe_box canvas");//画布
	var DEM;

	//线、气象条件初始默认值
	var UseLine = prk.CONDUCTOR[0];
	var UseWeather = prk.WEATHER[0];
	var section = prk.SECTION[0];

	var theLine = UseLine,theWeather = UseWeather;
	var designLine = 1;
	var xmin = 0; var xmax = 0;

		//清空当前画布
	function reclear(){
		for (let i = 0; i < allChildren.length; i++){
			framegroup.remove(allChildren[i]);
		}
		for (let i = 0; i < scene.children.length; i++){
			if (scene.children[i].name === "dem"||scene.children[i].name === "corner"){
				dem.push(scene.children[i]);
			}
			if (scene.children[i].name === "fixTower"||scene.children[i].name === "fixwire1" || scene.children[i].name === "fixwire2" ||scene.children[i].name === "fixwire3"||scene.children[i].name === "fixwire4"){
				towerList.push(scene.children[i]);
			}
		}
		for (let i = 0; i < dem.length; i++) {
			scene.remove(dem[i]);
		}
		for (let i = 0; i < towerList.length; i++) {
			scene.remove(towerList[i]);
		}
	}
	/* 将读取结果保存为坐标数组*/
	var midCoordinate = new Array();
	var leftCoordinate = new Array();
	var rightCoordinate = new Array();

	/* 新建图幅 */
	$("#creatMap").click(function () {
		MapFileName = prompt("新建MAP名称");
		console.log(MapFileName);

		for (let i = 0; i < scene.children.length; i++){
			if (scene.children[i].name === "dem"||scene.children[i].name === "corner"){
				dem.push(scene.children[i]);
			}
			if (scene.children[i].name === "fixTower"||scene.children[i].name === "wire"){
				towerList.push(scene.children[i]);   //capital
			}
		}
		for (let i = 0; i < dem.length; i++) {
			scene.remove(dem[i]);
		}
		for (let i = 0; i < towerList.length; i++) {
			scene.remove(towerList[i]);
		}
		for (let i = 0; i < allChildren.length; i++) {
			framegroup.remove(allChildren[i]);
		}
		console.log("createMapFrame",mp);
		yMin = 100; ydivision= 10; xdivision =100; verSize = 220;horSize =300; Gridsize =10;    //先设大小   再按distance/length 比例尺绘制
		window.initContent();
		mainCanvas = document.querySelector("#iframe_box canvas");
		console.log(mainCanvas);

	})

	/* 默认关闭图纸参数和排杆设置框 */
	$(".frame_settings").hide();
	$(".tower_settings").hide();
	$("#exitBtn").click(function () {
		$(".frame_settings").hide();
	})
	$("#closeBtn").click(function () {
		$(".tower_settings").hide();
	})
	$("#menu-comments").click(function () {
		$(".frame_settings").show();
	})

	//图幅参数调整
	window.confirmOk = function() {
		width = $("#frameWid").val();
		dis = $("#sumDis").val();
		verSize = width * 150 /500;
		horSize = dis/10;
		for (let i = 0; i < allChildren.length; i++){
			framegroup.remove(allChildren[i]);
		}
		framegroup.remove(framegroup.children);
		window.initContent();
	}

	var scene, camera, renderer, controls, labelRenderer;
	var cameraX = 0 , cameraY = 0 , cameraZ=250;
	var sceneX = 0 , sceneY = 0, sceneZ = 0;
	var canvasdiv = document.getElementById('iframe_box');
	console.log(canvasdiv.offsetWidth);
	/* 场景 */
	function initScene() {
		scene = new THREE.Scene();
	}
	/* 相机 */
	var fov = 45;
	var near = 0.1;
	var far = 10000;  //  variable parameter by graph
	function initCamera() {
		camera = new THREE.PerspectiveCamera(fov, canvasdiv.offsetWidth / canvasdiv.offsetHeight, near, far);
		camera.position.set(cameraX, cameraY, cameraZ);
		camera.up.set(0,1,0);
		camera.lookAt(new THREE.Vector3(sceneX, sceneY, sceneZ));
	}
	/* 渲染器 */
	function initRender() {
		renderer = new THREE.WebGLRenderer({antialias: true});
		renderer.setSize(canvasdiv.offsetWidth, canvasdiv.offsetHeight);
		renderer.setClearColor(0xffffff,1.0);
		renderer.sortObjects = false; //渲染顺序按照add 顺序

		document.getElementById('iframe_box').appendChild(renderer.domElement);
		labelRenderer = new CSS2DRenderer();//文本二维渲染器
		labelRenderer.setSize( canvasdiv.offsetWidth, canvasdiv.offsetHeight);
		labelRenderer.domElement.style.position = 'absolute';
		labelRenderer.domElement.style.top = '0px';
		document.getElementById('iframe_box').appendChild( labelRenderer.domElement );
	}
	/* 灯光 */
	function initLight() {
		var ambientLight = new THREE.AmbientLight(0x333333);
		scene.add(ambientLight);
		var directionalLight = new THREE.DirectionalLight(0xffffff, 1);
		directionalLight.position.set(100, 300, 200);
		scene.add(directionalLight);
	}
	/* 文本标注：文本内容/文本颜色/textpos/spritepos/旋转角度 */
	function  createSprite(text,color,x,y,posx,posy,rotate) {
		let canvas = document.createElement("canvas");
		let ctx = canvas.getContext("2d");
		ctx.fillStyle = color;
		ctx.font = "22px Arial";
		ctx.fillText(text,x,y);
		let texture = new THREE.Texture(canvas);
		texture.needsUpdate = true;
		let material = new THREE.SpriteMaterial({map:texture,transparent:true,rotation:rotate});
		let textObj = new THREE.Sprite(material);//使用Sprite显示文字
		textObj.scale.set(40, 20, 1);
		textObj.position.set(posx, posy , 0);
		return textObj;
	}

	/* 图幅格网绘制 */
	window.initContent= function() {


		for (let i = 0; i < allChildren.length; i++){
			framegroup.remove(allChildren[i]);
		}
		// 外侧区域用white block 遮挡
		//draw white plan
		let left_block_geo =  new THREE.PlaneGeometry(5000,5000);
		let left_block_mat = new THREE.MeshBasicMaterial({color:0xffffff});
		let left_block =  new THREE.Mesh(left_block_geo,left_block_mat);
		//left_block.position.z = 100;
		left_block.position.verticesNeedUpdate =  true;
		left_block.position.x = -left_block.geometry.parameters.width/2;
		left_block.position.y =verSize/2;
		framegroup.add(left_block);
		let right_block_geo =  new THREE.PlaneGeometry(5000,5000);
		let right_block_mat = new THREE.MeshBasicMaterial({color:0xffffff});
		let right_block =  new THREE.Mesh(right_block_geo,right_block_mat);
		//right_block.position.z = 100;
		right_block.position.verticesNeedUpdate =  true;
		right_block.position.x =horSize+right_block.geometry.parameters.width/2;
		right_block.position.y = verSize/2;
		framegroup.add(right_block);

		//外轮廓
		var gridBound = new THREE.PlaneGeometry(horSize +30,verSize + mp.m_Frame[14]  );  //30 parameter replace?
		var material = new THREE.LineBasicMaterial({ color: 0x0000ff});
		var grid = new THREE.Mesh(gridBound,material);
		grid.position.x =(horSize -30)/2;
		grid.position.y = (verSize - mp.m_Frame[14])/2;
		var box = new THREE.BoxHelper( grid, 0x0000ff );
		framegroup.add(box);
		//居中
		var bbox = new THREE.Box3().setFromObject(box)
		cameraX = (bbox.max.x - bbox.min.x)/2;
		cameraY = (bbox.max.y + bbox.min.y)/2;
		console.log(cameraY);
		sceneX = cameraX; sceneY = cameraY;
		if (horSize >= verSize){cameraZ = (horSize - verSize)/2 + verSize + 120; }
		if (horSize < verSize){cameraZ = (verSize - horSize)/2 + horSize + 120; }
		camera.position.set(cameraX, cameraY, cameraZ);
		camera.lookAt(new THREE.Vector3(sceneX, sceneY, sceneZ));

		//左侧坐标轴
		var yAxisGeo = new THREE.Geometry();
		yAxisGeo.verticesNeedUpdate = true;
		yAxisGeo.vertices.push(new THREE.Vector3(-4,mp.m_Frame[9]-mp.m_Frame[14], 0));
		yAxisGeo.vertices.push(new THREE.Vector3(-4, verSize, 0));
		var yAxis = new THREE.Line(yAxisGeo, new THREE.LineBasicMaterial({
			color: 0xff0000
		}));
		framegroup.add(yAxis);

		//左侧高程刻度线
		var scalelineGeo = new THREE.Geometry();
		scalelineGeo.verticesNeedUpdate = true;
		scalelineGeo.vertices.push(new THREE.Vector3(-5,0,0));
		scalelineGeo.vertices.push(new THREE.Vector3(-4,0,0));
		for (let i = 0; i < verSize / Gridsize ; i++) {
			var scaleline = new THREE.Line(scalelineGeo,new THREE.LineBasicMaterial({color: 0x455454}));
			scaleline.position.y= i * Gridsize;
			framegroup.add(scaleline);
			var number = yMin+ i*ydivision;
			var text = number.toString();
			var scale = createSprite(text,"#000000",0,32,9,i * Gridsize-5,0);
			scale.name = "gaochengscale";
			framegroup.add(scale);
		}

		//横格网轴
		var horGeometry = new THREE.Geometry();
		horGeometry.verticesNeedUpdate = true;
		horGeometry.vertices.push(new THREE.Vector3(0, 0, 0)); //添加顶点
		horGeometry.vertices.push(new THREE.Vector3(horSize , 0, 0));
		var horizonGeo = new THREE.Geometry();
		horizonGeo.vertices.push(new THREE.Vector3(-30, 0, 0)); //添加顶点
		horizonGeo.vertices.push(new THREE.Vector3(horSize, 0, 0));

		if(mp.m_ShowMainGrid){
			for (var i = 0, len = verSize /Gridsize ; i <= len; i++) {
					gridHor = new THREE.Line(horGeometry, new THREE.LineBasicMaterial({color: 0x455454}));//用geometry和material创建line
					gridHor.position.y = i * Gridsize ; //设置line的位置
					gridHor.name = "gridHor";
					framegroup.add(gridHor);
			}
		}
		for(let j = 0; j<9;j++){
			var plangrid =  gridHor.clone();
			plangrid.name = "plangrid"+j.toString();
			plangrid.position.y=-(mp.m_Frame[14]-mp.m_Frame[j]);
			framegroup.add(plangrid);
		}

		var line = new THREE.Line(horizonGeo, new THREE.LineBasicMaterial({color: 0x455454}));
		line.position.y = - (mp.m_Frame[14]-mp.m_Frame[9]); //设置line的位置

		var gaocheng = createSprite(mp.m_HighSystem,"#ff0000",0,32,4.5,-55,Math.PI/2); //高程坐标系标签 位置自适应
		framegroup.add(gaocheng);
		var planLine = line.clone();//平面图下边界
		planLine.position.y = -(mp.m_Frame[14]-mp.m_Frame[5]);
		var planeText = createSprite("平面图","#ff0000",0,100,1.5,(line.position.y+planLine.position.y)/2,0);  //100 mframe[]
		framegroup.add(planeText);
		var textArr = ["            桩间距离","               里程","               档距","            杆塔位置","   耐张段长/代表档距"];
		for (let j = 4; j >=0 ; j--) {
			var disLine = line.clone();//桩间距离下边界
			disLine.position.y = -(mp.m_Frame[14]-mp.m_Frame[j]);
			framegroup.add(disLine);
			var note = createSprite(textArr[4-j],"#ff0000",0,60,-10,-(mp.m_Frame[14]-mp.m_Frame[j]),0);
			framegroup.add(note);
		}
		framegroup.add(planLine);
		framegroup.add(line);

		//纵格网轴
		var verGeometry = new THREE.Geometry();
		verGeometry.vertices.push(new THREE.Vector3(0, 0, 0)); //添加顶点
		verGeometry.vertices.push(new THREE.Vector3(verSize , 0, 0));
		var verBound = new THREE.Geometry();
		verBound.vertices.push(new THREE.Vector3(-mp.m_Frame[14], 0, 0)); //添加顶点
		verBound.vertices.push(new THREE.Vector3(verSize , 0, 0));
		var planGeo = new THREE.Geometry();
		planGeo.vertices.push(new THREE.Vector3(0,mp.m_Frame[8]-mp.m_Frame[14], 0)); //添加顶点
		planGeo.vertices.push(new THREE.Vector3(0, mp.m_Frame[6]-mp.m_Frame[14], 0));
		verGeometry.verticesNeedUpdate = true;
		verBound.verticesNeedUpdate = true;
		for (var i = 0, len = horSize / Gridsize; i < len; i++) {
			gridVer = new THREE.Line(verGeometry, new THREE.LineBasicMaterial({color: 0x324132}));
			var boundary = new THREE.Line(verBound, new THREE.LineBasicMaterial({color: 0x324132}));
			if (i === 0){
				boundary.position.x = i * Gridsize ;
				boundary.rotation.z = Math.PI / 2; //绕y轴旋转90度
				framegroup.add(boundary);
			}
			else {
				if(mp.m_ShowMainGrid){
					gridVer.position.x = i * Gridsize ;
					gridVer.rotation.z = Math.PI / 2; //绕y轴旋转90度
					gridVer.name="gridVer";
					framegroup.add(gridVer);
				}
			}
			var planVer = new THREE.Line(planGeo, new THREE.LineBasicMaterial({color: 0x324132}));
			planVer.name = "gridVer";
			planVer.position.x = i*Gridsize;
			//planVer.position.y = -(mp.m_Frame[14]-mp.m_Frame[]);
			framegroup.add(planVer);
			let x = createSprite((xMin+i*xdivision)/1000,"#ff0000",0,100,19+i*Gridsize,mp.m_Frame[4]-mp.m_Frame[14],0);

			framegroup.add(x);
		}
		//
		if(mp.m_SignFrame){
			console.log("mp signFrame show");
			var SignGeo = new THREE.Geometry();
			SignGeo.vertices.push(new THREE.Vector3(0,0,0)); //添加顶点
			SignGeo.vertices.push(new THREE.Vector3(70, 0, 0));
			var SignFrame = new THREE.Line(SignGeo, new THREE.LineBasicMaterial({color: 0x324132}));
			for(let i=0 ;i<5;i++){
				let SignFrame_hor = SignFrame.clone();
				SignFrame_hor.position.x = horSize-70;
				SignFrame_hor.position.y = verSize-10*i;
				framegroup.add(SignFrame_hor);
			}
			var SignGeo = new THREE.Geometry();
			SignGeo.vertices.push(new THREE.Vector3(0,0,0)); //添加顶点
			SignGeo.vertices.push(new THREE.Vector3(0, -40, 0));
			var SignFrame = new THREE.Line(SignGeo, new THREE.LineBasicMaterial({color: 0x324132}));
			for(let i=0 ;i<2;i++){
				let SignFrame_ver = SignFrame.clone();
				SignFrame_ver.position.x = horSize-70+i*20;
				SignFrame_ver.position.y = verSize;
				framegroup.add(SignFrame_ver);
			}

			//sprite
			var note = createSprite(" 图号 ","#ff0000",10,60,horSize-30,verSize-10,0);
			note.scale.set(80,40,1);
			framegroup.add(note);
			var note = createSprite(" 组长 ","#ff0000",10,60,horSize-30,verSize-20,0);
			note.scale.set(80,40,1);
			framegroup.add(note);
			var note = createSprite(" 设计 ","#ff0000",10,60,horSize-30,verSize-30,0);
			note.scale.set(80,40,1);
			framegroup.add(note);
			var note = createSprite(" 校核 ","#ff0000",10,60,horSize-30,verSize-40,0);
			note.scale.set(80,40,1);
			framegroup.add(note);


		}


		allChildren = [];
		for (let i = 0; i < framegroup.children.length; i++) {
			allChildren.push(framegroup.children[i]);
		}

		//图纸参数设置框
		$("#frameset").click(function () {
			$(".frame_settings").show();

			width = $("#frameWid").val();
			let index = 0;
			var check = $("#showGrid");//控制格网隐藏
			check.click(function () {
				index ++ ;
				let grid = [];
				for (let i = 0; i<framegroup.children.length; i++){
					if (framegroup.children[i].name === "gridVer"||framegroup.children[i].name === "gridHor") {
						grid.push(framegroup.children[i]);
					}
				}
				if (index % 2 === 1){
					for (let i = 0; i < grid.length; i++) {
						grid[i].material = new THREE.LineBasicMaterial({color: 0xffffff});//隐藏格网
					}
				}
				if (index % 2 === 0){
					for (let i = 0; i < grid.length; i++) {
						grid[i].material = new THREE.LineBasicMaterial({color: 0x324132});//显示格网
					}
				}
			})
		})
		scene.add(framegroup);
	}

	var tempDif = 0;
	var dif = 0;
	/* DEM绘制函数 */
	window.drawDEM_whj=function (DEM){
		if(m_linegroup.children.length!=0){

			// for ( let i = 0; i < m_linegroup.children.length; i ++ ) {
			//
			// 	const object = m_linegroup.children[ i ];
			//
			// 	object.parent = null;
			//
			// 	//object.dispatchEvent( _removedEvent );
			// }
			m_linegroup.children.length = 0;    //清空group   clear（）not defined  altered
		}
		if(r_linegroup.children.length!=0){r_linegroup.children.length = 0;}
		if(l_linegroup.children.length!=0){l_linegroup.children.length = 0;}
		if(DEM_pgroup.children.length!=0){DEM_pgroup.children.length = 0;}
		

		// if(l_linegroup.children.length!=0){l_linegroup.clear();}
		// if(r_linegroup.children.length!=0){r_linegroup.clear();}
		// if(DEM_pgroup.children.length!=0){DEM_pgroup.clear();}

		console.log(DEM);
		console.log(DEM.MID,DEM.LEFT,DEM.RIGHT);
		yMin=DEM.MID[0].Section[0].z
		for(let i=0;i<DEM.MID.length;i++){
			for(let j=0;j<DEM.MID[i].Section.length;j++){
				if(yMax<DEM.MID[i].Section[j].z){yMax=DEM.MID[i].Section[j].z;}
				if(yMin>DEM.MID[i].Section[j].z){yMin=DEM.MID[i].Section[j].z;}
			}
		}
		for(let i=0;i<DEM.LEFT.length;i++){
			for(let j=0;j<DEM.LEFT[i].Section.length;j++){
				if(yMax<DEM.LEFT[i].Section[j].z){yMax=DEM.LEFT[i].Section[j].z;}
				if(yMin>DEM.MID[i].Section[j].z){yMin=DEM.MID[i].Section[j].z;}
			}
		}
		for(let i=0;i<DEM.RIGHT.length;i++){
			for(let j=0;j<DEM.RIGHT[i].Section.length;j++){
				if(yMax<DEM.RIGHT[i].Section[j].z){yMax=DEM.RIGHT[i].Section[j].z;}
				if(yMin>DEM.MID[i].Section[j].z){yMin=DEM.MID[i].Section[j].z;}
			}
		}

		//起算标记  向下取整
		yMin =  (parseInt(yMin/ydivision))*ydivision;
		xMin =  (parseInt(xMin/xdivision))*xdivision;
		xMax = parseInt(DEM.RIGHT[DEM.RIGHT.length-1].Section[DEM.RIGHT[DEM.RIGHT.length-1].Section.length-1].x);


			//tempDif = yMax - yMin;
		//dif = (parseInt((yMax - yMin)/10) + 2 ) * 10;

		// xMax = parseInt(DEM.RIGHT[DEM.RIGHT.length-1].Section[DEM.RIGHT[DEM.RIGHT.length-1].Section.length-1].x); //X last element
		// horSize = xMax/xdivision*Gridsize;      //+add  border
		// verSize = (yMax - yMin)/ydivision*Gridsize;  //+add  border

		console.log(horSize,verSize,xdivision,ydivision,xMin,yMin,Gridsize,"frame");    //坐标系转换


		// draw object group;
		// 中心断面 object
		var m_material = new THREE.LineBasicMaterial( { color: 0x000000 } );
		var mp_material = new THREE.PointsMaterial({color:0x888888,size:2.0});
		var m_line = new Array();
		var m_points=new Array();
		//m_line.length=DEM.MID.length;
		for(let i=0;i<DEM.MID.length;i++){
			var m_vertice = new THREE.Geometry();
			for(let j=0;j<DEM.MID[i].Section.length;j++) {
				m_vertice.vertices.push(new THREE.Vector3((DEM.MID[i].Section[j].x - xMin)/ xdivision*Gridsize, (DEM.MID[i].Section[j].z - yMin)/ydivision*Gridsize, 0));
			}
			m_line[i]= new THREE.Line(m_vertice,m_material);m_line[i].name = "MID"+"-"+i.toString();
			m_points[i] = new THREE.Points(m_vertice,mp_material);
			m_points[i].visible=false;
			m_linegroup.add(m_line[i]);
			DEM_pgroup.add(m_points[i]);
		}
		scene.add(m_linegroup);
		//scene.add(DEM_pgroup);


		var l_material = new THREE.LineDashedMaterial( { color: 0x0000ff ,dashSize:3, gapSize:1} );
		var lp_material = new THREE.PointsMaterial({color:0x888888,size:2.0});
		var l_line = new Array();
		var l_points= new Array();
		l_line.length=DEM.LEFT.length;
		for(let i=0;i<DEM.LEFT.length;i++){
			var l_vertice = new THREE.Geometry();
			for(let j=0;j<DEM.LEFT[i].Section.length;j++) {
				l_vertice.vertices.push(new THREE.Vector3((DEM.LEFT[i].Section[j].x -xMin)/ xdivision*Gridsize, (DEM.LEFT[i].Section[j].z - yMin)/ydivision*Gridsize, 0));
			}
			l_line[i]= new THREE.Line(l_vertice,l_material);l_line[i].name = "LEFT"+"-"+i.toString();
			l_line[i].computeLineDistances(); //for DashedMaterial
			l_linegroup.add(l_line[i]);
			l_points[i] = new THREE.Points(l_vertice,lp_material);
			l_points[i].visible=false;
			DEM_pgroup.add(l_points[i]);
		}
		scene.add(l_linegroup);
		//scene.add(DEM_pgroup);

		var r_material = new THREE.LineDashedMaterial( { color: 0x00ff00,dashSize:2,gapSize:2 } );
		var rp_material = new THREE.PointsMaterial({color:0x888888,size:2.0});
		var r_line = new Array();
		var r_points= new Array();
		r_line.length=DEM.RIGHT.length;
		for(let i=0;i<DEM.RIGHT.length;i++){
			var r_vertice = new THREE.Geometry();
			for(let j=0;j<DEM.RIGHT[i].Section.length;j++) {
				r_vertice.vertices.push(new THREE.Vector3((DEM.RIGHT[i].Section[j].x-xMin) / xdivision*Gridsize, (DEM.RIGHT[i].Section[j].z - yMin)/ydivision*Gridsize, 0));
			}
			r_line[i]= new THREE.Line(r_vertice,r_material);r_line[i].name = "RIGHT"+"-"+i.toString();
			r_line[i].computeLineDistances(); //for DashedMaterial
			r_linegroup.add(r_line[i]);
			r_points[i] = new THREE.Points(r_vertice,rp_material);
			r_points[i].visible=false;
			DEM_pgroup.add(r_points[i]);
		}
		scene.add(r_linegroup);
		scene.add(DEM_pgroup);

	}
	function drawDEM(leftLineCor,rightLineCor,midLineCor,cornerCor){

		for (let i = 0; i < allChildren.length; i++){
			framegroup.remove(allChildren[i]);
		}
		midCoordinate.length = midLineCor.length;
		leftCoordinate.length = leftLineCor.length;
		rightCoordinate.length = rightLineCor.length;
		console.log(rightCoordinate.length);
		// midCoordinate.length =leftCoordinate.length = rightCoordinate.length =midLineCor.length;
		for (let i = 0 ; i < midCoordinate.length ; i++){
			midCoordinate[i] = new Array();
			midCoordinate[i][0] = midLineCor[i].x;midCoordinate[i][1] = midLineCor[i].z;midCoordinate[i][2] = 0 ;
		}
		for (let i = 0 ; i < leftCoordinate.length ; i++){
			leftCoordinate[i] = new Array();
			leftCoordinate[i][0] = leftLineCor[i].x;leftCoordinate[i][1] = leftLineCor[i].z;leftCoordinate[i][2] = 0 ;
		}
		for (let i = 0 ; i < rightCoordinate.length ; i++){
			rightCoordinate[i] = new Array();
			rightCoordinate[i][0] = rightLineCor[i].x;rightCoordinate[i][1] = rightLineCor[i].z;rightCoordinate[i][2] = 0 ;
		}

		x.length = midCoordinate.length;
		y.length = midCoordinate.length;
		for (let i = 0 ; i <midCoordinate.length ; i++){
			x[i] = midCoordinate[i][0];y[i] = midCoordinate[i][1];
		}
		for (let i = 0 ; i <leftCoordinate.length ; i++){
			leftX[i] = leftCoordinate[i][0];leftY[i] = leftCoordinate[i][1];
		}
		for (let i = 0 ; i <rightCoordinate.length ; i++){
			rightX[i] = rightCoordinate[i][0];rightY[i] = rightCoordinate[i][1];
		}
		//


		yMax = Math.max.apply(Math,y);
		yMin = Math.min.apply(Math,y);
		var leftYmin = Math.min.apply(Math,leftY);
		var rightYmin = Math.min.apply(Math,rightY);
		tempDif = yMax - yMin;
		dif = (parseInt((yMax - yMin)/10) + 2 ) * 10;
		verSize = dif ;
		xMax = (parseInt(x[x.length - 1]/10) + 1 ) * 10;
		horSize = xMax/10;

		window.initContent();
		// 中心断面 object
		// var c_material = new THREE.LineBasicMaterial( { color: 0x000000 } );
		// var c_lineframegroup = new Array();
		// for(let i=0;i<DEM.MID.size();i++){
		// 	var c_vertice = new THREE.Geometry();
		// 	for(let j=0;j<DEM.MID[i].section.size;j++) {
		// 		c_vertice.vertices.push(new THREE.Vector3(DEM.MID[i].section[j].x / 10, DEM.MID[i].section[j].z - yMin, 0));
		// 	}
		// 	var  c_line= new THREE.Line(c_vertice,c_material);c_line.name = "Section"+i.toString();
		// 	c_lineframegroup.push(c_line);
		// 	scene.add(c_line);
		// }
		//
		// consolo.log(c_linegroup);

		/* 中心断面绘制 */
		var material = new THREE.LineBasicMaterial( { color: 0x000000 } );
		var centerDemGeo = new THREE.Geometry();
		for (let i = 0 ; i <midCoordinate.length ; i++){
			centerDemGeo.vertices.push(new THREE.Vector3(midCoordinate[i][0]/10,midCoordinate[i][1]-yMin,0));
		}
		/* 左断面绘制 */
		var leftMaterial = new THREE.LineDashedMaterial({color:0x0000ff, dashSize:3, gapSize: 1});
		var leftDemGeo = new THREE.Geometry();
		for (let i = 0 ; i <leftCoordinate.length ; i++){
			leftDemGeo.vertices.push(new THREE.Vector3(leftCoordinate[i][0]/10,leftCoordinate[i][1]-leftYmin,0));
		}
		/* 右断面绘制 */
		var rightMaterial = new THREE.LineDashedMaterial({color:0x00ff00, dashSize: 2, gapSize: 2});
		var rightDemGeo = new THREE.Geometry();
		for (let i = 0 ; i <rightCoordinate.length ; i++){
			rightDemGeo.vertices.push(new THREE.Vector3(rightCoordinate[i][0]/10,rightCoordinate[i][1]-rightYmin,0));
		}
		centerDem = new THREE.Line( centerDemGeo, material );centerDem.name = "dem";
		var leftDem = new THREE.Line(leftDemGeo,leftMaterial);leftDem.name = "dem";
		leftDem.computeLineDistances();
		var rightDem = new THREE.Line(rightDemGeo,rightMaterial);rightDem.name = "dem";
		rightDem.computeLineDistances();
		scene.add( centerDem );scene.add(leftDem);scene.add(rightDem);
	}
	/* 转角投影线绘制函数 */
	window.drawGeo= function (cornerCor){
		console.log(cornerCor,xMax);
		for(let i = 0 ;i<scene.children.length;i++){
			if(scene.children[i].name == "ProjectLine"){scene.remove(scene.children[i]);}
		}
		var cornerMaterial = new THREE.LineBasicMaterial({color:0xff0000});
		let GeoGroup = new THREE.Group();
		GeoGroup.name ="ProjectLine"
		for (let i = 0 ; i <cornerCor.length ; i++){
			if(cornerCor[i].dist>=xMin&&cornerCor[i].dist<=xMax+1){
				var cornerGeo = new THREE.Geometry();
				console.log("yMin",yMin);
				cornerGeo.vertices.push(new THREE.Vector3((cornerCor[i].dist-xMin)/xdivision*Gridsize,(cornerCor[i].z-yMin)/ydivision*Gridsize,0));
				cornerGeo.vertices.push(new THREE.Vector3((cornerCor[i].dist-xMin)/xdivision*Gridsize,mp.m_Frame[9]-mp.m_Frame[14],0));
				var cornerLine = new THREE.Line(cornerGeo,cornerMaterial);cornerLine.name = "cornerLine-"+i.toString();
				// console.log(cornerLine);
				GeoGroup.add(cornerLine);
			}
		}
		scene.add(GeoGroup);
	}

	$('#inputCorner').click(function () {
		/* 转角投影线绘制 */
		console.log(pile_tabledata,scene);
		drawGeo(pile_tabledata);
	})

		/* 悬链线相关函数 */ 
		window.ComputeLoad = function() {
			var a0=1;							//风压不均匀系数
			var p=1.2255;						//空气密度 ρ
			var g=9.80665;						//重力加速度 ｍ/ｓ^2
			var Usc = 1.0;						//体型系数
			var B =   1.0;						//覆冰时风荷载增大系数
			var Uz =  1.0;						//风速高度变化系数
			var Bc =  1.0;						//风荷载调整系数βc

			for (let i = 0; i < theWeather.num; i++) {
				let v = theWeather.TWI[i].v; //风速
				let b = theWeather.TWI[i].b; //覆冰
				//体型系数取值
				if (b>0 || theLine.d < 17.0){
					Usc = 1.2;
				}
				else {Usc = 1.1;}

				//风速高度变化系数取值
				if (i == 3){
					Uz = Math.pow(theWeather.h / 10, theWeather.alfa * 2);
				}else {
					Uz = 1;
				}

				//覆冰时风荷载增大系数取值
				if (b==5) B = 1.1;
				else if (b ==10) B = 1.2;
				else if (b == 15) B = 1.3;
				else if (b >= 20) B = 1.5;
				else B = 1;

				//风压不均匀系数及风荷载调整系数取值
				if (designLine ==1){
					if (v<20) a0 =1;
					else if (v >= 20&&v<27) a0 = 0.85;
					else if (v>= 27&&v<31.5) a0 = 0.75;
					else a0 = 0.70;
				}
				else if(designLine == 0){
					if (v<20) a0 =1;
					else if (v >= 20&&v<27) a0 = 0.75;
					else if (v>= 27) a0 = 0.61;
				}
				else if (designLine > 10){
					if(designLine<=200)
						a0 = 0.80;
					else if(designLine>200 && designLine<=250)
						a0= 0.80 -(designLine-200)/50*(0.80-0.74);
					else if(designLine>250 && designLine<=300)
						a0 =0.74 -(designLine-250)/50*(0.74-0.70);
					else if(designLine >300 && designLine<=350)
						a0 =0.70 -(designLine-300)/50*(0.70-0.67);
					else if(designLine >350 && designLine<=400)
						a0 =0.67 -(designLine-350)/50*(0.67-0.65);
					else if(designLine >400 && designLine<=450)
						a0 =0.65 -(designLine-400)/50*(0.65-0.63);
					else if(designLine >450 && designLine<=500)
						a0= 0.63 -(designLine-450)/50*(0.63-0.62);
					else if(designLine >500 && designLine<550)
						a0 =0.62 -(designLine-500)/50*(0.62-0.61);
					else if(designLine >=550)
						a0 = 0.61;
				}

				theWeather.TWI[i].P1 = theLine.p1*g;										//自荷载
				theWeather.TWI[i].P2 = 0.9*Math.PI*b*(b+theLine.d)*g*1E-3;						//冰荷载
				theWeather.TWI[i].P3 = theWeather.TWI[i].P1+theWeather.TWI[i].P2;			//自荷载加冰荷载
				theWeather.TWI[i].P4 = a0*v*v/1600*Uz*Usc*Bc*theLine.d ;					//无冰风荷载
				theWeather.TWI[i].P5 = a0*v*v/1600*Uz*Usc*Bc*(theLine.d+2*b)*B;			//覆冰时风荷载
				theWeather.TWI[i].P6 = Math.sqrt(theWeather.TWI[i].P1 * theWeather.TWI[i].P1 + theWeather.TWI[i].P4 * theWeather.TWI[i].P4);							//无冰时综合荷载
				theWeather.TWI[i].P7 = Math.sqrt(theWeather.TWI[i].P3 * theWeather.TWI[i].P3 + theWeather.TWI[i].P5 * theWeather.TWI[i].P5);
				theWeather.TWI[i].angle = Math.atan(theWeather.TWI[i].P5/theWeather.TWI[i].P3);	//风偏角的弧度值
				theWeather.TWI[i].angle = theWeather.TWI[i].angle/Math.PI *180.0;				//风偏角的度数值βο
			}
		}
		window.initializeData = function(UseWeather,UseLine,u,lineDesign){
			theWeather = UseWeather;
			theLine =    UseLine;
			if (theLine.type!= 0){
				// theWeather.TWI[4].b = theWeather.TWI[4].b + prk.PRIMARY.dIce;(出错地点）
				theWeather.TWI[4].b = 5 + prk.PRIMARY.dIce;
			}
			theLine.F = theLine.F/u;
			theLine.S_p = theLine.Tp*theLine.k/theLine.A;
			theLine.S_m = theLine.S_p/theLine.F;
			theLine.S_a = theLine.S_p * theLine.C;

			theWeather.h = prk.PRIMARY.windH;
			theWeather.alfa =prk.PRIMARY.alfa;

			designLine = lineDesign;
			ComputeLoad();
		}
		window.FindUsingSection = function(x) {
			x= x+5;
			for(let i=0;i<prk.SECTION.length;i++)
			{
				if(x>=prk.SECTION[i].from && x<=prk.SECTION[i].to)
					return i;
			}
			return -1;
		}
		window.FindUsingLine = function(i) {
			for(let j=0;i >-1 && j<prk.CONDUCTOR.length;j++)
			{
				if(prk.SECTION[i].powerLine==prk.CONDUCTOR[j].name)
					return j;
			}
			return -1;
		}
		window.FindUsingGLine = function(i) {
			for(let j=0;i >-1 && j<prk.CONDUCTOR.length;j++)
			{
				if(prk.SECTION[i].groundLine==prk.CONDUCTOR[j].name)
					return j;
			}
			return -1;
		}
		window.FindUsingWeather = function(i) {
			for(let j=0;i >-1 && j<prk.WEATHER.length;j++)
			{
				if(prk.SECTION[i].wertherName == prk.WEATHER[j].name)
					return j;
			}
			return -1;
		}
		window.FindTower = function(tower){
			for(let i=0;i<prk.TOWER.length;i++)
			{
				if(tower.TowerType==prk.TOWER[i].Name
						&& tower.TowerHigh>=prk.TOWER[i].StartHigh && tower.TowerHigh<=prk.TOWER[i].EndHigh)
					return i;
			}
			return -1;
		}
		window.initializeDataBool = function(x,u,isPower,designLine){
			UseLine = prk.CONDUCTOR[0];
			UseWeather = prk.WEATHER[0];
			section = prk.SECTION[0];
			let l = 0,w=0,gl = 0,SectionNo = 0;
			SectionNo = FindUsingSection(x);
			if (SectionNo <0) return false;
			section = prk.SECTION[SectionNo];
			if (isPower){
				l = FindUsingLine(SectionNo);
				if(l<0)	return false;
				UseLine = prk.CONDUCTOR[l];
				UseLine.k = section.pLineK;
				UseLine.F = section.pLineF;
				UseLine.C = section.pLineC;
			}
			else {
				l = FindUsingGLine(SectionNo);
				if(l<0) return false;
				UseLine = prk.CONDUCTOR[l];
				UseLine.k = section.gLineK;
				UseLine.F = section.gLineF;
				UseLine.C = section.gLineC;
			}

			w = FindUsingWeather(SectionNo);
			if(w<0) return false;
			UseWeather = prk.WEATHER[w];

			initializeData(UseWeather,UseLine,u,designLine);
			return true;
		}
		window.GetCtlCondition = function(l) {
			let ctrl;
			let max_Fmx = -99999999;
			for (let i = 0; i < theWeather.num && i < 5; i++) {
				if (i === 0){
					theWeather.TWI[i].Fmx = theLine.E * Math.pow(theWeather.TWI[i].P7/theLine.A * l,2)/(24*Math.pow(theLine.S_a,2)) - theLine.S_a - theLine.a * theLine.E * theWeather.TWI[i].t;
				}else {
					theWeather.TWI[i].Fmx = theLine.E * Math.pow(theWeather.TWI[i].P7/theLine.A * l,2.0) / (24.0*Math.pow(theLine.S_m,2.0)) - theLine.S_m - theLine.a*theLine.E* theWeather.TWI[i].t;
				}

				if(theWeather.TWI[i].Fmx>max_Fmx)							//获取当前代表档距下的控制条件
				{
					max_Fmx = theWeather.TWI[i].Fmx;
					ctrl = i;
				}
			}
			return ctrl;
		}
		window.GetStrain = function(l,cosa,condition) {
			let S = 0;
			let ctrl = GetCtlCondition(l);
			let b,d;
			let Sm,rm,r,E,a;
			if (ctrl == condition){return ctrl == 0?theLine.S_a:theLine.S_m;}
			if (ctrl == 0){Sm = theLine.S_a;}
			else Sm = theLine.S_m;
			rm = theWeather.TWI[ctrl].P7/theLine.A;
			E = theLine.E;
			a = theLine.a;
			r = theWeather.TWI[condition].P7/theLine.A;
			b = Sm - rm*rm*l*l*E*Math.pow(cosa,3)/(24*Sm*Sm) + a*E*cosa*(theWeather.TWI[ctrl].t - theWeather.TWI[condition].t);
			d = r*r*l*l*E*Math.pow(cosa,3)/24;
			S = GetEquationValue(1,-b,0,-d,9999);
			return S;
		}
		window.GetEquationValue = function(a,b,c,d,maxX) {
			let A,B,C,delta;
			let x0=0,x1,x2,x3;
			let zero = 1E-4;
			A = b*b-3.0*a*c;
			B = b*c -9.0*a*d;
			C = c*c - 3.0*b*d;
			delta = B*B - 4*A*C;
			if(Math.abs(A-B)<zero && Math.abs(A)<zero)
				x0 = -b/3.0/a;
			else if(Math.abs(delta)<zero)
			{
				let K;
				K = B/A;
				x1 = -b/a+K;
				x2 = -K/2.0;

				if(x1>0 && x1<=maxX)
					x0 = x1;
				else if(x2>0 && x2<=maxX)
					x0 = x2;
			}
			else if(delta>0)
			{
				let Y1,Y2;
				Y1 = A*b + 3.0*a*(-B+Math.sqrt(delta))/2.0;
				Y2 = A*b + 3.0*a*(-B-Math.sqrt(delta))/2.0;
				let t1 = Math.pow( Math.abs(Y1) ,1.0/3.0 );
				let t2 = Math.pow( Math.abs(Y2) ,1.0/3.0 );
				if(Y1<0) t1 = -t1;
				if(Y2<0) t2 = -t2;
				x0 = ( -b-t1-t2 ) / (3.0*a);

			}
			else if(delta<0)
			{
				let sita,T;
				T = (2.0*A*b-3.0*a*B) / (2.0*Math.pow(A,3.0/2.0));
				sita = Math.acos(T);
				x1 = ( -b-2.0*Math.sqrt(A)*Math.cos(sita/3.0) )/3.0/a;
				x2 = ( -b+Math.sqrt(A)*(Math.cos(sita/3.0)+Math.sqrt(3.0)*Math.sin(sita/3.0)) ) /(3.0*a) ;
				x3 = ( -b+Math.sqrt(A)*(Math.cos(sita/3.0)-Math.sqrt(3.0)*Math.sin(sita/3.0)) ) /(3.0*a) ;
				if(x1>0 && x1<=maxX)
					x0 = x1;
				else if(x2>0 && x2<=maxX)
					x0 = x2;
				else if(x3>0 && x3<=maxX)
					x0 = x3;
			}
			return x0 ;
		}
		window.GetMaxK = function(l,cosa,currentConditon) {
			let ctrl = GetCtlCondition(l) ;
			let S;let max_K = -99999999;
			for (let i = 0; i < 5; i++) {
				S = GetStrain(l,cosa,i);
				if (theWeather.TWI[i].P7 / (2.0*S*theLine.A) >max_K){
					currentConditon = i;
					max_K = theWeather.TWI[i].P7 / (2.0*S*theLine.A);
				}
			}
			return max_K;
		}
		window.GetMinK = function(l,cosa,currentConditon){
			let ctrl = GetCtlCondition(l);								//控制条件序号
			let S;													//应力
			let min_K = 99999999;									//最大K值
			for(let j = 0;j<5;j++)										//气象条件下的电线应力（力学计算P118）
			{
				S = GetStrain(l,cosa,j);								//计算应力
				if(theWeather.TWI[j].P7 / (2.0*S*theLine.A) <min_K)
				{
					currentConditon = j;
					min_K = theWeather.TWI[j].P7 / (2.0*S*theLine.A);
				}
			}
			return min_K;
		}
		window.GetLoad = function(condition,no) {
			if(no==1)
				return theWeather.TWI[condition].P1;
			else if(no==2)
				return theWeather.TWI[condition].P2;
			else if(no==3)
				return theWeather.TWI[condition].P3;
			else if(no==4)
				return theWeather.TWI[condition].P4;
			else if(no==5)
				return theWeather.TWI[condition].P5;
			else if(no==6)
				return theWeather.TWI[condition].P6;
			else if(no==7)
				return theWeather.TWI[condition].P7;
			else
				return 0;
		}
		window.FindInsulate = function(insulateName) {
			if(insulateName=="")
				return -1;
			for(let i=0;i<prk.INSULATE.length;i++)
			{
				if(insulateName==prk.INSULATE[i].name)
					return i;
			}
			return -1;
		}
		window.GetDown2Top = function(towerType) {
			for(let i=0;i<prk.TOWER.length;i++)
			{
				if(prk.TOWER[i].Name==towerType)
					return prk.TOWER[i].upToMid+prk.TOWER[i].upToTop+prk.TOWER[i].minToDown;
			}
			return 0;
		}
		window.ComputeHugeHigh = function() {
			for (let i = m_start; i <= m_end; i++) {
				let down2top = GetDown2Top(towerlist[i].TowerType);
				//计算杆塔的悬点高程
				if(towerlist[i].Status==0)
					towerlist[i].hugeHigh = towerlist[i].High + towerlist[i].Base + towerlist[i].TowerHigh - towerlist[i].InsulatorLength;
				else {
					towerlist[i].hugeHigh = towerlist[i].High + towerlist[i].Base + towerlist[i].TowerHigh;
				}
				//地线悬点高
				towerlist[i].hugeGround = towerlist[i].High + towerlist[i].Base + towerlist[i].TowerHigh + down2top;
			}

			ComputeLk();
			ComputeK2();
			ComputeLhLv();
			ComputeGK2();
		}
		window.ComputeLk = function() {
			let start,end;//耐张段起始转角，终止转角
			let l,x,y,cosb,length,t,cosBk;
			start = m_start;
			end = m_end;
			while (start < m_end){
				end = start + 1;
				if (end < 0) end = m_end;

				length = 0; x = 0; y = 0; t = 0;
				for (let i = start; i < end; i++) {
					length += (towerlist[i+1].Distance - towerlist[i].Distance);//towerlist l2
					cosb = Math.cos(Math.atan((towerlist[i+1].hugeHigh - towerlist[i].hugeHigh)/(towerlist[i+1].Distance - towerlist[i].Distance)));
					t += (towerlist[i+1].Distance - towerlist[i].Distance)/cosb/cosb;
					x += Math.pow((towerlist[i+1].Distance - towerlist[i].Distance),3) * Math.pow(cosb,2);
					y += (towerlist[i+1].Distance - towerlist[i].Distance)/cosb;
				}
				cosBk = y/t;
				if (end - start >1) l = Math.sqrt(x/y) / cosBk;
				else l = length;

				for (let i = start; i < end; i++) {
					towerlist[i].Lk = l;
					towerlist[i].L = length;
					towerlist[i].cosa = cosBk;
					if (((end - start) == 1) && ((towerlist[i+1].Distance - towerlist[i].Distance) <= prk.PRIMARY.InsularMaxL)){
						towerlist[i].bInsular = true;
					}
					else{
						towerlist[i].bInsular = false;
						towerlist[i].constant = 0;
					}
				}
				start = end;//从终止转角继续查找下一个转角
			}
		}
		window.ComputeIsolate = function(t1,t2,k,constA,kMaxT,constMaxT) {
			//风压高度变化系数
			let Kh = Math.pow(prk.PRIMARY.windH/10,prk.PRIMARY.alfa);
			//判别函数值 线长系数 应力 弧垂
			let F = [],K = [],S = [],f = [];
			//档距
			let m_l = t2.Distance-t1.Distance;
			//绝缘子串参数
			let m_length,m_weights,m_weight,m_area;
			//控制应力
			let m_Tav,m_Tmax,m_Ttract;
			//分裂数
			let n = theLine.num;
			let insulateName ;
			if(t1.InsulatePA!="")
				insulateName =t1.InsulatePA;
			else if(t1.InsulatePB!="")
				insulateName =t1.InsulatePB;
			else if(t2.InsulatePA!="")
				insulateName =t2.InsulatePA;
			else if(t2.InsulatePB!="")
				insulateName =t2.InsulatePB;
			let indexIsolate = FindInsulate(insulateName);
			if(indexIsolate !=-1)
			{
				m_length = prk.INSULATE[indexIsolate].Length;
				m_weight = prk.INSULATE[indexIsolate].Weight;
				m_weights = prk.INSULATE[indexIsolate].Weight +prk.INSULATE[indexIsolate].IceWeight*prk.INSULATE[indexIsolate].Num*prk.INSULATE[indexIsolate].Join;
				m_area = prk.INSULATE[indexIsolate].area*prk.INSULATE[indexIsolate].Num*prk.INSULATE[indexIsolate].Join;
			}
			else
			{
				m_length = t1.InsulatorLength;
				m_weight = 200;
				m_weights =300;
				m_area =   1.0;
			}
			m_Tav =  theLine.Tp*theLine.k*theLine.C;
			m_Tmax = theLine.Tp*theLine.k/theLine.F;
			m_Ttract = m_Tmax;
			let bata = Math.atan((t2.hugeHigh-t1.hugeHigh)/m_l);
			let cl0 = m_length*Math.cos(bata);
			let deltaL = 0;
			let A = theLine.A;
			let E = theLine.E;
			let a = theLine.a;
			let g = 9.8;
			let G =0 ;
			let ctrl = 0;
			let ctrlK=0,Fmax=-99999;
			let l1,W1,rb,tz,r,rs,T,aa;
			for(let i=0;i<10;i++)
			{
				r = GetLoad(i,7)/A;
				if(theWeather.TWI[i].b>0)
					G = Math.sqrt((m_weights*g)*(m_weights*g),(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600)*(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600))/n;
				else
					G = Math.sqrt((m_weight* g)*(m_weight* g),(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600)*(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600))/n;
				if( i==5)		//安装工况 施工观测弧垂 一端有串
				{
					S[i] = m_Ttract/A;
					l1 = m_l- cl0;
					W1 = l1*r/Math.cos(bata);
					rb = r/Math.cos(bata);
					tz = l1*(l1+3*cl0) + 6*cl0*G/(A*W1*rb)*(W1+2.0*G/3.0/A) - 3*cl0*cl0*Math.pow(W1+G/A,2)/(m_l*W1*rb);
					K[i] = r*r*E*Math.pow(Math.cos(bata),3)/24 *tz;
					deltaL = prk.PRIMARY.pLTract;
				}
				else			// 竣工情况 两端有串
				{
					if(i==0)
						S[i] = m_Tav/A;
					else
						S[i] = m_Tmax/A;
					l1 = m_l- 2*cl0;
					W1 = l1 * r/Math.cos(bata);
					rb = r/Math.cos(bata);
					tz =  l1*(l1+6*cl0) + 12*G*cl0*(W1+2.0*G/3.0/A)/(W1*rb*A);
					K[i] = r*r*E*Math.pow(Math.cos(bata),3)/24 *tz;
					deltaL =0;
				}
				F[i] = K[i]/Math.pow(S[i],2)  -( S[i]+ a*E*Math.cos(bata)*theWeather.TWI[i].t - E*deltaL*Math.pow(Math.cos(bata),2)/l1);
				if((i==0 || i==2 || i==4 || i==5 )&&F[i]>Fmax)
				{
					ctrl = i;
					Fmax = F[i];
					ctrlK  = K[i];
				}
			}

			let f0 = -99999;
			for(let i =0;i<10;i++)
			{
				T = theWeather.TWI[i].t;
				aa = Fmax +a*E*Math.cos(bata)*T;
				S[i] =0;
				f[i] =0;
				if(theWeather.TWI[i].b>0)
					G = Math.sqrt((m_weights*g)*(m_weights*g),(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600)*(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600))/n;
				else
					G = Math.sqrt((m_weight* g)*(m_weight* g),(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600)*(m_area*Math.pow(theWeather.TWI[i].v*Kh,2)/1.600))/n;
				rs = G/A/m_length;
				r = GetLoad(i,7)/A;
				if(i==ctrl)
				{
					if(i ==0)
						S[i] = m_Tav/A;
					else if(i ==5)
						S[i] = m_Ttract/A;
					else
						S[i] = m_Tmax/A;
				}
				else
				{
					S[i] = GetEquationValue(1.0,aa,0,-K[i],9999);
				}
				f[i] = ( r*m_l*m_l/8 + (rs-r)*cl0*cl0/2 ) / S[i]/Math.cos(bata);
				if(i!=9  && f[i]>f0)
				{
					k = r/2/S[i];
					constA = (rs-r)*cl0*cl0/2/S[i];
					f0 = f[i];
				}
				else if(i ==9)
				{
					kMaxT = r/2/S[i];
					constMaxT = (rs-r)*cl0*cl0/2/S[i];
				}
			}
		}
		window.ComputeK = function(l0,sita) {
			let k=0;
			let condition = -1;
			k = GetMaxK(l0, sita,condition);
			return k;
		}
		window.ComputeK2 = function() {
			for (let i = m_start; i < m_end; i++) {
				initializeDataBool(towerlist[i].Distance,towerlist[i].u,true,1);
				if (towerlist[i].bInsular){
					let k,constant,kMaxT,constMaxT;
					ComputeIsolate(towerlist[i],towerlist[i+1],k,constant,kMaxT,constMaxT);
					towerlist[i].kPline = k;
					towerlist[i].kWind  = k;
					towerlist[i].kMaxT  = kMaxT;
					towerlist[i].constant = constant;
					towerlist[i].constMaxT = constMaxT;
				}else {
					towerlist[i].kPline = ComputeK(towerlist[i].Lk,towerlist[i].cosa);
					towerlist[i].kWind = GetLoad(3,7)/theLine.A/GetStrain(towerlist[i].Lk,towerlist[i].cosa,3)/2.0;
					towerlist[i].kMaxT = GetLoad(9,7)/theLine.A/GetStrain(towerlist[i].Lk,towerlist[i].cosa,9)/2.0;
				}
			}
		}
		window.GetLoaLob = function(l0,cosa,condition,l,h,Loa,Lob) {
			let s, p,r;
			s = GetStrain(l0,  cosa,condition);
			p = theWeather.TWI[condition].P7;//r为综合比载
			r = p/theLine.A;
			Loa = l/2.0 - s/r*arcsh(r*h/(2*s*sinh(r*l/2.0/s)));
			//Lob = l/2.0 + s/r*arcsh(r*h/(2*s*sinh(r*l/2.0/s)));
			Lob = l - Loa;
		}
		window.GetLoaLob2 = function(k,l,h) {
			let Loa = l/2.0 - arcsh(k*h/sinh(k*l))/2.0/k;
			let Lob = l - Loa;
			let lo = new Array(Loa,Lob);
			return lo

		}
		window.ComputeLH = function() {
			let sita;
			let indexComputeLH = -1;
			let count = towerlist.length;
			if (count > 0){
				towerlist[0].Lh1 = 0;
				towerlist[count-1].Lh2 = 0;
				for(let i=m_start;i<m_end;i++)
				{
					//计算单侧水平档距
					sita = Math.atan((towerlist[i+1].hugeHigh-towerlist[i].hugeHigh)/(towerlist[i+1].Distance - towerlist[i].Distance));
					towerlist[i].Lh2 = (towerlist[i+1].Distance - towerlist[i].Distance)/Math.cos(sita)/2;
					towerlist[i+1].Lh1 = (towerlist[i+1].Distance - towerlist[i].Distance)/Math.cos(sita)/2;
				}
				for(let i=m_start;i<=m_end;i++)
				{
					towerlist[i].Lh = towerlist[i].Lh1 + towerlist[i].Lh2;
					indexComputeLH = FindTower(towerlist[i]);
					if(indexComputeLH>0)
					{
						if(prk.TOWER[indexComputeLH].LH<towerlist[i].Lh)
							towerlist[i].towererror = true;
						else
							towerlist[i].towererror = false;
					}
				}
			}

		}
		window.ComputeLV = function(condition) {
			let Loa,Lob;
			let Lo = [];
			let indexComputeLV= -1;
			let k=0;
			let count = towerlist.length;
			if (count > 0) {
				towerlist[0].Lv1 = 0;
				towerlist[count-1].Lv2 = 0;
				for(let i=m_start;i<m_end;i++)
				{
					//计算单侧垂直档距
					if(condition<0)
						k = towerlist[i].kPline;
					else
					{
						initializeDataBool(towerlist[i].Distance,towerlist[i].u,true,1);
						k = GetLoad(condition,7)/theLine.A/GetStrain(towerlist[i].Lk,towerlist[i].cosa,condition)/2.0;
					}
					Lo = GetLoaLob2(k, (towerlist[i+1].Distance - towerlist[i].Distance), towerlist[i+1].hugeHigh-towerlist[i].hugeHigh)
					Loa = Lo[0];
					Lob = Lo[1];
					towerlist[i].Lv2 = Loa;
					towerlist[i+1].Lv1 = Lob;
				}
				for(let i=m_start;i<=m_end;i++)
				{
					if(condition<0)
					{
						towerlist[i].Lv = towerlist[i].Lv1 + towerlist[i].Lv2;
						indexComputeLV = FindTower(towerlist[i]);
						if(indexComputeLV>0)
						{
							if(prk.TOWER[indexComputeLV].LV<towerlist[i].Lv)
								towerlist[i].towererror = true;
							else
								towerlist[i].towererror = false;
						}
					}
					else if(condition == 1)
						towerlist[i].lvMaxTemp = towerlist[i].Lv1 + towerlist[i].Lv2;
					else if(condition == 2)
						towerlist[i].lvMinTemp = towerlist[i].Lv1 + towerlist[i].Lv2;
					else if(condition == 3)
						towerlist[i].lvMaxWind = towerlist[i].Lv1 + towerlist[i].Lv2;
					else if(condition == 4)
						towerlist[i].lvMaxIce  = towerlist[i].Lv1 + towerlist[i].Lv2;
				}
			}
		}
		window.ComputeLhLv = function() {
			ComputeLH();
			ComputeLV(-1);
		}
		window.ComputeGK = function(l0,cosa) {
			let k= 0;
			let condition = -1;
			k = GetMinK(l0, cosa,condition);
			return k;
		}
		window.ComputeGK2 = function() {
			for(let i=m_start;i<m_end;i++)
			{
				initializeDataBool(towerlist[i].Distance,1,false,1);
				towerlist[i].kGround = ComputeGK(towerlist[i].Lk,1);
			}
		}

		//弧垂
		window.DisplayFawCurve = function(x1,y1,x2,y2,k,x0,bInsular,constt,length,material, name) {

			if (x1 < 0) return;
			let f,l1,l2,l,x3, y3;
			let loa,h;
			let endL,startL;
			let ptCount =0;
			let insertPoint = [];

			l1 = 0;
			l = x2-x1;
			h = y2-y1;
			loa = l/2.0 - arcsh(k*h/sinh(k*l))/2.0/k;
			if(!bInsular)
			{
				/****修改****/
				startL=x1;
				/****修改****/
				endL = Math.min(x2,xMax);
				ptCount = parseInt(endL - startL)+1;
				for(let i=0;i<ptCount &&i< 2048 ;i++ )
				{
					l1 = 1.0*i + startL-x1;
					l2 = l - l1;
					if(i!=ptCount-1)//非最后点
					{
						//P180手册公式
						f = l1*h/l +( sinh(k*(2*loa-l1)) * sinh(k*l1) )/k;
						x3 = x1 + l1;
						y3 = (l1*y2+l2*y1)/l-f;
					}
					/****修改****/
					else if(x2 <= xMax)	//最后一点
					/****修改****/
					{
						x3 = x2;
						y3 = y2;
					}
					/****修改****/
					insertPoint.push(new THREE.Vector3((x3-xMin)/xdivision*Gridsize , (y3 - yMin)/ydivision*Gridsize, 0))
					/****修改****/
				}
			}
			else
			{
				startL=x1;
				endL = Math.min( x2-length*Math.cos(Math.atan(h/l)),xMax );
				ptCount = parseInt (endL - startL)+2;
				for(let i=0;i<ptCount;i++ )
				{
					if(i==0)			//第一点
					{
						x3 = x1;
						y3 = y1;
					}
					else if(i!=ptCount-1)//中间点
					{
						l1 = 1.0*(i-1) + startL-x1;
						l2 = l - l1;
						//P193手册公式
						f =( k*l1*(l-l1) + constt )/Math.cos(Math.atan(h/l));
						x3 = x1 + l1;
						y3 = (l1*y2+l2*y1)/l-f;
					}
					else if(x2<=xMax)	//最后一点
					{
						x3 = x2;
						y3 = y2;
					}
					/****修改****/
					insertPoint.push(new THREE.Vector3((x3-xMin)/xdivision*Gridsize, (y3 - yMin)/ydivision*Gridsize, 0))
					/****修改****/
				}
			}
			var conductGeo = new THREE.Geometry();
			for (let i = 0 ; i < insertPoint.length ; i++){
				conductGeo.vertices.push(insertPoint[i]);
			}
			var conductObj = new THREE.Line( conductGeo, material );
			conductObj.name = name;
			conductObj.renderOrder = 999;
			conductObj.onBeforeRender = function( renderer ) { renderer.clearDepth(); };
			scene.add(conductObj);
		}
		window.DisplayFawCurve2 = function(x1,y1,x2,y2,k,dspLwst,bInsular,constt,length,material, name) {
			if( x2-x1<10 || x2-x1>3000 || Math.abs(y1-y2)>2000 ) {
				return;
			}
			let f,l1,l2,l;
			let loa,h,xx,yy;
			// let insertPoint = [];
			let lx1 = x1,lx2 = x2;
			l1 = 0;
			l = x2-x1;
			h = y2-y1;
			xx = (x1+x2)/2;
			if(k==0) k = 300*1E-6;
			//计算弧垂最低点坐标
			loa = l/2.0 - arcsh(k*h/sinh(k*l))/2.0/k;
			f = loa*h/l +( sinh(k*(2*loa-loa)) * sinh(k*loa) )/k;
			l = x2 - x1;
			l1 = loa;
			l2 = l-loa;
			xx = x1 + loa;
			yy = (l1*y2+l2*y1)/l-f;

			// if (dspLwst)
			DisplayFawCurve( x1, y1, x2, y2, k, lx1, bInsular, constt,length,material, name);

			//显示超出范围的弧垂
			// if((xx<x1 || xx>x2) && dspLwst)
			// {
			// 	if(xx<x1)
			// 	{
			// 		x2 = x1;
			// 		y2 = y1;
			// 		x1 = xx;
			// 		y1 = yy;
			// 	}
			// 	else
			// 	{
			// 		x1 = x2;
			// 		y1 = y2;
			// 		x2 = yy;
			// 		y2 = yy;
			// 	}
			// 	DisplayFawCurve(x1, y1, x2, y2, k, lx1, bInsular, constt,length,material, name);
			// }
		}
		window.DisplayFawCurve3 = function(tower1, tower2, kPower, kGround, name){
			let constt=0;
			if(tower1.displayKType==0)
				constt = tower1.constant;
			else if(tower1.displayKType==1)
				constt = tower1.constMaxT;
			if(tower1.displayGround){
				let wire_material = new THREE.LineBasicMaterial({color: 0x000000});
				DisplayFawCurve2(tower1.Distance,tower1.hugeGround,tower2.Distance,tower2.hugeGround,kGround,false,false,0,0,wire_material, name+"1");
			}
			if(tower1.displayPower){
				let wire_material1 = new THREE.LineBasicMaterial({color: 0x000000});
				DisplayFawCurve2(tower1.Distance,tower1.hugeHigh, tower2.Distance,tower2.hugeHigh,kPower,true,
						tower1.bInsular,constt,tower1.InsulatorLength,wire_material1, name+"2");
				console.log(tower1.Distance,tower1.hugeHigh, tower2.Distance,tower2.hugeHigh);
			}
			if(tower1.displaySafe){
				let wire_material2 = new THREE.LineBasicMaterial({color: 0x0000ff});
				DisplayFawCurve2(tower1.Distance,tower1.hugeHigh-tower1.LandDist, tower2.Distance,tower2.hugeHigh-tower1.LandDist,
						kPower,false,tower1.bInsular,constt,tower1.InsulatorLength,wire_material2, name+"3");
			}
			if(tower1.displayCross){
				let wire_material3 = new THREE.LineBasicMaterial({color: 0xff0000});
				DisplayFawCurve2(tower1.Distance,tower1.hugeHigh-tower1.ElecDist, tower2.Distance,tower2.hugeHigh-tower1.ElecDist,
						kPower,false,tower1.bInsular,constt,tower1.InsulatorLength,wire_material3, name+"4");
			}
		}
		window.DisplayFawCurve4 = function(tower1,tower2, name){
			if(tower1.displayKType === 0){
				DisplayFawCurve3(tower1, tower2, tower1.kPline, tower1.kGround, name);
			}
			// else if(tower1.displayKType==1)
			// 	DisplayFawCurve3(tower1, tower2, tower1.kMaxT,  tower1.kGround);
		}

		var towerLineWid = 0.5;

	/* 创建杆塔函数 */
	window.tower1 = function(towerHei) {
			let scale = 1 / ydivision * Gridsize;
			let tower = new THREE.Shape();
			/****修改****/
			// tower.moveTo(0,0);
			// tower.lineTo(1,0);tower.lineTo(1,towerLineWid);tower.lineTo(0.75,towerLineWid);
			// tower.lineTo(0.75,towerHei-4.5-towerLineWid);tower.lineTo(1.5,towerHei-4.5-towerLineWid);
			// tower.lineTo(1.5,towerHei-4.5);tower.lineTo(0.75,towerHei-4.5);tower.lineTo(0.75,towerHei);
			// tower.lineTo(0.25,towerHei);tower.lineTo(0.25,towerHei-4.5);tower.lineTo(-0.5,towerHei-4.5);
			// tower.lineTo(-0.5,towerHei-4.5-towerLineWid);tower.lineTo(0.25,towerHei-4.5-towerLineWid);
			// tower.lineTo(0.25,towerLineWid);tower.lineTo(0,towerLineWid);
			// tower.lineTo(0,0);
		tower.moveTo(-0.5,0);
		tower.lineTo(0.5,0);tower.lineTo(0.5,towerLineWid);tower.lineTo(0.25,towerLineWid);
		tower.lineTo(0.25,towerHei-4.5-towerLineWid);tower.lineTo(1,towerHei-4.5-towerLineWid);
		tower.lineTo(1,towerHei-4.5);tower.lineTo(0.25,towerHei-4.5);tower.lineTo(0.25,towerHei);
		tower.lineTo(-0.25,towerHei);tower.lineTo(-0.25,towerHei-4.5);tower.lineTo(-1,towerHei-4.5);
		tower.lineTo(-1,towerHei-4.5-towerLineWid);tower.lineTo(-0.25,towerHei-4.5-towerLineWid);
		tower.lineTo(-0.25,towerLineWid);tower.lineTo(-0.5,towerLineWid);
		tower.lineTo(-0.5,0);
		/****修改****/
			let towerGroup = new THREE.ShapeGeometry(tower);
			towerGroup.scale(scale,scale,scale);
			let towMaterial = new THREE.MeshBasicMaterial( { color: 0x00ff00, side: THREE.DoubleSide } );
			var towMesh = new THREE.Mesh( towerGroup, towMaterial ) ;
			towMesh.renderOrder = towerHei;
			return towMesh;
		}

	window.createTower = function(pos,index){
			var towMesh = tower1(towerHei);
			towMesh.position.x = pos.x;
			towMesh.position.y = pos.y;
			towMesh.position.z = 0;
			towMesh.name = "fixTower";
			towMesh.geometry.name = "G" + index;
			towerlist.push({
				"Name" : "G" + index,
				"Distance" : pos.x /Gridsize *xdivision+xMin,
				"High" : pos.y/Gridsize*ydivision + yMin,
				"PosOffset":"",
				"TowerType" : "ZMVA41",
				"Base": 0,
				"TowerHigh" : towerHei,
				"Status" : 0,
				"InsulatorLength": 4.5,
				"ConnectLength": 0.0,
				"InsulateP": "",
				"InsulatePA": "X01",
				"InsulatePANum": -1,
				"InsulatePB": "X01",
				"InsulatePBNum": -1,
				"InsulatePC": "",
				"InsulatePCNum": 0,
				"hugeHigh":0,
				"hugeGround" : 0,		// 地线悬挂点高程
				"Lk": 0,
				"L": 0,
				"cosa":1,
				"bInsular":false,
				"constant": 0,
				"u": 1,
				"kPline": 0,			//导线大号侧k值系数
				"kGround": 0,		//地线大号侧K值系数
				"kWind": 0,			//大风条件前视档k值系数
				"kMaxT": 0,			//70度高温k值系数
				"constMaxT": 0,
				"Lh": 0,				// 水平档距
				"Lh1": 0,			// 小号侧垂直档距
				"Lh2": 0,			// 大号侧垂直档距
				"Lv" : 0,				// 垂直档距
				"Lv1" : 0,			// 小号侧水平档距
				"Lv2" : 0,			// 大号侧水平档距
				"lvMinTemp": 0,//最低气温垂直档距
				"lvMaxTemp": 0,//最高气温垂直档距
				"lvMaxIce": 0,//最大覆冰垂直档距
				"lvMaxWind": 0,//最大风垂直档距
				"displayKType": 0,	//k值类型，0为最大弧垂 1为最高线温
				"displayGround":0,		//显示地线
				"displayPower" : 1,		//显示导线
				"displaySafe" :  1,	//显示导线对地
				"displayCross" : 1,		//显示导线跨越
				"LandDist" : 8.5,		// 对地安全距离
				"ElecDist" : 6.0	// 电力线安全距离
			});
			m_start = 0;
			m_end = towerlist.length - 1;
			ComputeHugeHigh();
			scene.add(towMesh);

			if (m_end >= 1) {
				DisplayFawCurve4(towerlist[m_end - 1],towerlist[m_end], "fixwire");
			}
			return towMesh;
		}
		var tempTowerlist =[];
	function createTowerTemp(pos){
			tempTowerlist = [];
			var towMesh = tower1(towerHei);
			towMesh.position.x = pos.x;
			towMesh.position.y = pos.y;
			towMesh.position.z = 0;
			towMesh.name = "tower";

			towerlist.push({
				"Name" : "G",
				"Distance" : pos.x/Gridsize*xdivision+xMin,
				"High" :pos.y/Gridsize*ydivision + yMin,
				"PosOffset":"",
				"TowerType" : "ZMVA41",
				"Base": 0,
				"TowerHigh" : towerHei,
				"Status" : 0,
				"InsulatorLength": 4.5,
				"ConnectLength": 0.0,
				"InsulateP": "",
				"InsulatePA": "X01",
				"InsulatePANum": -1,
				"InsulatePB": "X01",
				"InsulatePBNum": -1,
				"InsulatePC": "",
				"InsulatePCNum": 0,
				"hugeHigh":0,
				"hugeGround" : 0,		// 地线悬挂点高程
				"Lk": 0,
				"L": 0,
				"cosa":1,
				"bInsular":false,
				"constant": 0,
				"u": 1,
				"kPline": 0,			//导线大号侧k值系数
				"kGround": 0,		//地线大号侧K值系数
				"kWind": 0,			//大风条件前视档k值系数
				"kMaxT": 0,			//70度高温k值系数
				"constMaxT": 0,
				"Lh": 0,				// 水平档距
				"Lh1": 0,			// 小号侧垂直档距
				"Lh2": 0,			// 大号侧垂直档距
				"Lv" : 0,				// 垂直档距
				"Lv1" : 0,			// 小号侧水平档距
				"Lv2" : 0,			// 大号侧水平档距
				"lvMinTemp": 0,//最低气温垂直档距
				"lvMaxTemp": 0,//最高气温垂直档距
				"lvMaxIce": 0,//最大覆冰垂直档距
				"lvMaxWind": 0,//最大风垂直档距
				"displayKType": 0,	//k值类型，0为最大弧垂 1为最高线温
				"displayGround":0,		//显示地线
				"displayPower" : 1,		//显示导线
				"displaySafe" :  1,	//显示导线对地
				"displayCross" : 1,		//显示导线跨越
				"LandDist" : 8.5,		// 对地安全距离
				"ElecDist" : 6.0	// 电力线安全距离
			});
			m_end = towerlist.length - 1;
			ComputeHugeHigh();

			scene.add(towMesh);
			if (m_end > 0) {
				DisplayFawCurve4(towerlist[m_end - 1],towerlist[m_end], "move_wire");
			}
			towerlist.pop();
			m_end = towerlist.length - 1;
			ComputeHugeHigh();
		}

	/* 获取射线与平面相交的交点 */
	var raycaster = new THREE.Raycaster();
	var mouse = new THREE.Vector2();

	window.getIntersects= function(event) {
		if(mainCanvas!=null) {
			mouse.x = ((event.clientX - mainCanvas.getBoundingClientRect().left) / mainCanvas.offsetWidth) * 2 - 1;
			mouse.y = -((event.clientY - mainCanvas.getBoundingClientRect().top) / mainCanvas.offsetHeight) * 2 + 1;

			var normal = new THREE.Vector3(0, 0, 1);
			var planeGround = new THREE.Plane(normal, 0);//创建平面

			raycaster.setFromCamera(mouse, camera);//从相机发出一条射线经过鼠标点击的位置
			var ray = raycaster.ray;//获取射线
			var intersects = new THREE.Vector3();
			intersects = ray.intersectPlane(planeGround, intersects);//计算相机到射线的对象，可能有多个对象，返回一个数组，按照距离相机远近排列
			return intersects;
		}
	}

	function getIntersectsObject(event) {
		var towerArr = [];
		mouse.x = ((event.clientX  - mainCanvas.getBoundingClientRect().left)/ mainCanvas.offsetWidth) * 2 - 1;
		mouse.y = -((event.clientY - mainCanvas.getBoundingClientRect().top)/ mainCanvas.offsetHeight) * 2 + 1;

		raycaster.setFromCamera(mouse,camera);
		//计算射线相机到的对象，可能有多个对象，因此返回的是一个数组，按离相机远近排列
		for (let i = 0; i < scene.children.length; i++) {
			if (scene.children[i].name === "fixTower"){
				towerArr.push(scene.children[i]);
			}
		}
		let intersectTower = raycaster.intersectObjects(towerArr,true);//获取点击杆塔对象
		return intersectTower;
	}

	var pointArray = [];
	var window_mouse = true;
	var intersects;
	var tempintersects;
	var putInd = 0;

		//放置杆塔
	function onMouseDown(event) {
		intersects = getIntersects(event);
		tempintersects = intersects;
		if (event.button == 0 ){
			if (!window_mouse){
				document.addEventListener("mousemove",onMouseMove,false);
				window_mouse = true;//避免事件重复添加
			}

			if (intersects.x<horSize &&intersects.x>0 && intersects.y<verSize && intersects.y>0){
				putInd = towerlist.length;
				var tempLine2Cor = [];
				for (let i = 0; i < m_linegroup.children.length; i++) {
					for(let j=0;j<m_linegroup.children[i].geometry.vertices.length;j++){
						tempLine2Cor.push([m_linegroup.children[i].geometry.vertices[j].x,m_linegroup.children[i].geometry.vertices[j].y]);
					}
				}
				var tempLine2 = turf.lineString(tempLine2Cor);
				var temppointLine1 = turf.lineString([[tempintersects.x,tempintersects.y+500],[tempintersects.x,0]]);  // +500? 4.8
				var interPoint1 = turf.lineIntersect(temppointLine1, tempLine2);
				tempintersects = new THREE.Vector3(tempintersects.x, interPoint1.features[0].geometry.coordinates[1], 0);

				var pointsGeometry = new THREE.Geometry();
				pointsGeometry.vertices.push(intersects);
				var temppointsGeometry = new THREE.Geometry();
				temppointsGeometry.vertices.push(tempintersects);

				var pointsMaterial = new THREE.PointsMaterial({color:0xff0000, size: 3});
				var points = new THREE.Points(pointsGeometry, pointsMaterial);
				var temppoints = new THREE.Points(temppointsGeometry, pointsMaterial);
				pointArray.push(temppoints);
				//putInd++;

				var pos = new THREE.Vector3(points.geometry.vertices[0].x,points.geometry.vertices[0].y,0);
				var tempLine1 = turf.lineString([[pos.x,pos.y],[pos.x,0]]);
				var interPoint = turf.lineIntersect(tempLine1, tempLine2);
				pos = new THREE.Vector3(points.geometry.vertices[0].x, interPoint.features[0].geometry.coordinates[1], 0);

				if(putInd==0||pos.x/Gridsize*xdivision>towerlist[putInd-1].Distance){  //防止向前
					// var childHtml = document.getElementById("towInfor").contentWindow;
					// console.log(childHtml);

					createTower(pos,putInd);
					let disToPile = []
					for (let i = 0; i < pile_tabledata.length; i++) {
						disToPile.push({
							"name": pile_tabledata[i].name,
							"dis": Math.abs(pile_tabledata[i].dist - pos.x /Gridsize*xdivision),
							"value": i
						})
					}
					disToPile.sort(compare("dis"));
					$("#pilelist").val(disToPile[0].value);
					let gap;
					for (let i = 0; i < pile_tabledata.length; i++) {
						if (pile_tabledata[i].name == disToPile[0].name) {
							gap = pos.x /Gridsize*xdivision - pile_tabledata[i].dist;
						}
					}

					towerlist[towerlist.length-1].PosOffset = disToPile[0].value.toString()+"+"+gap.toFixed(2).toString();
					//whj 3.7 refresh GridManager 获取的只有参数  需要发起ajax请求帮助计算填充表格
					towerlist_tabledata=towerlist;
					GridManager.refreshGrid(towerlist_tableId);

					//var inputId = document.getElementById("towId");
					var inputId2 =  layer.getChildFrame('body',tpIndex).find("#towId")[0];
					//inputId.value = "G" + putInd;
					inputId2.value = "G" + putInd;

					for (let i = m_end - 1; i < m_end; i++) {
						DisplayFawCurve4(towerlist[i], towerlist[i + 1], "fixwire");
					}

				}
			}
		}
		if (event.button == 2){
			clearTempTow();
			putInd = 0;
			window_mouse = false;
			document.removeEventListener("mousemove",onMouseMove);
			document.removeEventListener("mousedown",onMouseDown);
		}
	}

	function onMouseMove(event) {
		intersects = getIntersects(event);
		tempintersects = intersects;
		if (intersects.x<horSize &&intersects.x>0 && intersects.y<verSize && intersects.y>0){
			clearTempTow();
			var tempLine2Cor = [];

			for (let i = 0; i < m_linegroup.children.length; i++) {
				for(let j=0;j<m_linegroup.children[i].geometry.vertices.length;j++){
					tempLine2Cor.push([m_linegroup.children[i].geometry.vertices[j].x,m_linegroup.children[i].geometry.vertices[j].y]);
				}
			}
			var tempLine2 = turf.lineString(tempLine2Cor);
			var temppointLine1 = turf.lineString([[tempintersects.x,tempintersects.y+500],[tempintersects.x,0]]);
			var interPoint1 = turf.lineIntersect(temppointLine1, tempLine2);
			tempintersects = new THREE.Vector3(intersects.x, interPoint1.features[0].geometry.coordinates[1], 0);
			var pos = new THREE.Vector3(intersects.x, intersects.y + 500, 0);
			var tempLine1 = turf.lineString([[pos.x,pos.y],[pos.x,0]]);
			var interPoint = turf.lineIntersect(tempLine1, tempLine2);
			pos = new THREE.Vector3(intersects.x, interPoint.features[0].geometry.coordinates[1], 0);
			let coorDif = intersects.y - interPoint.features[0].geometry.coordinates[1];
			towerHei = limit(towerHeiArray,coorDif);
			createTowerTemp(pos);
			let disToPile = []
			for (let i = 0; i < pile_tabledata.length; i++) {
				disToPile.push({"name": pile_tabledata[i].name,
					"dis":Math.abs(pile_tabledata[i].dist - pos.x/Gridsize*xdivision),
					"value":i
				})
			}
			disToPile.sort(compare("dis"));
			//$("#pilelist").val(disToPile[0].value);
			layer.getChildFrame('body',tpIndex).find("#pilelist").val(disToPile[0].value);

			let gap;
			for (let i = 0; i < pile_tabledata.length; i++) {
				if (pile_tabledata[i].name == disToPile[0].name){
					gap = pos.x/Gridsize*xdivision - pile_tabledata[i].dist;
				}
			}
			//let gaptoPile = document.getElementById("gap");
			//gaptoPile.value = gap.toFixed(2);
			let gaptoPile2 = layer.getChildFrame('body',tpIndex).find("#gap")[0];
			gaptoPile2.value = gap.toFixed(2);
			//var inputDis = document.getElementById("dis");
			//var inputHei = document.getElementById("hei");
			var inputHei2 = layer.getChildFrame('body',tpIndex).find("#hei")[0];
			var inputDis2 = layer.getChildFrame('body',tpIndex).find("#dis")[0];

			let disNum = pos.x/Gridsize*xdivision + xMin;
			let heiNum = pos.y/Gridsize*ydivision + yMin;
			//inputDis.value = disNum.toFixed(2);
			inputDis2.value = disNum.toFixed(2);
			//inputHei.value = heiNum.toFixed(2);
			inputHei2.value = heiNum.toFixed(2);

			var towerHigh = layer.getChildFrame('body',tpIndex).find("#towerheight")[0];
			for (let i = 0; i < towerHigh.length; i++) {
				if (towerHigh[i].value === towerHei.toString()){
					towerHigh[i].selected = true;
				}
			}
			//var inputId = document.getElementById("towId");
			var inputId2 =  layer.getChildFrame('body',tpIndex).find("#towId")[0];
			//inputId.value = "G" + towerlist.length;
			inputId2.value = "G" + towerlist.length;
		}
	}
	//清除动态排杆中的临时数据
	function clearTempTow(){
			if (scene.getObjectByName('move_wire1')) {
				scene.remove(scene.getObjectByName('move_wire1'));
			}
			if (scene.getObjectByName('move_wire2')) {
				scene.remove(scene.getObjectByName('move_wire2'));
			}
			if (scene.getObjectByName('move_wire3')) {
				scene.remove(scene.getObjectByName('move_wire3'));
			}
			if (scene.getObjectByName('move_wire4')) {
				scene.remove(scene.getObjectByName('move_wire4'));
			}
			if (scene.getObjectByName('tower')) {
				scene.remove(scene.getObjectByName('tower'));
			}
		}
	//保存排杆
	$("#saveTower").click(function () {
		console.log(towerlist);
		var towerpwf = {"TOWERLIST":towerlist};
		savedJson.pwf = towerpwf;
		console.log(towerpwf);
		var pwfStr = JSON.stringify(towerpwf);
		console.log(pwfStr)
		var formData = new FormData();

		formData.append("pwf",pwfStr);
		formData.append("ProjectName", prjName);
		console.log(formData.get('pwf'));

		if (towerlist.length > 0){
			$.ajax({
				url: "http://202.114.118.138:8181/pwfsave", //提交的路径
				type: "post",       //提交方式
				data: formData,    //提交的数据
				// dataType:"json",
				contentType: false, // 告诉jQuery不要去设置Content-Type请求头
				processData: false,
				success: function (data) {
					console.log(data);
					alert("保存成功！");
				},
				error: function (errorMsg) {
					alert(errorMsg);
				}
			});
		}
	})
	savedJson.pwf = towerlist;
	//保存json文件到本地（固定路径）
	$("#saveJson").click(function () {
		console.log(savedJson);
		var content = JSON.stringify(savedJson);
		var blob = new Blob([content], {type: "text/plain;charset=utf-8"});
		saveAs(blob, prjName + ".json");
	})
	//删除杆塔
	function towerDelete(event) {
			if (event.button === 0){
				var intersectsTower = getIntersectsObject(event);
				console.log("picked", intersectsTower[0]);
				// intersectsTower[0].object.material = new THREE.LineBasicMaterial({color: 0x00ffff});
				var msg = "删除杆塔";
				let deleteWire = [];
				let currentTow = [];
				if(intersectsTower[0] != undefined){
				if (confirm(msg) === true) {
					scene.remove(intersectsTower[0].object);
					for (let i = 0; i < scene.children.length; i++) {
						if (scene.children[i].name === "fixwire1" || scene.children[i].name === "fixwire2" || scene.children[i].name === "fixwire3" || scene.children[i].name === "fixwire4") {
							deleteWire.push(scene.children[i]);
						}
					}
					for (let i = 0; i < deleteWire.length; i++) {
						scene.remove(deleteWire[i]);
					}
					towerlist.removed(intersectsTower[0].object.geometry.name)
					console.log(towerlist);
					let deleteInd = towerlist.findindexOf(intersectsTower[0].object.geometry.name);
					console.log("deleteind", deleteInd)
					m_end = towerlist.length - 1;
					towerlist.sort(compare('Distance'));
					for (let i = 0; i < towerlist.length; i++) {
						towerlist[i].Name = "G" + i;
					}

					for (let i = m_start; i < m_end; i++) {
						DisplayFawCurve4(towerlist[i], towerlist[i + 1], "fixwire");
					}

					console.log(scene.children)
					scene.children.sort(compare('position'))
					for (let i = 0; i < scene.children.length; i++) {
						if (scene.children[i].name == "fixTower") {
							currentTow.push({
								"posX": scene.children[i].position.x,
								"object": scene.children[i]
							});
						}
					}
					console.log(currentTow)
					currentTow.sort(compare('posX'))
					for (let j = 0; j < currentTow.length; j++) {
						for (let i = 0; i < scene.children.length; i++) {
							if (scene.children[i].uuid == currentTow[j].object.uuid) {
								scene.children[i].geometry.name = "G" + j;
							}
						}
					}
					console.log(towerlist);
					towerlist.sort(compare('Distance'));
					for (let i = 0; i < towerlist.length; i++) {
						towerlist[i].Name = "G" + i;
					}
					towerlist_tabledata = towerlist;
					console.log(towerlist_tabledata);
					GridManager.setAjaxData(towerlist_tableId, {"data": towerlist_tabledata});
					GridManager.refreshGrid(towerlist_tableId);
				}
					else {
					return false;
				}
				}
				else {document.body.style.cursor = "default";
					document.removeEventListener("mousedown", towerDelete);}
			}
			if (event.button === 2){
				document.body.style.cursor = "default";
				document.removeEventListener("mousedown", towerDelete);
			}
		}
	//插入杆塔
	function towerInsert(event) {
		if (event.button === 0){
			let currentTow = [];
			let deleteWire = [];
			intersects = getIntersects(event);
			tempintersects = intersects;

			var tempLine2Cor = [];
			for (let i = 0; i < m_linegroup.children.length; i++) {
				for(let j=0;j<m_linegroup.children[i].geometry.vertices.length;j++){
					tempLine2Cor.push([m_linegroup.children[i].geometry.vertices[j].x,m_linegroup.children[i].geometry.vertices[j].y]);
				}
			}
			var tempLine2 = turf.lineString(tempLine2Cor);
			var temppointLine1 = turf.lineString([[tempintersects.x,tempintersects.y+500],[tempintersects.x,0]]); // m_line intersect point
			var interPoint1 = turf.lineIntersect(temppointLine1, tempLine2);
			tempintersects = new THREE.Vector3(tempintersects.x, interPoint1.features[0].geometry.coordinates[1], 0);

			var pointsGeometry = new THREE.Geometry();
			pointsGeometry.vertices.push(intersects);
			var temppointsGeometry = new THREE.Geometry();
			temppointsGeometry.vertices.push(tempintersects);

			var pointsMaterial = new THREE.PointsMaterial({color:0xff0000, size: 3});
			var points = new THREE.Points(pointsGeometry, pointsMaterial);
			var temppoints = new THREE.Points(temppointsGeometry, pointsMaterial);
			pointArray.push(temppoints);
			putInd++;

			var pos = new THREE.Vector3(points.geometry.vertices[0].x,points.geometry.vertices[0].y,0);
			var tempLine1 = turf.lineString([[pos.x,pos.y],[pos.x,0]]);
			var interPoint = turf.lineIntersect(tempLine1, tempLine2);
			pos = new THREE.Vector3(points.geometry.vertices[0].x, interPoint.features[0].geometry.coordinates[1], 0);

			var towMesh = tower1(towerHei);
			towMesh.position.x = pos.x;
			towMesh.position.y = pos.y;
			towMesh.position.z = 0;
			towMesh.name = "fixTower";
			scene.add(towMesh);

			for (let i = 0; i < scene.children.length; i++) {
				if (scene.children[i].name === "fixwire1" || scene.children[i].name === "fixwire2" || scene.children[i].name === "fixwire3" || scene.children[i].name === "fixwire4") {
					deleteWire.push(scene.children[i]);
				}
			}
			for(let i = 0; i < deleteWire.length; i++){
				scene.remove(deleteWire[i]);
			}

			scene.children.sort(compare('position'))
			/****修改****/
			towerlist = []
			for (let i = 0; i < scene.children.length; i++) {
				if (scene.children[i].name == "fixTower") {
					currentTow.push({
						"posX":scene.children[i].position.x,
						"object":scene.children[i]
					});
					towerlist.push({
						"Name": "G" + i,
						"Distance": scene.children[i].position.x / Gridsize * xdivision + xMin,
						"High": scene.children[i].position.y / Gridsize * ydivision + yMin,
						"TowerType": "ZMVA41",
						"Base": 0,
						"TowerHigh": scene.children[i].geometry.vertices[7].y / (1 / ydivision * Gridsize),
						"Status": 0,
						"InsulatorLength": 4.5,
						"ConnectLength": 0.0,
						"InsulateP": "",
						"InsulatePA": "X01",
						"InsulatePANum": -1,
						"InsulatePB": "X01",
						"InsulatePBNum": -1,
						"InsulatePC": "",
						"InsulatePCNum": 0,
						"hugeHigh": 0,
						"hugeGround": 0,		// 地线悬挂点高程
						"Lk": 0,
						"L": 0,
						"cosa": 1,
						"bInsular": false,
						"constant": 0,
						"u": 1,
						"kPline": 0,			//导线大号侧k值系数
						"kGround": 0,		//地线大号侧K值系数
						"kWind": 0,			//大风条件前视档k值系数
						"kMaxT": 0,			//70度高温k值系数
						"constMaxT": 0,
						"Lh": 0,				// 水平档距
						"Lh1": 0,			// 小号侧垂直档距
						"Lh2": 0,			// 大号侧垂直档距
						"Lv": 0,				// 垂直档距
						"Lv1": 0,			// 小号侧水平档距
						"Lv2": 0,			// 大号侧水平档距
						"lvMinTemp": 0,//最低气温垂直档距
						"lvMaxTemp": 0,//最高气温垂直档距
						"lvMaxIce": 0,//最大覆冰垂直档距
						"lvMaxWind": 0,//最大风垂直档距
						"displayKType": 0,	//k值类型，0为最大弧垂 1为最高线温
						"displayGround": 0,		//显示地线
						"displayPower": 1,		//显示导线
						"displaySafe": 1,	//显示导线对地
						"displayCross": 1,		//显示导线跨越
						"LandDist": 8.5,		// 对地安全距离
						"ElecDist": 6.0	// 电力线安全距离
					})
				}
			}
			/****修改****/
			currentTow.sort(compare('posX'))
			for (let j = 0; j < currentTow.length; j++) {
				for (let i = 0; i < scene.children.length; i++) {
					if (scene.children[i].uuid == currentTow[j].object.uuid){
						scene.children[i].geometry.name = "G" + j;
					}
				}
			}

			let disToPile = []
			for (let i = 0; i < pile_tabledata.length; i++) {
				disToPile.push({"name": pile_tabledata[i].name,
					"dis":Math.abs(pile_tabledata[i].dist - pos.x/Gridsize*xdivision),
					"value":i
				})
			}
			disToPile.sort(compare("dis"));
			layer.getChildFrame('body',tpIndex).find("#pilelist").val(disToPile[0].value);
			let gap;
			for (let i = 0; i < pile_tabledata.length; i++) {
				if (pile_tabledata[i].name == disToPile[0].name){
					gap = pos.x/Gridsize*xdivision - pile_tabledata[i].dist;
				}
			}
			let gaptoPile2 = layer.getChildFrame('body',tpIndex).find("#gap")[0];
			gaptoPile2.value = gap.toFixed(2);
			var inputHei2 = layer.getChildFrame('body',tpIndex).find("#hei")[0];
			var inputDis2 = layer.getChildFrame('body',tpIndex).find("#dis")[0];

			let disNum = pos.x/Gridsize*xdivision + xMin;
			let heiNum = pos.y/Gridsize*ydivision + yMin;
			inputDis2.value = disNum.toFixed(2);
			inputHei2.value = heiNum.toFixed(2);

			var inputId2 =  layer.getChildFrame('body',tpIndex).find("#towId")[0];
			inputId2.value = "G" + towerlist.length;

			console.log("then",towerlist)
			m_end = towerlist.length - 1;
			/****修改****/
			towerlist.sort(compare('Distance'));
			ComputeHugeHigh();
			/****修改****/
			for (let i = 0; i < towerlist.length; i++) {
				towerlist[i].Name = "G" + i;
			}
			for (let i = m_start; i < m_end; i++) {
				DisplayFawCurve4(towerlist[i],towerlist[i+1], "fixwire");
			}

			towerlist_tabledata=towerlist;
			GridManager.setAjaxData(towerlist_tableId,{"data":towerlist_tabledata});
			GridManager.refreshGrid(towerlist_tableId);
		}
		if (event.button === 2){
			clearTempTow();
			scene.remove(scene.getObjectByName('tower'));
			document.removeEventListener("mousedown",towerInsert);
			document.removeEventListener("mousemove",onMouseMove);
		}
	}
	//移动杆塔
	var liftMouseDown, rightMouseDown;
	var selectObj, lastPosition;
	var lastIntersection, nowIntersection;

		function clearScene(myObjects) {
			// 从scene中删除模型并释放内存
			if (myObjects.length > 0) {
				for (var i = 0; i < myObjects.length; i++) {
					var currObj = myObjects[i]

					// 判断类型
					if (currObj instanceof THREE.Scene) {
						var children = currObj.children
						for (var i = 0; i < children.length; i++) {
							deleteGroup(children[i])
						}
					} else {
						deleteGroup(currObj)
					}
					scene.remove(currObj)
				}
			}

			else {
				scene.remove(myObjects);
				myObjects.geometry.dispose(); // 删除几何体
				myObjects.material.dispose(); // 删除材质
			}
		}

// 删除group，释放内存
		function deleteGroup(group) {
			//console.log(group);
			if (!group) return
			// 删除掉所有的模型组内的mesh
			group.traverse(function (item) {
				if (item instanceof THREE.Mesh) {
					item.geometry.dispose() // 删除几何体
					item.material.dispose() // 删除材质
				}
			})
		}
	function getRay(event) {
		event.preventDefault();
		var mouse = new THREE.Vector2();
		var rayCaster = new THREE.Raycaster();
		mouse.x =  ((event.clientX  - mainCanvas.getBoundingClientRect().left)/ mainCanvas.offsetWidth) * 2 - 1;
		mouse.y = -((event.clientY - mainCanvas.getBoundingClientRect().top)/ mainCanvas.offsetHeight) * 2 + 1;
		rayCaster.setFromCamera(mouse, camera);
		return rayCaster;
	}
	function getIntersectionCoor(event) {
		var plane = new THREE.Plane();
		//通过相机位置生成法向量，该法向量和一个点可以建立一个平面
		plane.setFromNormalAndCoplanarPoint(camera.getWorldDirection(plane.normal), new THREE.Vector3(0, 0, 0));
		var rayCaster = getRay(event);
		var worldPoint = new THREE.Vector3();
		//获得射线和平面相交的世界坐标
		rayCaster.ray.intersectPlane(plane, worldPoint);
		return worldPoint;
	}
	function onDragMouseDown(event) {
		var dragIntersects = getIntersectsObject(event);
		let wireTemp = [];
		//左键点击并且点击的是物体时
		if (event.button === 0 && dragIntersects[0]) {
			selectObj = dragIntersects[0].object;//储存当前点击的对象
			console.log(selectObj)
			liftMouseDown = true;
			lastPosition = selectObj.position;//储存当前物体坐标位置
			lastIntersection = getIntersectionCoor(event);//获取点击时的交点
			document.addEventListener('mousemove', onDragMouseMove);
			/****修改****/
			document.addEventListener('mouseup', onMouseUp);
			/****修改****/
			for (let i = 0; i < scene.children.length; i++) {
				if (scene.children[i].name === "fixwire1"||scene.children[i].name === "fixwire2"||scene.children[i].name === "fixwire3"||scene.children[i].name === "fixwire4") {
					wireTemp.push(scene.children[i]);
				}
			}
			for(let i = 0; i < wireTemp.length; i++){
				scene.remove(wireTemp[i]);
			}
		}
		if(event.button === 2){
			document.body.style.cursor = "default";
			document.removeEventListener("mousedown",onDragMouseDown);
		}
	}
	function onDragMouseMove(event) {
		//左键点击状态下移动，网格跟随鼠标移动
		clearTempTow();
		if (liftMouseDown) {
			nowIntersection = getIntersectionCoor(event);//获得移动后当前的交点
			var offset = new THREE.Vector3();
			var tempLine2Cor = [];
			for (let i = 0; i < m_linegroup.children.length; i++) {
				for(let j=0;j<m_linegroup.children[i].geometry.vertices.length;j++){
					tempLine2Cor.push([m_linegroup.children[i].geometry.vertices[j].x,m_linegroup.children[i].geometry.vertices[j].y]);
				}
			}
			var tempLine2 = turf.lineString(tempLine2Cor);
			var points = new THREE.Vector3(nowIntersection.x, nowIntersection.y + 500, 0);
			var tempLine1 = turf.lineString([[points.x, points.y], [points.x, 0]]);
			var interPoint = turf.lineIntersect(tempLine1, tempLine2);
			points = new THREE.Vector3(nowIntersection.x, interPoint.features[0].geometry.coordinates[1], 0);
			//现在的交点减去之前的交点能够得到一个位移向量，再加上之前的物体坐标，就等于现在的物体坐标
			selectObj.position.copy(offset.subVectors(nowIntersection, lastIntersection).add(lastPosition));
			selectObj.position.y = points.y;
			lastIntersection = nowIntersection;
			lastPosition = offset;
			//
			// let moveInd = 0;
			// for (let i = 0; i < towerlist.length; i++) {
			// 	if (towerlist[i].Name == selectObj.geometry.name){
			// 		towerlist[i].Distance = selectObj.position.x/Gridsize*xdivision +xMin;
			// 		towerlist[i].High = selectObj.y/Gridsize*ydivision + yMin;
			// 		moveInd = i;
			// 	}
			// }
			// console.log(selectObj.position)
			// for (let i = moveInd - 1; i < moveInd + 1; i++) {
			// 	DisplayFawCurve4(towerlist[i],towerlist[i+1], "move_wire");
			// }
			// for (let i = 0; i < scene.children.length; i++) {
			// 	if(scene.children[i].name == "move_wire1"||scene.children[i].name == "move_wire2"||scene.children[i].name == "move_wire3"||scene.children[i].name == "move_wire4"){
			// 		clearScene(scene.children[i])
			// 	}
			// }
		}
	}
	function onMouseUp(event) {
		liftMouseDown = false;
		rightMouseDown = false;
		let dragTower = [];
		towerlist = [];
		// clearTempTow();

		console.log(selectObj)
		console.log(scene.children)
		if(selectObj.name === "fixTower") {
			for (let i = 0; i < scene.children.length; i++) {
				if (scene.children[i].name === "fixTower") {
					dragTower.push(scene.children[i]);
				}
			}
			let currentTow = [];
			for (let i = 0; i < dragTower.length; i++) {
				if (dragTower[i].name === "fixTower") {
					currentTow.push({
						"posX": dragTower[i].position.x,
						"object": dragTower[i]
					});
				}
			}
			currentTow.sort(compare('posX'))
			for (let j = 0; j < currentTow.length; j++) {
				for (let i = 0; i < scene.children.length; i++) {
					if (scene.children[i].uuid === currentTow[j].object.uuid) {
						scene.children[i].geometry.name = "G" + j;
					}
				}
			}
			for (let i = 0; i < dragTower.length; i++) {
				towerlist.push({
					"Name": "G" + i,
					"Distance": dragTower[i].position.x / Gridsize * xdivision + xMin,
					"High": dragTower[i].position.y / Gridsize * ydivision + yMin,
					"TowerType": "ZMVA41",
					"Base": 0,
					"TowerHigh": dragTower[i].geometry.vertices[7].y / (1 / ydivision * Gridsize),
					"Status": 0,
					"InsulatorLength": 4.5,
					"ConnectLength": 0.0,
					"InsulateP": "",
					"InsulatePA": "X01",
					"InsulatePANum": -1,
					"InsulatePB": "X01",
					"InsulatePBNum": -1,
					"InsulatePC": "",
					"InsulatePCNum": 0,
					"hugeHigh": 0,
					"hugeGround": 0,		// 地线悬挂点高程
					"Lk": 0,
					"L": 0,
					"cosa": 1,
					"bInsular": false,
					"constant": 0,
					"u": 1,
					"kPline": 0,			//导线大号侧k值系数
					"kGround": 0,		//地线大号侧K值系数
					"kWind": 0,			//大风条件前视档k值系数
					"kMaxT": 0,			//70度高温k值系数
					"constMaxT": 0,
					"Lh": 0,				// 水平档距
					"Lh1": 0,			// 小号侧垂直档距
					"Lh2": 0,			// 大号侧垂直档距
					"Lv": 0,				// 垂直档距
					"Lv1": 0,			// 小号侧水平档距
					"Lv2": 0,			// 大号侧水平档距
					"lvMinTemp": 0,//最低气温垂直档距
					"lvMaxTemp": 0,//最高气温垂直档距
					"lvMaxIce": 0,//最大覆冰垂直档距
					"lvMaxWind": 0,//最大风垂直档距
					"displayKType": 0,	//k值类型，0为最大弧垂 1为最高线温
					"displayGround": 0,		//显示地线
					"displayPower": 1,		//显示导线
					"displaySafe": 1,	//显示导线对地
					"displayCross": 1,		//显示导线跨越
					"LandDist": 8.5,		// 对地安全距离
					"ElecDist": 6.0	// 电力线安全距离
				})
			}
			towerlist.sort(compare('Distance'));
			m_end = towerlist.length - 1;
			ComputeHugeHigh();
			for (let i = 0; i < towerlist.length; i++) {
				towerlist[i].Name = "G" + i;
			}
			for (let i = m_start; i < m_end; i++) {
				DisplayFawCurve4(towerlist[i], towerlist[i + 1], "fixwire");
			}
			towerlist_tabledata = towerlist;
			GridManager.setAjaxData(towerlist_tableId, {"data": towerlist_tabledata});
			GridManager.refreshGrid(towerlist_tableId);
		}
		document.removeEventListener('mousemove', onDragMouseMove);
		document.removeEventListener('mouseup', onMouseUp);
		/****修改****/
		selectObj = {};
		/****修改****/
	}
	//升高杆塔
	function riseTower(event){
		document.body.style.cursor = "url(./css/rise.ico) 9 9, default";
		if (event.button === 0) {
			var intersectsTower = getIntersectsObject(event);
			console.log(intersectsTower[0]);
			let tempTowerHei = intersectsTower[0].object.renderOrder;
			let deleteWire = [];

			if (tempTowerHei < 45) {
				tempTowerHei += 3;
				scene.remove(intersectsTower[0].object);
			} else return tempTowerHei;

			/****修改****/
			var tempPoints = intersectsTower[0].object.position;
			// var tempLine2Cor = [];
			// for (let i = 0; i < m_linegroup.children.length; i++) {
			// 	for(let j=0;j<m_linegroup.children[i].geometry.vertices.length;j++){
			// 		tempLine2Cor.push([m_linegroup.children[i].geometry.vertices[j].x,m_linegroup.children[i].geometry.vertices[j].y]);
			// 	}
			// }
			// var tempLine2 = turf.lineString(tempLine2Cor);
			// var points = new THREE.Vector3(tempPoints.x, tempPoints.y + 500, 0);
			// var tempLine1 = turf.lineString([[points.x, points.y], [points.x, 0]]);
			// var interPoint = turf.lineIntersect(tempLine1, tempLine2);
			// points = new THREE.Vector3(tempPoints.x, interPoint.features[0].geometry.coordinates[1], 0);
			// createTower(points, inx);

			var towMesh = tower1(tempTowerHei);
			towMesh.position.x = tempPoints.x;
			towMesh.position.y = tempPoints.y;
			/****修改****/
			towMesh.position.z = 0;
			towMesh.name = "fixTower";
			towMesh.geometry.name = intersectsTower[0].object.geometry.name;
			scene.add(towMesh);

			for (let i = 0; i < scene.children.length; i++) {
				if (scene.children[i].name === "fixwire1" || scene.children[i].name === "fixwire2" || scene.children[i].name === "fixwire3" || scene.children[i].name === "fixwire4") {
					deleteWire.push(scene.children[i]);
				}
			}
			console.log(deleteWire)
			for (let i = 0; i < deleteWire.length; i++) {
				scene.remove(deleteWire[i]);
			}

			for (let i = 0; i < towerlist.length; i++) {
				if (towerlist[i].Name == towMesh.geometry.name) {
					towerlist[i].TowerHigh = tempTowerHei
				}
			}

			towerlist.sort(compare('Distance'));
			for (let i = 0; i < towerlist.length; i++) {
				towerlist[i].Name = "G" + i;
			}
			ComputeHugeHigh();
			for (let i = m_start; i < m_end; i++) {
				DisplayFawCurve4(towerlist[i], towerlist[i + 1], "fixwire");
			}
			console.log(towerlist);
			towerlist_tabledata = towerlist;
			console.log(towerlist_tabledata);
			GridManager.setAjaxData(towerlist_tableId, {"data": towerlist_tabledata});
			GridManager.refreshGrid(towerlist_tableId);
		}
		if (event.button === 2){
			document.body.style.cursor = "default";
			document.removeEventListener("mousedown",riseTower);
		}
	}
	//降低杆塔
	function fallTower(event){
			document.body.style.cursor = "url(./css/fall.ico) 9 9, default";
			if (event.button === 0) {
				var intersectsTower = getIntersectsObject(event);
				console.log(intersectsTower[0]);
				let tempTowerHei = intersectsTower[0].object.geometry.vertices[7].y / (1 / ydivision * Gridsize );
				console.log("fallTower",tempTowerHei)
				if (tempTowerHei > 24) {
					tempTowerHei -= 3;
					// intersectsTower[0].object.geometry.vertices[7].y = tempTowerHei * (1 / ydivision * Gridsize )
					scene.remove(intersectsTower[0].object);
				} else return tempTowerHei;
				intersectsTower[0].object.renderOrder = tempTowerHei;
				let deleteWire = [];
				//
				/****修改****/
				var tempPoints = intersectsTower[0].object.position;

				var towMesh = tower1(tempTowerHei);
				towMesh.position.x = tempPoints.x;
				towMesh.position.y = tempPoints.y;
				/****修改****/
				towMesh.position.z = 0;
				towMesh.name = "fixTower";
				towMesh.geometry.name = intersectsTower[0].object.geometry.name;
				scene.add(towMesh);
				// console.log(tempTowerHei)
				// console.log(towMesh.geometry.vertices[7].y / (1 / ydivision * Gridsize ));

				for (let i = 0; i < scene.children.length; i++) {
					if (scene.children[i].name === "fixwire1" || scene.children[i].name === "fixwire2" || scene.children[i].name === "fixwire3" || scene.children[i].name === "fixwire4") {
						deleteWire.push(scene.children[i]);
					}
				}
				for (let i = 0; i < deleteWire.length; i++) {
					scene.remove(deleteWire[i]);
				}

				for (let i = 0; i < towerlist.length; i++) {
					if (towerlist[i].Name === intersectsTower[0].object.geometry.name) {
						towerlist[i].TowerHigh = tempTowerHei;
					}
				}

				towerlist.sort(compare('Distance'));
				for (let i = 0; i < towerlist.length; i++) {
					towerlist[i].Name = "G" + i;
				}
				ComputeHugeHigh();
				console.log(towerlist)
				for (let i = m_start; i < m_end; i++) {
					DisplayFawCurve4(towerlist[i], towerlist[i + 1], "fixwire");
				}

				console.log(towerlist);
				towerlist_tabledata = towerlist;
				console.log(towerlist_tabledata);
				GridManager.setAjaxData(towerlist_tableId, {"data": towerlist_tabledata});
				GridManager.refreshGrid(towerlist_tableId);
			}
			if (event.button === 2){
				document.body.style.cursor = "default";
				document.removeEventListener("mousedown",fallTower);
			}
		}
	//修改杆塔
	function editTower(event){
		if (event.button === 0) {
		var intersectsTower = getIntersectsObject(event);
		$("#towerset").mouseover(function () {
			console.log("鼠标进入")
			document.removeEventListener('mousedown', editTower);
		})
		$("#towerset").mouseout(function () {
			document.addEventListener('mousedown', editTower);
		})
		console.log("editTowerMsg",intersectsTower[0]);
		let name = intersectsTower[0].object.geometry.name;
		console.log("edit_name", name);
		let idInput = layer.getChildFrame('body',tpIndex).find("#towId")[0];;
		idInput.value = name;
		let disInput = layer.getChildFrame('body',tpIndex).find("#dis")[0]
		disInput.value = (intersectsTower[0].object.position.x/Gridsize*xdivision+xMin).toFixed(2);
		let highInput = layer.getChildFrame('body',tpIndex).find("#hei")[0]
		highInput.value = (intersectsTower[0].object.position.y/Gridsize*ydivision + yMin).toFixed(2);

		let TowerHighInput = layer.getChildFrame('body',tpIndex).find("#towerheight")[0];
			for (let i = 0; i < TowerHighInput.length; i++) {
				if (TowerHighInput[i].value === towerHei.toString()){
					TowerHighInput[i].selected = true;
				}
			}
		TowerHighInput.value = Number(intersectsTower[0].object.renderOrder);
		let oldTowerHigh = intersectsTower[0].object.renderOrder;

		let disToPile = []
		for (let i = 0; i < pile_tabledata.length; i++) {
			disToPile.push({
				"name": pile_tabledata[i].name,
				"dis": Math.abs(pile_tabledata[i].dist - intersectsTower[0].object.position.x/Gridsize*xdivision),
				"value": i
			})
		}
		disToPile.sort(compare("dis"));
		layer.getChildFrame('body',tpIndex).find("#pilelist").val(disToPile[0].value);
		let gap;
		for (let i = 0; i < pile_tabledata.length; i++) {
			if (pile_tabledata[i].name == disToPile[0].name) {
				gap = intersectsTower[0].object.position.x/Gridsize*xdivision - pile_tabledata[i].dist;
			}
		}
		let gaptoPile2 = layer.getChildFrame('body',tpIndex).find("#gap")[0];
		gaptoPile2.value = gap.toFixed(2);

		$("#saveBtn").click(function () {
			for (let i = 0; i < towerlist.length; i++) {
				if (towerlist[i].Name == name) {
					towerlist[i].Distance = Number(disInput.value);
					towerlist[i].High = Number(highInput.value);
					towerlist[i].TowerHigh = Number(TowerHighInput.value);
					ComputeHugeHigh();
					if (i > 0 && i < towerlist.length) {
						DisplayFawCurve4(towerlist[i - 1], towerlist[i], "fixwire");
						DisplayFawCurve4(towerlist[i], towerlist[i + 1], "fixwire");
					} else DisplayFawCurve4(towerlist[i], towerlist[i + 1], "fixwire");
				}
			}

			console.log("after edit", towerlist)

			intersectsTower[0].object.position.x = (disInput.value -xMin) / xdivision*Gridsize;
			intersectsTower[0].object.position.y = (highInput.value - yMin)/ ydivision*Gridsize;
			intersectsTower[0].object.scale.set(1, TowerHighInput.value / oldTowerHigh, 1);
		})
		}
		if (event.button === 2){
			document.body.style.cursor = "default";
			document.removeEventListener("mousedown",editTower);
		}
	}

		/*    鼠标缩放移动事件     */
	function onDocumentMouseWheel(event) {
			let factor = 60;
			//从鼠标位置转化为webgl屏幕坐标位置
			let glScreenX = ((event.clientX  - mainCanvas.getBoundingClientRect().left)/ mainCanvas.offsetWidth) * 2 - 1;
			let glScreenY = -((event.clientY - mainCanvas.getBoundingClientRect().top)/ mainCanvas.offsetHeight) * 2 + 1;
			let vector = new THREE.Vector3(glScreenX, glScreenY, 0);
			//从屏幕向量转为3d空间向量
			vector.unproject(camera);
			let target = new THREE.Vector3(0, 0, 0);
			//相机偏移量
			vector.sub(camera.position).setLength(factor);
			if (event.deltaY < 0) {
				camera.position.add(vector);
				target.add(vector);
			} else {
				camera.position.sub( vector);
				target.sub(vector);
			}

			cameraX = camera.position.x;
			cameraY = camera.position.y;
			cameraZ = camera.position.z;

			camera.updateProjectionMatrix();
			renderer.render(scene, camera);
			labelRenderer.render( scene, camera );
		}

	function onDocumentMouseDown(event) {
			if (event.button != 1) return;
			event.preventDefault();
			document.addEventListener('mousemove', onDocumentMouseMove, false);
			document.addEventListener('mouseup', onDocumentMouseUp, false);
		}

	function onDocumentMouseMove(event) {
			var movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
			var movementY = event.movementY || event.mozMovementY || event.webkitMovementY || 0;
			cameraX -= movementX * 0.5;
			sceneX -= movementX * 0.5;
			cameraY += movementY * 0.5;
			sceneY += movementY * 0.5;
			cameraZ = camera.position.z;

			camera.position.set(cameraX, cameraY, cameraZ);
			// camera.lookAt(sceneX, sceneY, sceneZ);
			camera.updateProjectionMatrix();
			renderer.render(scene, camera);
			labelRenderer.render( scene, camera );
		}

	function onDocumentMouseUp(event) {
		document.removeEventListener('mousemove', onDocumentMouseMove);
		document.removeEventListener('mouseup', onDocumentMouseUp);
	}

	let selectedObj = null;
	let selectedPoint = null;

	function onDocumentSelected(event) {
		//var intersect=getIntersects(event);
		//getIntersectsObject()
		// intersect.x,intersect.y+yMin
		//console.log(getIntersectsMapObj);
		event.preventDefault();
		if (selectedObj) {
			console.log("selected");
			console.log(selectedObj);
			if(selectedObj.material.color==selectedObj.parent.children[0].material.color){
				console.log("change color");
				console.log(selectedObj.material);
				console.log(selectedObj.parent.children[1].material);
				selectedObj.material=selectedObj.parent.children[1].material;
			}
			else{
				console.log("change color index 0");
				console.log(selectedObj.material);
				console.log(selectedObj.parent.children[0].material);
				selectedObj.material=selectedObj.parent.children[0].material;
			};

			selectedObj=null;
		}
		for(let i=0;i<scene.children.length;i++){
			if(scene.children[i].name =="redpoint"){
				console.log("name =redpoint");
				scene.remove(scene.children[i]);
			}
		}
		// console.log("clear redpoint");
		// console.log(scene.children);
		if(selectedPoint){
			console.log("change visiual");
			console.log(selectedPoint);
			selectedPoint.visible = false;
			selectedPoint = null;
		}
		const intersects = getIntersectsMapObj(event);

		if(intersects==undefined) return ;
		const coord_inter =getIntersects(event);
		if (intersects.length > 0) {
			const res = intersects.filter(function (res) {
				return res && res.object;
			})[0];
			console.log("res,resobj");
			console.log(res && res.object);
			if (res && res.object) {
				selectedObj = res.object;
				selectedObj.material = new THREE.LineBasicMaterial({color: 0xFF0011});
			}
		}
		//section redpoint caught
		for(let i=0;i<DEM_pgroup.children.length;i++){
			var num = scene.children.length;
			for(let j=0;j<DEM_pgroup.children[i].geometry.vertices.length;j++){
				if(Math.abs(DEM_pgroup.children[i].geometry.vertices[j].x-coord_inter.x)<0.5&&Math.abs(DEM_pgroup.children[i].geometry.vertices[j].y-coord_inter.y)<0.5){
					selectedPoint = DEM_pgroup.children[i];
					selectedPoint.visible =true;
					//create point;
					var red = new THREE.Geometry();
					red.vertices.push(new THREE.Vector3(DEM_pgroup.children[i].geometry.vertices[j].x,DEM_pgroup.children[i].geometry.vertices[j].y,0));
					var redmaterial= new THREE.PointsMaterial({color:0xff0000,size:2.0});
					var redpoint =new THREE.Points(red,redmaterial);
					redpoint.name="redpoint";
					redpoint.userData={"dem":selectedObj.name,"j":j};
					scene.add(redpoint);
					break;
				}

			}

			if(scene.children.length!=num){console.log(scene.children.length);break;}
		}

		//crossObject redPoint caught

		for(let i=0;i<scene.children.length;i++){
			var num = scene.children.length;
			if(scene.children[i].name == "crossObject"){
				var redcross = scene.children[i];
				var target1 =  redcross.children[1].geometry.attributes.position.array;
				var target2 =  redcross.children[2].geometry.attributes.position.array;
				for(let j = 0 ; j< target1.length/3;j=j+1){
					if((Math.abs(target1[3*j]-coord_inter.x)<0.5&&Math.abs(target1[3*j+1]-coord_inter.y)<0.5)||
							(Math.abs(target2[3*j]-coord_inter.x)<0.5&&Math.abs(target2[3*j+1]-coord_inter.y)<0.5)){
						var red = new THREE.Geometry();
						red.vertices.push(new THREE.Vector3(target2[3*j],target2[3*j+1],0));
						red.vertices.push(new THREE.Vector3(target1[3*j],target1[3*j+1],0));
						var redmaterial= new THREE.PointsMaterial({color:0xff0000,size:5.0});
						var redpoint =new THREE.Points(red,redmaterial);
						redpoint.name="redpoint";
						redpoint.userData={"dem":redcross.children[0].name,"j":j}; //output offset y
						scene.add(redpoint);
						break;
					}
				}

			}
		}


	}

	function getIntersectsMapObj(event){

		if(mainCanvas==null) return undefined;
		mouse.x = ((event.clientX  - mainCanvas.getBoundingClientRect().left)/ mainCanvas.offsetWidth) * 2 - 1;
		mouse.y = -((event.clientY - mainCanvas.getBoundingClientRect().top)/ mainCanvas.offsetHeight) * 2 + 1;
		const mouseVector = new THREE.Vector3();
		mouseVector.set(mouse.x,mouse.y,0.5);
		raycaster.setFromCamera(mouseVector,camera);
		// raycaster.intersectObjects(m_linegroup.children,true);
		// raycaster.intersectObjects(r_linegroup.children,true);
		// raycaster.intersectObjects(l_linegroup.children,true);
		var obj = new Array();
		if(raycaster.intersectObjects(m_linegroup.children,true)[0]!=undefined){obj.push(raycaster.intersectObjects(m_linegroup.children,true)[0]);}
		if(raycaster.intersectObjects(l_linegroup.children,true)[0]!=undefined){obj.push(raycaster.intersectObjects(l_linegroup.children,true)[0]);}
		if(raycaster.intersectObjects(r_linegroup.children,true)[0]!=undefined){obj.push(raycaster.intersectObjects(r_linegroup.children,true)[0]);}
		// crossobject can be caught
		// console.log("raycastScene",scene.children);
		// for(let i = 0;i<scene.children.length;i++){
		// 	if(scene.children[i].name == "crossObject"){
		// 		console.log(scene.children[i])
		// 		if(raycaster.intersectObject(scene.children[i].children[1],true)!=[]){
		// 			obj.push(raycaster.intersectObject(scene.children[i].children[1],true));
		// 		}
		// 	}
		// }
		//
		// console.log(obj);
		return obj;
	}

	/* 删除数组指定项 */
	Array.prototype.findindexOf = function(val) {
			for (var i = 0; i < this.length; i++) {
				if (this[i].Name == val) return i;
			}
			return -1;
		};
	Array.prototype.removed = function(val) {
			var index = this.findindexOf(val);
			if (index > -1) {
				this.splice(index, 1);
			}
		};
	/*禁止右键菜单*/
	function blockContextmen(){
		if(window.event){
			window.event.returnValue=false;
		}
	}
	/* 比较排序 */
	function compare(property){
			return function(a,b){
				var value1 = a[property];
				var value2 = b[property];
				return value1 - value2;
			}
		}
	/* 窗口自动适应 */
	function onWindowResize() {
		camera.aspect = canvasdiv.offsetWidth / canvasdiv.offsetHeight;
		camera.updateProjectionMatrix();
		renderer.setSize(canvasdiv.offsetWidth, canvasdiv.offsetHeight);
		labelRenderer.setSize(canvasdiv.offsetWidth, canvasdiv.offsetHeight );
	}
	/*bottom Status bar*/
	function onDocumentMsg(event){
		var coord = getIntersects(event);

		var redpoint;
		if(coord!=undefined) {
			//console.log("x,z",coord.x,coord.y);
			for (let i = 0; i < scene.children.length; i++) {
				if (scene.children[i].name == "redpoint") {
					redpoint = scene.children[i];
					break;
				}
			}
			window.document.getElementById("footermsg").textContent = "		累距：" + (coord.x/Gridsize*xdivision+xMin).toFixed(2) + "	 高程: " + (coord.y/Gridsize*ydivision + yMin).toFixed(2);
			//console.log("userData",redpoint);
			if(redpoint!=undefined){window.document.getElementById("footermsg").textContent = redpoint.userData.dem + "第" + redpoint.userData.j + "点，" +
					"坐标" + (redpoint.geometry.vertices[0].x/Gridsize*xdivision+xMin).toFixed(2) + "," + (redpoint.geometry.vertices[0].y/Gridsize*ydivision+yMin).toFixed(2)+
					"		累距：" + (coord.x/Gridsize*xdivision+xMin).toFixed(2) + "	 高程: " + (coord.y/Gridsize*ydivision + yMin).toFixed(2) +
					"			Δx:	" + ((coord.x - redpoint.geometry.vertices[0].x)/Gridsize*xdivision).toFixed(2) +
					"	Δz:	" + ((coord.y - redpoint.geometry.vertices[0].y)/Gridsize*ydivision).toFixed(2);     // coordination convert
			}
		}
	}
	/*function ablout Cross Object*/
	var GroundVertice = [];
	var pCount = 0;

	window.createGroundObj = function(event){
			if(event.button === 0){
				console.log("left button");
				mouse.x = ((event.clientX  - mainCanvas.getBoundingClientRect().left)/ mainCanvas.offsetWidth) * 2 - 1;
				mouse.y = -((event.clientY - mainCanvas.getBoundingClientRect().top)/ mainCanvas.offsetHeight) * 2 + 1;
				let pos = getIntersects(event);
				GroundVertice.push(pos);
				pCount++;
				console.log(scene.children[scene.children.length-1]);
				scene.children[scene.children.length-1].children[0].geometry.attributes.position.needsUpdate = true;
				scene.children[scene.children.length-1].children[0].geometry.setFromPoints(GroundVertice);
				scene.children[scene.children.length-1].children[0].geometry.setDrawRange(0, pCount);
				scene.children[scene.children.length-1].children[0].geometry.computeBoundingSphere();    //children Line ;


				//console.log(GroundVertice);
				console.log("pCount",scene,pCount);
				renderer.render(scene,camera);
			}
			if(event.button ===2){
				console.log("right button");

				scene.children[scene.children.length-1].children[0].geometry.setDrawRange(0, pCount);
				scene.children[scene.children.length-1].children[0].geometry.computeBoundingSphere();
				document.removeEventListener('mousemove',window.trackGroundObj);
				document.removeEventListener('mousedown',window.createGroundObj);
				//弹出框选择跨越
				if(pCount>1) {  //pCount无法产生实体
					layer.open({
						type:2,
						title:'选择地物类别',
						area:['250px','400px'],
						maxmin:true,
						content:'./CrossTower.html',
						//shade:0,

						success:function (layero,index) {
							console.log(layero,index);
							var body = layer.getChildFrame('body',index);
							console.log(body);
						}
					})
				}
			}
		}

	window.trackGroundObj = function(event) {
			mouse.x = ((event.clientX - mainCanvas.getBoundingClientRect().left) / mainCanvas.offsetWidth) * 2 - 1;
			mouse.y = -((event.clientY - mainCanvas.getBoundingClientRect().top) / mainCanvas.offsetHeight) * 2 + 1;
			let pos = getIntersects(event);
			if(pCount!=0){
				GroundVertice[pCount]=pos ;
			}
			scene.children[scene.children.length-1].children[0].geometry.attributes.position.needsUpdate = true;
			scene.children[scene.children.length-1].children[0].geometry.setFromPoints(GroundVertice);
			scene.children[scene.children.length-1].children[0].geometry.setDrawRange(0, pCount+1);

			renderer.render(scene,camera);
		}

	window.createGroundCross = function (crossPoint,crossAttrName){
		var Cross_geo = new THREE.BufferGeometry().setFromPoints( crossPoint );
		var Cross_geop = new THREE.BufferGeometry().setFromPoints( crossPoint );
		var Cross_geosp = new THREE.BufferGeometry();
		var Cross_mat = new THREE.LineBasicMaterial( { color: 0x0000ff } );
		var Cross_matp = new THREE.PointsMaterial( { color: 0x888888,size:5 } );
		var Cross_line = new THREE.Line(Cross_geo,Cross_mat);
		var Cross_Point = new THREE.Points(Cross_geop,Cross_matp);
		var Section_Point = new THREE.Points(Cross_geosp,Cross_matp);
		Cross_line.name = crossAttrName;
		let GroundGroup = new THREE.Group();
		GroundGroup.name = "crossObject"
		GroundGroup.add(Cross_line);
		GroundGroup.add(Cross_Point)
		GroundGroup.add(Section_Point);
		scene.add(GroundGroup);
	}

	window.createCrossLabel = function (towerhigh,codeId,added){
		console.log("label categories",codeId,towerhigh);
		var ray = new THREE.Raycaster();
		ray.set(new THREE.Vector3(-10,mp.m_Frame[7]-mp.m_Frame[14],0),new THREE.Vector3(1,0,0));   //-90 need to be set as mp.m_Frame[]
		ray.params = {
			Mesh: {},
			Line: { threshold: 1 },
			LOD: {},
			Points: { threshold: 0.1 },
			Sprite: {}
		};
		var renewp = [];  var secp=[];
		var target = ray.intersectObject(scene.children[scene.children.length-1].children[0]);   // children[0] line   children[1] points  children[2] section p

		console.log("crossover",ray,target);
		// caculateDem intersect points and generate obj add to scene
		for(let i=0 ;i<target.length;i++){
			var sectionRay = new THREE.Raycaster();
			sectionRay.set(target[i].point,new THREE.Vector3(0,1,0));
			console.log(sectionRay);
			console.log(m_linegroup);
			var m_linetarget = sectionRay.intersectObject(m_linegroup,true);
			for(let j=0;j<m_linetarget.length;j++){
				if(Math.abs(m_linetarget[j].point.x- target[i].point.x)<0.001){
				const material = new THREE.LineBasicMaterial( { color: 0x0000ff } );
				const points = [];
				points.push( target[i].point );
				points.push( m_linetarget[j].point );


				const geometry = new THREE.BufferGeometry().setFromPoints( points );
				const line = new THREE.Line( geometry, material );
				const pline2 = []; pline2.push(m_linetarget[j].point);
				pline2.push(new THREE.Vector3(m_linetarget[j].point.x,
						m_linetarget[j].point.y+towerhigh/ydivision*Gridsize,
						m_linetarget[j].point.z));

				const line2 = new THREE.Line(new THREE.BufferGeometry().setFromPoints(pline2),
					new THREE.LineDashedMaterial( {
					color: 0x00ff00,
					linewidth: 1,
					scale: 1,
					dashSize: 3,
					gapSize: 1,
				} ));     //跨越杆高 towerHigh 虚线
					line2.computeLineDistances();  //for DashedMaterial
					line2.name =  codeId;
				let high = m_linetarget[j].point.y/20*ydivision+yMin+towerhigh;
				let sumD = ((target[i].point.x/20) - parseInt((target[i].point.x/20)))*xdivision;
				var cross_notehigh = createSprite(high.toFixed(2),"#000000",10,20,target[i].point.x+5,mp.m_Frame[13]-mp.m_Frame[14],Math.PI/2);
				var cross_notesumD = createSprite(sumD.toFixed(0),"#000000",20,20,target[i].point.x+5,mp.m_Frame[11]-mp.m_Frame[14]+10,Math.PI/2);
				var cross_note = createSprite(target[i].object.name,"#000000",10,20,target[i].point.x+5,mp.m_Frame[12]-mp.m_Frame[14],Math.PI/2);
				scene.children[scene.children.length-1].add(cross_note);
				scene.children[scene.children.length-1].add(cross_notehigh);
				scene.children[scene.children.length-1].add(cross_notesumD);
				scene.children[scene.children.length-1].add(line);
				scene.children[scene.children.length-1].add(line2);
				}
			}
		}

		//add intersect point and sectionPoint  (Update pointset)
		console.log("labelPointprocess",GroundVertice);
		//draw Range point Vector get
		if(!added){    //draw or file open  mode:open GroundVertice empty and need to added line points
			let lineArray =scene.children[scene.children.length-1].children[0].geometry.attributes.position.array;
			scene.children[scene.children.length-1].children[0].geometry.setDrawRange(0, lineArray.length/3);
			for(let i = 0;i<lineArray.length/3;i++){
				let temp = new THREE.Vector3(lineArray[i*3],lineArray[i*3+1],lineArray[i*3+2]);
				renewp.push(temp);
			}
		}
		else {
			renewp = GroundVertice;
			renewp.pop();
		}
		for(let i = 0 ;i<target.length;i++){
			renewp.push(target[i].point);
		}
		//renewp sort
		renewp.sort(compare('x'));
		console.log(renewp);
		scene.children[scene.children.length-1].children[1].geometry.attributes.position.needsUpdate = true;
		scene.children[scene.children.length-1].children[1].geometry.setFromPoints(renewp);
		scene.children[scene.children.length-1].children[1].geometry.setDrawRange(0, renewp.length);
		scene.children[scene.children.length-1].children[1].geometry.computeBoundingSphere();    //group point;

		for(let i = 0 ;i<renewp.length;i++){
			var sectionRay = new THREE.Raycaster();
			sectionRay.set(renewp[i],new THREE.Vector3(0,1,0));
			var secp_target = sectionRay.intersectObject(m_linegroup,true);
			for(let j=0;j<secp_target.length;j++){
				if(Math.abs(secp_target[j].point.x- renewp[i].x)<0.0001) {
					secp.push(new THREE.Vector3(secp_target[j].point.x,
							secp_target[j].point.y+towerhigh/ydivision*Gridsize,
							secp_target[j].point.z));
				}
			}
		}
		//scene.children[scene.children.length-1].children[2].geometry.attributes.position.needsUpdate = true;
		scene.children[scene.children.length-1].children[2].geometry.setFromPoints(secp);
		scene.children[scene.children.length-1].children[2].geometry.setDrawRange(0, secp.length);
		scene.children[scene.children.length-1].children[2].geometry.computeBoundingSphere();    //section point;


		//add to crosspoint to the Cross array
		if(added) {
			let addCrossObj = scene.children[scene.children.length - 1];
			let CrossCount = addCrossObj.children[2].geometry.drawRange.count;
			let PointArray = addCrossObj.children[2].geometry.attributes.position.array;
			let ProjPointArray = addCrossObj.children[1].geometry.attributes.position.array;
			console.log("PointArray", PointArray);
			let CrossPoint = [];

			for (let i = 0; i < CrossCount; i++) {   //proj y=0  dc
				let temp = {
					"x": 0,
					"y": 0,
					"z": 0,
					"dc": 0,
					"towerHigh": 0
				};
				temp.x = PointArray[3 * i] / Gridsize * xdivision + xMin;
				temp.y = (ProjPointArray[3 * i + 1] - (mp.m_Frame[7] - mp.m_Frame[14])) / Gridsize * xdivision;
				temp.z = PointArray[3 * i + 1] / Gridsize * ydivision + yMin;
				if (temp.y == 0) {
					temp.dc = codeId;
				}
				temp.towerHigh = towerhigh;
				CrossPoint.push(temp);
			}
			console.log("addCrossObj", addCrossObj);
			let addCross = {
				"Attr": Number(addCrossObj.children[0].name.substring(1, 4)),
				"AttrEx": 0,
				"AttrName": addCrossObj.children[0].name,
				"PointCount": CrossCount,
				"CrossPoint": CrossPoint
			}
			cross.push(addCross);
			console.log("addedCross", cross);
			renderer.render(scene, camera);
			GroundVertice = [];
			pCount = 0;
		}
	}

	window.MapCrossDraw = function(cross,added){
		console.log("CrossObject");
		//delete original
		for(let i = 0 ;i<scene.children.length;i++){
			if(scene.children[i].name == "crossObject"){scene.remove(scene.children[i]);i=i-1;console.log(scene.children[i]);}
		}

		console.log("afterdeleteCrossObject",scene);
		for(let i=0;i<cross.length;i++){
			console.log("cross drawing length",cross.length);
			let crossPoint = [];
			let crossAttrName;
			for(let j=0;j<cross[i].PointCount;j++){
				var temp = new THREE.Vector3();
				temp.x= (cross[i].CrossPoint[j].x-xMin)/xdivision*Gridsize;
				temp.y= cross[i].CrossPoint[j].y/xdivision*Gridsize+mp.m_Frame[7]-mp.m_Frame[14];
				temp.z= 0
				crossPoint.push(temp);
			}
			crossAttrName = cross[i].AttrName;
			console.log(crossPoint,crossAttrName);
			createGroundCross(crossPoint,crossAttrName);
			//GroundVertice = crossPoint;
			let towerhigh=0;
			let codeId=0;
			for(let ii = 0;ii < cross[i].CrossPoint.length ;ii++){
				if(cross[i].CrossPoint[ii].dc>2000) {codeId = cross[i].CrossPoint[ii].dc;};
				if(cross[i].CrossPoint[ii].towerHigh>0){towerhigh = cross[i].CrossPoint[ii].towerHigh;};
			}
			createCrossLabel(towerhigh,codeId,added);
		}

	}

	window.bindTowerPlace = function(title){
		if(title != $(".layui-layer-title").text()){
			layer.close(tpIndex);
			layer.open({
				type:2,
				title: title,
				area:['250px','300px'],
				offset: ['200px', '200px'],
				maxmin:true,
				shadeClose:false,
				shade:0,
				content:'./TowerPlace.html',
				//id: title,
				success:function (layero,index) {
					var body = layer.getChildFrame('body',index);
					//mark the page
					tpIndex = index;
					//bind towId
					body.find("#towId")[0].value = "G"+towerlist.length;
					console.log("insert tlength ",body.find("#towId")[0].value,towerlist.length);
					//bind select option setting
					for (let i = 0; i < pile_tabledata.length; i++) {
						body.find("#pilelist").append("<option value='"+i+"'>"+pile_tabledata[i].name+"</option>");
					}
					// tower high option bind don't need to set fixed
					var towerHigh = body.find("#towerheight option:selected")[0].value;
					console.log(towerHigh)

					towerHei = parseInt(towerHigh); // 234;
					console.log(towerHei);
				}
			})
		}

	}
	//sinh arcsh函数
	function sinh(x) {
			let a = (Math.exp(x) - Math.exp(-x))/2;
			return a;
		}
	function arcsh(x) {
			let a = Math.log(x + Math.sqrt(x * x +1));
			return a;
		}
	//求最近值
	function limit(arr, num){
		var newArr = [];
		arr.map(function(x){
			// 对数组各个数值求差值
			newArr.push(Math.abs(x - num));
		});
		// 求最小值的索引
		var index = newArr.indexOf(Math.min.apply(null, newArr));
		return arr[index];
	}
	/* 初始化 */
	function init() {
		initScene();
		initCamera();
		initRender();
		initLight();
		/* 事件监听 */
		document.addEventListener('mousewheel', onDocumentMouseWheel, false);//兼容ie chrome
		document.addEventListener('DOMMouseScroll', onDocumentMouseWheel, false);//兼容火狐
		document.addEventListener('mousedown', onDocumentMouseDown, false);
		document.addEventListener('mousedown', onDocumentSelected, false);
		document.addEventListener('mousemove', onDocumentMsg, false);

		drawGeo(pile_tabledata);

		/*鼠标放置杆塔*/
		$("#putTower").click(function () {
			bindTowerPlace('前进方向排杆');
			document.body.style.cursor = "default";
			clearTempTow();
			document.removeEventListener('mousedown', towerDelete);
			document.removeEventListener('mousedown', riseTower);
			document.removeEventListener('mousedown', fallTower);
			document.removeEventListener('mousedown', towerInsert);
			document.removeEventListener('mousedown', editTower);
			document.removeEventListener('mousedown', onDragMouseDown);
			document.removeEventListener('mousemove', onDragMouseMove);
			document.removeEventListener('mouseup', onMouseUp);
			document.addEventListener('mousedown', onMouseDown, false);
			document.addEventListener('mousemove', onMouseMove, false);
		})
		/*鼠标删除杆塔*/
		$("#deleteTower").click(function () {
			clearTempTow();
			document.removeEventListener('mousedown', onMouseDown);
			document.removeEventListener('mousedown', riseTower);
			document.removeEventListener('mousedown', fallTower);
			document.removeEventListener('mousedown', towerInsert);
			document.removeEventListener('mousedown', editTower);
			document.removeEventListener('mousedown', onDragMouseDown);
			document.removeEventListener('mousemove', onDragMouseMove);
			document.removeEventListener('mouseup', onMouseUp);
			document.removeEventListener('mousemove', onMouseMove);
			document.body.style.cursor = "url(./css/cancel.ico) 9 9, default";
			document.addEventListener("mousedown",towerDelete,false);
		})
		/*鼠标插入杆塔*/
		$("#insertTower").click(function () {
			bindTowerPlace('插入杆塔');
			document.body.style.cursor = "default";
			clearTempTow();
			document.removeEventListener('mousedown', onMouseDown);
			document.removeEventListener('mousedown', riseTower);
			document.removeEventListener('mousedown', towerDelete);
			document.removeEventListener('mousedown', fallTower);
			document.removeEventListener('mousedown', editTower);
			document.removeEventListener('mousedown', onDragMouseDown);
			document.removeEventListener('mousemove', onDragMouseMove);
			document.removeEventListener('mouseup', onMouseUp);
			document.addEventListener("mousedown",towerInsert,false);
			document.addEventListener('mousemove', onMouseMove, false);
		})
		/* 鼠标移动杆塔 */
		$("#moveTower").click(function () {
			document.body.style.cursor = "crosshair";
			clearTempTow();
			document.removeEventListener('mousedown', towerDelete);
			document.removeEventListener('mousedown', onMouseDown);
			document.removeEventListener('mouseup', onDocumentMouseUp);
			document.removeEventListener('mousedown', towerInsert);
			document.removeEventListener('mousedown', riseTower);
			document.removeEventListener('mousedown', fallTower);
			document.removeEventListener('mousedown', towerInsert);
			document.removeEventListener('mousedown', editTower);
			document.removeEventListener('mousemove', onDocumentMouseMove);
			document.removeEventListener('mousemove', onMouseMove);
			document.addEventListener("mousedown",onDragMouseDown,false);
			document.addEventListener('mouseup', onMouseUp,false);
		})
		/*鼠标升高杆塔*/
		$("#riseTower").click(function(){
			clearTempTow();
			document.removeEventListener('mousedown', onMouseDown);
			document.removeEventListener('mousedown', towerDelete);
			document.removeEventListener('mousedown', fallTower);
			document.removeEventListener('mousedown', towerInsert);
			document.removeEventListener('mousedown', editTower);
			document.removeEventListener('mousedown', onDragMouseDown);
			document.removeEventListener('mousemove', onDragMouseMove);
			document.removeEventListener('mouseup', onMouseUp);
			document.removeEventListener('mousemove', onMouseMove);
			document.body.style.cursor = "url(./css/rise.ico) 9 9, default";
			document.addEventListener("mousedown",riseTower,false);
		})
		/*鼠标降低杆塔*/
		$("#fallTower").click(function(){
			clearTempTow();
			document.removeEventListener('mousedown', onMouseDown);
			document.removeEventListener('mousedown', towerDelete);
			document.removeEventListener('mousedown', riseTower);
			document.removeEventListener('mousedown', towerInsert);
			document.removeEventListener('mousedown', editTower);
			document.removeEventListener('mousedown', onDragMouseDown);
			document.removeEventListener('mousemove', onDragMouseMove);
			document.removeEventListener('mouseup', onMouseUp);
			document.removeEventListener('mousemove', onMouseMove);
			document.body.style.cursor = "url(./css/fall.ico) 9 9, default";
			document.addEventListener("mousedown",fallTower,false);
		})
		/*修改杆塔*/
		$("#editTower").click(function () {
			bindTowerPlace('修改杆塔信息');
			document.body.style.cursor = "default";
			clearTempTow();
			document.removeEventListener('mousedown', onMouseDown);
			document.removeEventListener('mousedown', riseTower);
			document.removeEventListener('mousedown', towerDelete);
			document.removeEventListener('mousedown', fallTower);
			document.removeEventListener('mousedown', towerInsert);
			document.removeEventListener('mousedown', onDragMouseDown);
			document.removeEventListener('mousemove', onDragMouseMove);
			document.removeEventListener('mouseup', onMouseUp);
			document.addEventListener("mousedown",editTower,false);
		})



		window.selectAttr = function(groundobj){  // create ground object and begin mouseEventListener

			//if last Cross_line is empty delete

			var lastLine = scene.children[scene.children.length-1].children[0];
			console.log("lastline",lastLine);
			console.log(scene.children);
			if(lastLine!=undefined&&scene.children[scene.children.length-1].name=="crossObject"){
				if(lastLine.type==="Line"&&(lastLine.geometry.drawRange.count<2||lastLine.geometry.drawRange.count==Infinity)){
					console.log("removeGroup");
					scene.remove(scene.children[scene.children.length-1]);
				}
			}

			createGroundCross(GroundVertice,groundobj.name);

			//add Listener
			document.addEventListener('mousedown', window.createGroundObj, false);
			document.addEventListener('mousemove', window.trackGroundObj, false);

			// create CrossObjGroup  store the information about the Cross_line; ?

			console.log("select add",scene.children);
			renderer.render( scene, camera );
		}


		window.addEventListener('resize', onWindowResize, false);


		document.oncontextmenu=blockContextmen;//关闭右键默认菜单
	}

	/* 循环调用 */
	function animate() {
		requestAnimationFrame(animate);
		renderer.render(scene, camera);
		labelRenderer.render( scene, camera );

	}
	/* 初始加载 */
	(function () {
		init();
		animate();
	})();

	}
</script>